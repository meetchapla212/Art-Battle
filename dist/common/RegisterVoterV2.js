"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RegisterVoterV2 = void 0;
const logger_1 = require("../config/logger");
const Twilio = require("twilio");
const Registration_1 = require("../models/Registration");
const EventPhoneNumber_1 = require("../models/EventPhoneNumber");
const google_libphonenumber_1 = require("google-libphonenumber");
const jsonwebtoken_1 = require("jsonwebtoken");
const Slack_1 = require("./Slack");
const uniqueId = require('uniqid');
const phoneUtil = google_libphonenumber_1.PhoneNumberUtil.getInstance();
class RegisterVoterV2 {
    constructor(phoneNumber, userAgentHeader, cacheSet, cacheGet, registration, VerifyOTP) {
        this.PhoneNumber = phoneNumber;
        if (userAgentHeader.indexOf('Battle') > -1) {
            this.iOS = true;
        }
        else if (userAgentHeader.indexOf('okhttp') > -1) {
            this.android = true;
        }
        else {
            this.web = true;
        }
        this.Registration = registration;
        this.cacheGet = cacheGet;
        this.cacheSet = cacheSet;
        this.VerifyOTP = VerifyOTP;
    }
    async Login() {
        if (!this.Registration) {
            throw 'Registration Object is required for login';
        }
        let parsedNumber;
        try {
            parsedNumber = phoneUtil.parse(this.Registration.PhoneNumber);
        }
        catch (e) {
            logger_1.default.error(`Invalid login number ${this.Registration && JSON.stringify(this.Registration, null, 1)} ${e}`);
        }
        if (!parsedNumber) {
            throw {
                message: 'Invalid Phone Number'
            };
        }
        this.ClientRegionCode = phoneUtil.getRegionCodeForNumber(parsedNumber);
        this.OtpCacheKey = `otp-${this.Registration._id}`;
        await this.SendVerificationCode();
        return this.Registration;
    }
    async Register() {
        let parsedNumber;
        try {
            parsedNumber = phoneUtil.parse(this.PhoneNumber);
        }
        catch (e) {
            logger_1.default.error(`Invalid registration number ${this.Registration && JSON.stringify(this.Registration, null, 1)} ${e}`);
        }
        if (!parsedNumber) {
            throw {
                status: 400,
                message: 'Invalid Phone Number'
            };
        }
        const registrationModel = new Registration_1.default({
            PhoneNumber: this.PhoneNumber,
            lastPromoSentAt: new Date(2014),
            DisplayPhone: `*******${this.PhoneNumber.slice(-4)}`,
            DeviceTokens: [],
            AndroidDeviceTokens: [],
            Hash: uniqueId.time(),
            SelfRegistered: true,
            RegionCode: phoneUtil.getRegionCodeForNumber(parsedNumber),
            IsArtist: false
        });
        const savedRegistration = await registrationModel.save();
        this.Registration = registrationModel;
        this.ClientRegionCode = registrationModel.RegionCode;
        if (this.VerifyOTP) {
            this.OtpCacheKey = `otp-${this.Registration._id}`;
            await this.SendVerificationCode();
        }
        return savedRegistration;
    }
    async SendVerificationCode() {
        const obj = {
            VerificationCode: `${Math.floor(1000 + Math.random() * 9000)}`,
            VerificationCodeExp: new Date(new Date().getTime() + 15 * 60 * 1000).getTime()
        };
        await this.cacheSet(this.OtpCacheKey, JSON.stringify(obj));
        logger_1.default.info(`sending otp sms(RegisterVoterV2) ${obj.VerificationCode}`);
        let body = `Please use ${obj.VerificationCode} to login`;
        if (this.android) {
            body = `<#> ${body} YOIpYCJPwnV`;
        }
        const serverNo = await this.findAppropriateServerNumber();
        const twilioClient = Twilio();
        try {
            const twilioRes = await twilioClient.messages.create({
                from: serverNo,
                to: this.Registration.PhoneNumber,
                body: body,
            });
            Slack_1.postToSlackSMSFlood({
                'text': `${this.Registration.NickName}(${this.Registration.PhoneNumber}) (sms) \n${body.replace(obj.VerificationCode, '****')}  source: RegisterVoteV2.SendVerificationCode`
            }).catch(() => logger_1.default.error(`verification code slack flood call failed ${body} source: RegisterVoteV2.SendVerificationCode`));
            logger_1.default.info(`sent otp sms(RegisterVoterV2) ${obj.VerificationCode}, ${twilioRes && twilioRes.sid}
                to ${this.Registration.PhoneNumber}, server ${serverNo}`);
        }
        catch (e) {
            if ((typeof e === 'string' && e.indexOf('blacklist rule') > -1)
                || (typeof e.message === 'string' && e.message.indexOf('blacklist rule') > -1)) {
                e = `Please send START to ${serverNo} then register again.`;
            }
            throw e;
        }
    }
    async findAppropriateServerNumber() {
        const promises = [
            EventPhoneNumber_1.default.findOne({
                'RegionCode': this.ClientRegionCode,
                'type': 'vote'
            }),
            EventPhoneNumber_1.default.findOne({
                'RegionCode': 'US',
                'type': 'vote'
            })
        ];
        const results = await Promise.all(promises);
        if (results[0]) {
            return results[0].phone;
        }
        else {
            logger_1.default.info(`user region code not found ${this.ClientRegionCode} using US number`);
            return results[1].phone;
        }
    }
    async VerifyCode(verificationCode) {
        this.OtpCacheKey = `otp-${this.Registration._id}`;
        const otpStr = await this.cacheGet(this.OtpCacheKey);
        if (otpStr) {
            const otpObj = JSON.parse(otpStr);
            if (otpObj.VerficationCodeExp < new Date().getTime()) {
                return -1;
            }
            else if (otpObj.VerificationCode === verificationCode) {
                return 1;
            }
            else {
                return 0;
            }
        }
        else {
            return 0;
        }
    }
    GetToken() {
        return jsonwebtoken_1.sign({
            registrationId: this.Registration._id,
        }, process.env.JWT_SECRET, { expiresIn: process.env.JWT_EXP_TIME || '1y' });
    }
}
exports.RegisterVoterV2 = RegisterVoterV2;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RUQsS0FBSyxDQUFDLFVBQVUsQ0FBQyxnQkFBd0I7UUFDckMsSUFBSSxDQUFDLFdBQVcsR0FBRyxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDbEQsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNyRCxJQUFJLE1BQU0sRUFBRTtZQUNSLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbEMsSUFBSSxNQUFNLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDbEQsT0FBTyxDQUFDLENBQUMsQ0FBQzthQUNiO2lCQUFNLElBQUksTUFBTSxDQUFDLGdCQUFnQixLQUFLLGdCQUFnQixFQUFFO2dCQUNyRCxPQUFPLENBQUMsQ0FBQzthQUNaO2lCQUFNO2dCQUNILE9BQU8sQ0FBQyxDQUFDO2FBQ1o7U0FDSjthQUFNO1lBQ0gsT0FBTyxDQUFDLENBQUM7U0FDWjtJQUNMLENBQUM7SUFFRCxRQUFRO1FBQ0osT0FBTyxtQkFBSSxDQUFDO1lBQ1IsY0FBYyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRztTQUN4QyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFHLEVBQUUsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLElBQUksRUFBQyxDQUFDLENBQUM7SUFDaEYsQ0FBQztDQUNKO0FBbktELDBDQW1LQyIsImZpbGUiOiJjb21tb24vUmVnaXN0ZXJWb3RlclYyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlZ2lzdHJhdGlvbkRUTyBmcm9tICcuLi8uLi8uLi9zaGFyZWQvUmVnaXN0cmF0aW9uRFRPJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vY29uZmlnL2xvZ2dlcic7XG5pbXBvcnQgKiBhcyBUd2lsaW8gZnJvbSAndHdpbGlvJztcbmltcG9ydCBSZWdpc3RyYXRpb25Nb2RlbCwgeyBSZWdpc3RyYXRpb25Eb2N1bWVudCB9IGZyb20gJy4uL21vZGVscy9SZWdpc3RyYXRpb24nO1xuaW1wb3J0IEV2ZW50UGhvbmVOdW1iZXJNb2RlbCBmcm9tICcuLi9tb2RlbHMvRXZlbnRQaG9uZU51bWJlcic7XG5pbXBvcnQgeyBQaG9uZU51bWJlclV0aWwgfSBmcm9tICdnb29nbGUtbGlicGhvbmVudW1iZXInO1xuaW1wb3J0IHsgc2lnbiB9IGZyb20gJ2pzb253ZWJ0b2tlbic7XG5pbXBvcnQgeyBwb3N0VG9TbGFja1NNU0Zsb29kIH0gZnJvbSAnLi9TbGFjayc7XG5jb25zdCB1bmlxdWVJZCA9IHJlcXVpcmUoJ3VuaXFpZCcpO1xuY29uc3QgcGhvbmVVdGlsID0gUGhvbmVOdW1iZXJVdGlsLmdldEluc3RhbmNlKCk7XG5cbmV4cG9ydCBjbGFzcyBSZWdpc3RlclZvdGVyVjIge1xuICAgIHB1YmxpYyBQaG9uZU51bWJlcjogc3RyaW5nO1xuICAgIHB1YmxpYyBpT1M6IGJvb2xlYW47XG4gICAgcHVibGljIGFuZHJvaWQ6IGJvb2xlYW47XG4gICAgcHVibGljIHdlYjogYm9vbGVhbjtcbiAgICBwdWJsaWMgUmVnaXN0cmF0aW9uOiBSZWdpc3RyYXRpb25EVE87XG4gICAgcHVibGljIGNhY2hlU2V0OiBhbnk7XG4gICAgcHVibGljIGNhY2hlR2V0OiBhbnk7XG4gICAgcHVibGljIFZlcmlmaWNhdGlvbkNvZGU6IHN0cmluZztcbiAgICBwdWJsaWMgT3RwQ2FjaGVLZXk6IHN0cmluZztcbiAgICBwdWJsaWMgQ2xpZW50UmVnaW9uQ29kZTogc3RyaW5nO1xuICAgIHB1YmxpYyBWZXJpZnlPVFA6IGJvb2xlYW47XG5cbiAgICBjb25zdHJ1Y3RvciAocGhvbmVOdW1iZXI6IHN0cmluZywgdXNlckFnZW50SGVhZGVyOiBzdHJpbmcsIGNhY2hlU2V0PzogYW55LCBjYWNoZUdldD86IGFueSxcbiAgICAgICAgICAgICAgICAgcmVnaXN0cmF0aW9uPzogUmVnaXN0cmF0aW9uRFRPLCBWZXJpZnlPVFA/OiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuUGhvbmVOdW1iZXIgPSBwaG9uZU51bWJlcjtcbiAgICAgICAgaWYgKHVzZXJBZ2VudEhlYWRlci5pbmRleE9mKCdCYXR0bGUnKSA+IC0xKSB7XG4gICAgICAgICAgICB0aGlzLmlPUyA9IHRydWU7XG4gICAgICAgIH0gZWxzZSBpZiAodXNlckFnZW50SGVhZGVyLmluZGV4T2YoJ29raHR0cCcpID4gLTEpIHtcbiAgICAgICAgICAgIHRoaXMuYW5kcm9pZCA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLndlYiA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5SZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb247XG4gICAgICAgIHRoaXMuY2FjaGVHZXQgPSBjYWNoZUdldDtcbiAgICAgICAgdGhpcy5jYWNoZVNldCA9IGNhY2hlU2V0O1xuICAgICAgICB0aGlzLlZlcmlmeU9UUCA9IFZlcmlmeU9UUDtcbiAgICB9XG5cbiAgICBhc3luYyBMb2dpbigpOiBQcm9taXNlPFJlZ2lzdHJhdGlvbkRUTz4ge1xuICAgICAgICBpZiAoIXRoaXMuUmVnaXN0cmF0aW9uKSB7XG4gICAgICAgICAgICB0aHJvdyAnUmVnaXN0cmF0aW9uIE9iamVjdCBpcyByZXF1aXJlZCBmb3IgbG9naW4nO1xuICAgICAgICB9XG4gICAgICAgIGxldCBwYXJzZWROdW1iZXI7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBwYXJzZWROdW1iZXIgPSBwaG9uZVV0aWwucGFyc2UodGhpcy5SZWdpc3RyYXRpb24uUGhvbmVOdW1iZXIpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoYEludmFsaWQgbG9naW4gbnVtYmVyICR7dGhpcy5SZWdpc3RyYXRpb24gJiYgSlNPTi5zdHJpbmdpZnkodGhpcy5SZWdpc3RyYXRpb24sIG51bGwsIDEpfSAke2V9YCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFwYXJzZWROdW1iZXIpIHtcbiAgICAgICAgICAgIHRocm93IHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBQaG9uZSBOdW1iZXInXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuQ2xpZW50UmVnaW9uQ29kZSA9IHBob25lVXRpbC5nZXRSZWdpb25Db2RlRm9yTnVtYmVyKHBhcnNlZE51bWJlcik7XG5cblxuICAgICAgICB0aGlzLk90cENhY2hlS2V5ID0gYG90cC0ke3RoaXMuUmVnaXN0cmF0aW9uLl9pZH1gO1xuICAgICAgICBhd2FpdCB0aGlzLlNlbmRWZXJpZmljYXRpb25Db2RlKCk7XG4gICAgICAgIHJldHVybiB0aGlzLlJlZ2lzdHJhdGlvbjtcbiAgICB9XG5cbiAgICBhc3luYyBSZWdpc3RlcigpOiBQcm9taXNlPFJlZ2lzdHJhdGlvbkRvY3VtZW50PiB7XG4gICAgICAgIGxldCBwYXJzZWROdW1iZXI7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBwYXJzZWROdW1iZXIgPSBwaG9uZVV0aWwucGFyc2UodGhpcy5QaG9uZU51bWJlcik7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihgSW52YWxpZCByZWdpc3RyYXRpb24gbnVtYmVyICR7dGhpcy5SZWdpc3RyYXRpb24gJiYgSlNPTi5zdHJpbmdpZnkodGhpcy5SZWdpc3RyYXRpb24sIG51bGwsIDEpfSAke2V9YCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFwYXJzZWROdW1iZXIpIHtcbiAgICAgICAgICAgIHRocm93IHtcbiAgICAgICAgICAgICAgICBzdGF0dXM6IDQwMCxcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBQaG9uZSBOdW1iZXInXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlZ2lzdHJhdGlvbk1vZGVsID0gbmV3IFJlZ2lzdHJhdGlvbk1vZGVsKHtcbiAgICAgICAgICAgIFBob25lTnVtYmVyOiB0aGlzLlBob25lTnVtYmVyLFxuICAgICAgICAgICAgbGFzdFByb21vU2VudEF0OiBuZXcgRGF0ZSgyMDE0KSwgLy8gUEFTVCBkYXRlXG4gICAgICAgICAgICBEaXNwbGF5UGhvbmU6IGAqKioqKioqJHt0aGlzLlBob25lTnVtYmVyLnNsaWNlKC00KX1gLFxuICAgICAgICAgICAgRGV2aWNlVG9rZW5zOiBbXSxcbiAgICAgICAgICAgIEFuZHJvaWREZXZpY2VUb2tlbnM6IFtdLFxuICAgICAgICAgICAgSGFzaDogdW5pcXVlSWQudGltZSgpLFxuICAgICAgICAgICAgU2VsZlJlZ2lzdGVyZWQ6IHRydWUsXG4gICAgICAgICAgICBSZWdpb25Db2RlOiBwaG9uZVV0aWwuZ2V0UmVnaW9uQ29kZUZvck51bWJlcihwYXJzZWROdW1iZXIpLFxuICAgICAgICAgICAgSXNBcnRpc3Q6IGZhbHNlXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBzYXZlZFJlZ2lzdHJhdGlvbiA9IGF3YWl0IHJlZ2lzdHJhdGlvbk1vZGVsLnNhdmUoKTtcbiAgICAgICAgdGhpcy5SZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25Nb2RlbDtcbiAgICAgICAgdGhpcy5DbGllbnRSZWdpb25Db2RlID0gcmVnaXN0cmF0aW9uTW9kZWwuUmVnaW9uQ29kZTtcbiAgICAgICAgaWYgKHRoaXMuVmVyaWZ5T1RQKSB7XG4gICAgICAgICAgICB0aGlzLk90cENhY2hlS2V5ID0gYG90cC0ke3RoaXMuUmVnaXN0cmF0aW9uLl9pZH1gO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5TZW5kVmVyaWZpY2F0aW9uQ29kZSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzYXZlZFJlZ2lzdHJhdGlvbjtcbiAgICB9XG5cbiAgICBhc3luYyBTZW5kVmVyaWZpY2F0aW9uQ29kZSgpIHtcbiAgICAgICAgY29uc3Qgb2JqID0ge1xuICAgICAgICAgICAgVmVyaWZpY2F0aW9uQ29kZTogYCR7TWF0aC5mbG9vcigxMDAwICsgTWF0aC5yYW5kb20oKSAqIDkwMDApfWAsXG4gICAgICAgICAgICBWZXJpZmljYXRpb25Db2RlRXhwOiBuZXcgRGF0ZShuZXcgRGF0ZSgpLmdldFRpbWUoKSArIDE1ICogNjAgKiAxMDAwKS5nZXRUaW1lKClcbiAgICAgICAgfTtcbiAgICAgICAgYXdhaXQgdGhpcy5jYWNoZVNldCh0aGlzLk90cENhY2hlS2V5LCBKU09OLnN0cmluZ2lmeShvYmopKTtcbiAgICAgICAgbG9nZ2VyLmluZm8oYHNlbmRpbmcgb3RwIHNtcyhSZWdpc3RlclZvdGVyVjIpICR7b2JqLlZlcmlmaWNhdGlvbkNvZGV9YCk7XG4gICAgICAgIGxldCBib2R5ID0gYFBsZWFzZSB1c2UgJHtvYmouVmVyaWZpY2F0aW9uQ29kZX0gdG8gbG9naW5gO1xuICAgICAgICBpZiAodGhpcy5hbmRyb2lkKSB7XG4gICAgICAgICAgICBib2R5ID0gYDwjPiAke2JvZHl9IFlPSXBZQ0pQd25WYDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzZXJ2ZXJObyA9IGF3YWl0IHRoaXMuZmluZEFwcHJvcHJpYXRlU2VydmVyTnVtYmVyKCk7XG4gICAgICAgIGNvbnN0IHR3aWxpb0NsaWVudCA9IFR3aWxpbygpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgdHdpbGlvUmVzID0gYXdhaXQgdHdpbGlvQ2xpZW50Lm1lc3NhZ2VzLmNyZWF0ZSh7XG4gICAgICAgICAgICAgICAgZnJvbTogc2VydmVyTm8sXG4gICAgICAgICAgICAgICAgdG86IHRoaXMuUmVnaXN0cmF0aW9uLlBob25lTnVtYmVyLFxuICAgICAgICAgICAgICAgIGJvZHk6IGJvZHksXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHBvc3RUb1NsYWNrU01TRmxvb2Qoe1xuICAgICAgICAgICAgICAgICd0ZXh0JzogYCR7dGhpcy5SZWdpc3RyYXRpb24uTmlja05hbWV9KCR7dGhpcy5SZWdpc3RyYXRpb24uUGhvbmVOdW1iZXJ9KSAoc21zKSBcXG4ke2JvZHkucmVwbGFjZShvYmouVmVyaWZpY2F0aW9uQ29kZSwgJyoqKionKX0gIHNvdXJjZTogUmVnaXN0ZXJWb3RlVjIuU2VuZFZlcmlmaWNhdGlvbkNvZGVgXG4gICAgICAgICAgICB9KS5jYXRjaCgoKSA9PiBsb2dnZXIuZXJyb3IoYHZlcmlmaWNhdGlvbiBjb2RlIHNsYWNrIGZsb29kIGNhbGwgZmFpbGVkICR7IGJvZHkgfSBzb3VyY2U6IFJlZ2lzdGVyVm90ZVYyLlNlbmRWZXJpZmljYXRpb25Db2RlYCkpO1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oYHNlbnQgb3RwIHNtcyhSZWdpc3RlclZvdGVyVjIpICR7b2JqLlZlcmlmaWNhdGlvbkNvZGV9LCAke3R3aWxpb1JlcyAmJiB0d2lsaW9SZXMuc2lkfVxuICAgICAgICAgICAgICAgIHRvICR7dGhpcy5SZWdpc3RyYXRpb24uUGhvbmVOdW1iZXJ9LCBzZXJ2ZXIgJHtzZXJ2ZXJOb31gKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICh0eXBlb2YgZSA9PT0gJ3N0cmluZycgJiYgZS5pbmRleE9mKCdibGFja2xpc3QgcnVsZScpID4gLTEpXG4gICAgICAgICAgICAgICAgfHwgKHR5cGVvZiBlLm1lc3NhZ2UgPT09ICdzdHJpbmcnICYmIGUubWVzc2FnZS5pbmRleE9mKCdibGFja2xpc3QgcnVsZScpID4gLTEpXG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBlID0gYFBsZWFzZSBzZW5kIFNUQVJUIHRvICR7c2VydmVyTm99IHRoZW4gcmVnaXN0ZXIgYWdhaW4uYDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBmaW5kQXBwcm9wcmlhdGVTZXJ2ZXJOdW1iZXIoKSB7XG4gICAgICAgIGNvbnN0IHByb21pc2VzID0gW1xuICAgICAgICAgICAgRXZlbnRQaG9uZU51bWJlck1vZGVsLmZpbmRPbmUoe1xuICAgICAgICAgICAgICAgICdSZWdpb25Db2RlJzogdGhpcy5DbGllbnRSZWdpb25Db2RlLFxuICAgICAgICAgICAgICAgICd0eXBlJzogJ3ZvdGUnXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBFdmVudFBob25lTnVtYmVyTW9kZWwuZmluZE9uZSh7XG4gICAgICAgICAgICAgICAgJ1JlZ2lvbkNvZGUnOiAnVVMnLFxuICAgICAgICAgICAgICAgICd0eXBlJzogJ3ZvdGUnXG4gICAgICAgICAgICB9KVxuICAgICAgICBdO1xuICAgICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgICAgICBpZiAocmVzdWx0c1swXSkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHNbMF0ucGhvbmU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhgdXNlciByZWdpb24gY29kZSBub3QgZm91bmQgJHt0aGlzLkNsaWVudFJlZ2lvbkNvZGV9IHVzaW5nIFVTIG51bWJlcmApO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHNbMV0ucGhvbmU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBWZXJpZnlDb2RlKHZlcmlmaWNhdGlvbkNvZGU6IHN0cmluZykge1xuICAgICAgICB0aGlzLk90cENhY2hlS2V5ID0gYG90cC0ke3RoaXMuUmVnaXN0cmF0aW9uLl9pZH1gO1xuICAgICAgICBjb25zdCBvdHBTdHIgPSBhd2FpdCB0aGlzLmNhY2hlR2V0KHRoaXMuT3RwQ2FjaGVLZXkpO1xuICAgICAgICBpZiAob3RwU3RyKSB7XG4gICAgICAgICAgICBjb25zdCBvdHBPYmogPSBKU09OLnBhcnNlKG90cFN0cik7XG4gICAgICAgICAgICBpZiAob3RwT2JqLlZlcmZpY2F0aW9uQ29kZUV4cCA8IG5ldyBEYXRlKCkuZ2V0VGltZSgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChvdHBPYmouVmVyaWZpY2F0aW9uQ29kZSA9PT0gdmVyaWZpY2F0aW9uQ29kZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgR2V0VG9rZW4oKSB7XG4gICAgICAgIHJldHVybiBzaWduKHtcbiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbklkOiB0aGlzLlJlZ2lzdHJhdGlvbi5faWQsXG4gICAgICAgIH0sIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQsICB7IGV4cGlyZXNJbjogcHJvY2Vzcy5lbnYuSldUX0VYUF9USU1FIHx8ICcxeSd9KTtcbiAgICB9XG59Il19
