"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bootstrap_1 = require("./bootstrap");
const Lot_1 = require("../models/Lot");
const Event_1 = require("../models/Event");
const VotingLog_1 = require("../models/VotingLog");
const Registration_1 = require("../models/Registration");
let incEid = 1;
let mongoose;
bootstrap_1.default().then((obj) => {
    mongoose = obj.mongoose;
    return start();
}).then(() => {
    console.log('done');
    return mongoose.connection.close();
}).catch(e => {
    console.error(e);
    if (mongoose.connection) {
        return mongoose.connection.close();
    }
}).then(() => {
    console.log('closed db conn');
});
async function start() {
    await updateLots();
    await updateVotingLogs();
}
async function updateLots() {
    const lots = await Lot_1.default.find().populate('Event');
    for (let i = 0; i < lots.length; i++) {
        const lot = lots[i];
        const event = lot.Event;
        await processContestants(event, lot);
    }
}
async function updateVotingLogs() {
    const events = await Event_1.default.find().populate('Rounds.Contestants.Detail');
    for (let i = 0; i < events.length; i++) {
        const event = events[i];
        for (let j = 0; j < event.Rounds.length; j++) {
            const round = event.Rounds[j];
            for (let k = 0; k < round.Contestants.length; k++) {
                await MapLotAndContestant(round.Contestants[k], round, event);
                await findAndMapVotingLogs(round.Contestants[k], round, event);
            }
        }
        await event.save();
    }
}
async function processContestants(Event, Lot) {
    for (let i = 0; i < Event.Rounds.length; i++) {
        const round = Event.Rounds[i];
        for (let j = 0; j < round.Contestants.length; j++) {
            const contestant = round.Contestants[j];
            if (!contestant.Lot) {
                contestant.Lot = Lot;
                await Event.save();
            }
            if (contestant.EaselNumber === Lot.EaselNumber && round.RoundNumber === Lot.Round) {
                Lot.Contestant = contestant.Detail;
                await Lot.save();
            }
        }
    }
}
async function findAndMapVotingLogs(contestant, round, event) {
    const logs = await VotingLog_1.default.find({
        RoundNumber: round.RoundNumber,
        EventId: event._id,
        EaselNumber: contestant.EaselNumber
    });
    for (let i = 0; i < logs.length; i++) {
        const log = logs[i];
        if (log.PhoneNumber) {
            await MapVotingLogLotContestantRegistration(contestant, round, event, log);
        }
    }
}
async function MapVotingLogLotContestantRegistration(contestant, round, event, log) {
    const registration = await Registration_1.default.findOne({ PhoneNumber: log.PhoneNumber });
    if (registration) {
        log.Registration = registration;
        log.Contestant = contestant.Detail;
        log.Lot = contestant.Lot;
        await log.save();
    }
}
async function MapLotAndContestant(contestant, round, event) {
    if (contestant.Enabled && contestant.EaselNumber > 0 && !contestant.Lot) {
        const Lot = await Lot_1.default.findOne({
            EaselNumber: contestant.EaselNumber,
            Round: round.RoundNumber,
            Event: event._id
        });
        if (!Lot) {
            if (!event.EID) {
                event.EID = `AB-${incEid++}`;
                console.log('event.EID', event.EID);
            }
            const lotModel = new Lot_1.default();
            lotModel.ArtId = `${event.EID}-${round.RoundNumber}-${contestant.EaselNumber}`;
            lotModel.EaselNumber = contestant.EaselNumber;
            lotModel.Event = event._id;
            lotModel.Round = round.RoundNumber;
            lotModel.Bids = [];
            lotModel.Status = 0;
            lotModel.Contestant = contestant.Detail;
            lotModel.ArtistId = contestant.Detail.EntryId;
            contestant.Lot = await lotModel.save();
        }
        else if (Lot) {
            contestant.Lot = Lot;
        }
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNjcmlwdHMvZml4QXJ0aXN0UHJvZmlsZUxpbmsudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwyQ0FBa0M7QUFDbEMsdUNBQXNEO0FBQ3RELDJDQUE0RDtBQUM1RCxtREFBd0U7QUFHeEUseURBQXVEO0FBQ3ZELElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztBQUNmLElBQUksUUFBbUMsQ0FBQztBQUN4QyxtQkFBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7SUFDbkIsUUFBUSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUM7SUFDeEIsT0FBTyxLQUFLLEVBQUUsQ0FBQztBQUNuQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO0lBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNwQixPQUFPLFFBQVEsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDdkMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO0lBQ1QsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNqQixJQUFJLFFBQVEsQ0FBQyxVQUFVLEVBQUU7UUFDckIsT0FBTyxRQUFRLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO0tBQ3RDO0FBQ0wsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtJQUNULE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUNsQyxDQUFDLENBQUMsQ0FBQztBQUVILEtBQUssVUFBVSxLQUFLO0lBQ2hCLE1BQU0sVUFBVSxFQUFFLENBQUM7SUFDbkIsTUFBTSxnQkFBZ0IsRUFBRSxDQUFDO0FBQzdCLENBQUM7QUFFRCxLQUFLLFVBQVUsVUFBVTtJQUNyQixNQUFNLElBQUksR0FBRyxNQUFNLGFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDckQs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R0FBRyxFQUFFO1lBQ04sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUU7Z0JBQ1osS0FBSyxDQUFDLEdBQUcsR0FBRyxNQUFNLE1BQU0sRUFBRSxFQUFFLENBQUM7Z0JBQzdCLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUN2QztZQUNELE1BQU0sUUFBUSxHQUFHLElBQUksYUFBUSxFQUFFLENBQUM7WUFDaEMsUUFBUSxDQUFDLEtBQUssR0FBRyxHQUFHLEtBQUssQ0FBQyxHQUFHLElBQUksS0FBSyxDQUFDLFdBQVcsSUFBSSxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDL0UsUUFBUSxDQUFDLFdBQVcsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDO1lBQzlDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQztZQUMzQixRQUFRLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7WUFDbkMsUUFBUSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7WUFDbkIsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7WUFDcEIsUUFBUSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDO1lBQ3hDLFFBQVEsQ0FBQyxRQUFRLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUM7WUFDOUMsVUFBVSxDQUFDLEdBQUcsR0FBRyxNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUMxQzthQUFNLElBQUksR0FBRyxFQUFFO1lBQ1osVUFBVSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7U0FDeEI7S0FDSjtBQUNMLENBQUMiLCJmaWxlIjoic2NyaXB0cy9maXhBcnRpc3RQcm9maWxlTGluay5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2FkQXBwIGZyb20gJy4vYm9vdHN0cmFwJztcbmltcG9ydCBMb3RNb2RlbCwgeyBMb3REb2N1bWVudCB9IGZyb20gJy4uL21vZGVscy9Mb3QnO1xuaW1wb3J0IEV2ZW50TW9kZWwsIHsgRXZlbnREb2N1bWVudCB9IGZyb20gJy4uL21vZGVscy9FdmVudCc7XG5pbXBvcnQgVm90aW5nTG9nTW9kZWwsIHsgVm90aW5nTG9nRG9jdW1lbnQgfSBmcm9tICcuLi9tb2RlbHMvVm90aW5nTG9nJztcbmltcG9ydCBSb3VuZENvbnRlc3RhbnREVE8gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL1JvdW5kQ29udGVzdGFudERUTyc7XG5pbXBvcnQgUm91bmREVE8gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL1JvdW5kRFRPJztcbmltcG9ydCBSZWdpc3RyYXRpb25Nb2RlbCBmcm9tICcuLi9tb2RlbHMvUmVnaXN0cmF0aW9uJztcbmxldCBpbmNFaWQgPSAxO1xubGV0IG1vbmdvb3NlOiB0eXBlb2YgaW1wb3J0KCdtb25nb29zZScpO1xubG9hZEFwcCgpLnRoZW4oKG9iaikgPT4ge1xuICAgIG1vbmdvb3NlID0gb2JqLm1vbmdvb3NlO1xuICAgIHJldHVybiBzdGFydCgpO1xufSkudGhlbigoKSA9PiB7XG4gICAgY29uc29sZS5sb2coJ2RvbmUnKTtcbiAgICByZXR1cm4gbW9uZ29vc2UuY29ubmVjdGlvbi5jbG9zZSgpO1xufSkuY2F0Y2goZSA9PiB7XG4gICAgY29uc29sZS5lcnJvcihlKTtcbiAgICBpZiAobW9uZ29vc2UuY29ubmVjdGlvbikge1xuICAgICAgICByZXR1cm4gbW9uZ29vc2UuY29ubmVjdGlvbi5jbG9zZSgpO1xuICAgIH1cbn0pLnRoZW4oKCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdjbG9zZWQgZGIgY29ubicpO1xufSk7XG5cbmFzeW5jIGZ1bmN0aW9uIHN0YXJ0KCkge1xuICAgIGF3YWl0IHVwZGF0ZUxvdHMoKTtcbiAgICBhd2FpdCB1cGRhdGVWb3RpbmdMb2dzKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUxvdHMoKSB7XG4gICAgY29uc3QgbG90cyA9IGF3YWl0IExvdE1vZGVsLmZpbmQoKS5wb3B1bGF0ZSgnRXZlbnQnKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxvdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgbG90ID0gbG90c1tpXTtcbiAgICAgICAgY29uc3QgZXZlbnQgPSBsb3QuRXZlbnQ7XG4gICAgICAgIGF3YWl0IHByb2Nlc3NDb250ZXN0YW50cyhldmVudCwgbG90KTtcbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVZvdGluZ0xvZ3MoKSB7XG4gICAgY29uc3QgZXZlbnRzID0gYXdhaXQgRXZlbnRNb2RlbC5maW5kKCkucG9wdWxhdGUoJ1JvdW5kcy5Db250ZXN0YW50cy5EZXRhaWwnKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBldmVudCA9IGV2ZW50c1tpXTtcbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBldmVudC5Sb3VuZHMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHJvdW5kID0gZXZlbnQuUm91bmRzW2pdO1xuICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCByb3VuZC5Db250ZXN0YW50cy5sZW5ndGg7IGsrKykge1xuICAgICAgICAgICAgICAgIGF3YWl0IE1hcExvdEFuZENvbnRlc3RhbnQocm91bmQuQ29udGVzdGFudHNba10sIHJvdW5kLCBldmVudCk7XG4gICAgICAgICAgICAgICAgYXdhaXQgZmluZEFuZE1hcFZvdGluZ0xvZ3Mocm91bmQuQ29udGVzdGFudHNba10sIHJvdW5kLCBldmVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgZXZlbnQuc2F2ZSgpO1xuICAgIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc0NvbnRlc3RhbnRzKEV2ZW50OiBFdmVudERvY3VtZW50LCBMb3Q6IExvdERvY3VtZW50KSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBFdmVudC5Sb3VuZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3Qgcm91bmQgPSBFdmVudC5Sb3VuZHNbaV07XG4gICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcm91bmQuQ29udGVzdGFudHMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlc3RhbnQgID0gcm91bmQuQ29udGVzdGFudHNbal07XG4gICAgICAgICAgICBpZiAoIWNvbnRlc3RhbnQuTG90KSB7XG4gICAgICAgICAgICAgICAgY29udGVzdGFudC5Mb3QgPSBMb3Q7XG4gICAgICAgICAgICAgICAgYXdhaXQgRXZlbnQuc2F2ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNvbnRlc3RhbnQuRWFzZWxOdW1iZXIgPT09IExvdC5FYXNlbE51bWJlciAmJiByb3VuZC5Sb3VuZE51bWJlciA9PT0gTG90LlJvdW5kKSB7XG4gICAgICAgICAgICAgICAgTG90LkNvbnRlc3RhbnQgPSBjb250ZXN0YW50LkRldGFpbDtcbiAgICAgICAgICAgICAgICBhd2FpdCBMb3Quc2F2ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBmaW5kQW5kTWFwVm90aW5nTG9ncyhjb250ZXN0YW50OiBSb3VuZENvbnRlc3RhbnREVE8sIHJvdW5kOiBSb3VuZERUTywgZXZlbnQ6IEV2ZW50RG9jdW1lbnQpIHtcbiAgICBjb25zdCBsb2dzID0gYXdhaXQgVm90aW5nTG9nTW9kZWwuZmluZCh7XG4gICAgICAgIFJvdW5kTnVtYmVyOiByb3VuZC5Sb3VuZE51bWJlcixcbiAgICAgICAgRXZlbnRJZDogZXZlbnQuX2lkLFxuICAgICAgICBFYXNlbE51bWJlcjogY29udGVzdGFudC5FYXNlbE51bWJlclxuICAgIH0pO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbG9ncy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBsb2cgPSBsb2dzW2ldO1xuICAgICAgICBpZiAobG9nLlBob25lTnVtYmVyKSB7XG4gICAgICAgICAgICBhd2FpdCBNYXBWb3RpbmdMb2dMb3RDb250ZXN0YW50UmVnaXN0cmF0aW9uKGNvbnRlc3RhbnQsIHJvdW5kLCBldmVudCwgbG9nKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gTWFwVm90aW5nTG9nTG90Q29udGVzdGFudFJlZ2lzdHJhdGlvbihjb250ZXN0YW50OiBSb3VuZENvbnRlc3RhbnREVE8sIHJvdW5kOiBSb3VuZERUTyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6IEV2ZW50RG9jdW1lbnQsIGxvZzogVm90aW5nTG9nRG9jdW1lbnQpIHtcbiAgICBjb25zdCByZWdpc3RyYXRpb24gPSBhd2FpdCBSZWdpc3RyYXRpb25Nb2RlbC5maW5kT25lKHtQaG9uZU51bWJlcjogbG9nLlBob25lTnVtYmVyfSk7XG4gICAgaWYgKHJlZ2lzdHJhdGlvbikge1xuICAgICAgICBsb2cuUmVnaXN0cmF0aW9uID0gcmVnaXN0cmF0aW9uO1xuICAgICAgICBsb2cuQ29udGVzdGFudCA9IGNvbnRlc3RhbnQuRGV0YWlsO1xuICAgICAgICBsb2cuTG90ID0gY29udGVzdGFudC5Mb3Q7XG4gICAgICAgIGF3YWl0IGxvZy5zYXZlKCk7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBNYXBMb3RBbmRDb250ZXN0YW50KGNvbnRlc3RhbnQ6IFJvdW5kQ29udGVzdGFudERUTywgcm91bmQ6IFJvdW5kRFRPLCBldmVudDogRXZlbnREb2N1bWVudCkge1xuICAgIGlmIChjb250ZXN0YW50LkVuYWJsZWQgJiYgY29udGVzdGFudC5FYXNlbE51bWJlciA+IDAgJiYgIWNvbnRlc3RhbnQuTG90KSB7XG4gICAgICAgIGNvbnN0IExvdCA9IGF3YWl0IExvdE1vZGVsLmZpbmRPbmUoe1xuICAgICAgICAgICAgRWFzZWxOdW1iZXI6IGNvbnRlc3RhbnQuRWFzZWxOdW1iZXIsXG4gICAgICAgICAgICBSb3VuZDogcm91bmQuUm91bmROdW1iZXIsXG4gICAgICAgICAgICBFdmVudDogZXZlbnQuX2lkXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIUxvdCkge1xuICAgICAgICAgICAgaWYgKCFldmVudC5FSUQpIHtcbiAgICAgICAgICAgICAgICBldmVudC5FSUQgPSBgQUItJHtpbmNFaWQrK31gO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdldmVudC5FSUQnLCBldmVudC5FSUQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgbG90TW9kZWwgPSBuZXcgTG90TW9kZWwoKTtcbiAgICAgICAgICAgIGxvdE1vZGVsLkFydElkID0gYCR7ZXZlbnQuRUlEfS0ke3JvdW5kLlJvdW5kTnVtYmVyfS0ke2NvbnRlc3RhbnQuRWFzZWxOdW1iZXJ9YDtcbiAgICAgICAgICAgIGxvdE1vZGVsLkVhc2VsTnVtYmVyID0gY29udGVzdGFudC5FYXNlbE51bWJlcjtcbiAgICAgICAgICAgIGxvdE1vZGVsLkV2ZW50ID0gZXZlbnQuX2lkO1xuICAgICAgICAgICAgbG90TW9kZWwuUm91bmQgPSByb3VuZC5Sb3VuZE51bWJlcjtcbiAgICAgICAgICAgIGxvdE1vZGVsLkJpZHMgPSBbXTtcbiAgICAgICAgICAgIGxvdE1vZGVsLlN0YXR1cyA9IDA7XG4gICAgICAgICAgICBsb3RNb2RlbC5Db250ZXN0YW50ID0gY29udGVzdGFudC5EZXRhaWw7XG4gICAgICAgICAgICBsb3RNb2RlbC5BcnRpc3RJZCA9IGNvbnRlc3RhbnQuRGV0YWlsLkVudHJ5SWQ7XG4gICAgICAgICAgICBjb250ZXN0YW50LkxvdCA9IGF3YWl0IGxvdE1vZGVsLnNhdmUoKTtcbiAgICAgICAgfSBlbHNlIGlmIChMb3QpIHtcbiAgICAgICAgICAgIGNvbnRlc3RhbnQuTG90ID0gTG90O1xuICAgICAgICB9XG4gICAgfVxufSJdfQ==
