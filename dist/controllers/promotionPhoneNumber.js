"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getEvents = exports.getEventPhoneNumber = void 0;
// @ts-ignore
const date_fns_timezone_1 = require("date-fns-timezone");
// @ts-ignore
const date_fns_1 = require("date-fns");
const Event_1 = require("../models/Event");
const EventPhoneNumber_1 = require("../models/EventPhoneNumber");
exports.getEventPhoneNumber = async (req, res, next) => {
    const query = {
        status: 1,
    };
    const promises = [];
    const promise1 = EventPhoneNumber_1.default.find(query).select([
        '_id',
        'phone',
        'label',
        'type',
        'location',
        'status'
    ])
        .sort({
        'EventStartDateTime': -1
    }).exec();
    promises.push(promise1);
    const results = await Promise.all(promises);
    const activeEventsPhoneNumber = results[0];
    res.json(activeEventsPhoneNumber);
};
exports.getEvents = async (req, res, next) => {
    const PhoneNumber = false;
    const eventId = req.query.eventName;
    const query = {
        ShowInApp: true,
    };
    if (eventId && eventId.length > 0) {
        query.Name = new RegExp(eventId);
    }
    const promises = [];
    const promise1 = Event_1.default.find(query).select([
        '_id',
        'EID',
        'Name',
        'CurrentRound',
        'Country',
        'Rounds',
        'EventStartDateTime',
        'TicketLink',
        'Venue',
        'Price',
        'Description',
        'EventEndDateTime',
        'TimeZoneICANN',
    ])
        .populate('Country')
        .populate('Rounds.Contestants.Votes')
        .sort({
        'EventStartDateTime': -1
    }).exec();
    promises.push(promise1);
    // past event list
    const results = await Promise.all(promises);
    const activeEvents = results[0];
    const activeEventsList = [];
    for (let i = 0; i < activeEvents.length; i++) {
        const event = activeEvents[i];
        const currentRound = event.CurrentRound;
        const currentRoundNumber = currentRound && currentRound.RoundNumber;
        let numVotes = 0;
        let roundText = '';
        let roundColor = '';
        let statusTextColor = '#FFF';
        const totalRounds = event.Rounds.length;
        let hasOpenRound = false;
        for (let j = 0; j < totalRounds; j++) {
            const Round = event.Rounds[j];
            if (!Round.IsFinished) {
                hasOpenRound = true;
            }
            const contestants = Round.Contestants;
            for (let k = 0; k < contestants.length; k++) {
                numVotes += contestants[k].Votes.length;
            }
        }
        if (currentRoundNumber) {
            roundText = `LIVE`;
            roundColor = '#D14B19';
        }
        else {
            if (hasOpenRound) {
                const eventDate = new Date(event.EventStartDateTime);
                const differenceInMs = date_fns_1.differenceInMilliseconds(eventDate, new Date());
                const distanceInWord = date_fns_1.distanceInWordsStrict(eventDate, new Date());
                if (differenceInMs > 0) {
                    roundText = `In ${distanceInWord}`;
                    roundColor = '#1975D1';
                    roundText = roundText.replace('days', 'd');
                    roundText = roundText.replace('seconds', 's');
                    roundText = roundText.replace('hours', 'h');
                    roundText = roundText.replace('minutes', 'm');
                    roundText = roundText.replace('months', 'mo');
                    roundText = roundText.replace('years', 'y');
                }
                else {
                    roundText = `Starting soon`;
                    roundColor = '#1975D1';
                }
            }
            else {
                roundText = 'FINAL';
                roundColor = '#FFF';
                statusTextColor = '#000';
            }
        }
        const eventObj = {
            id: event._id,
            EID: event.EID || '',
            title: event.Name,
            flag: event.Country ? `${process.env.SITE_URL}/images/countries/4x3/${event.Country.country_image}` : '',
            flagPng: event.Country ? `${process.env.SITE_URL}/images/countries/4x3_png/${event.Country.country_image.replace('svg', 'png')}` : '',
            statusText: roundText,
            statusColor: roundColor,
            statusTextColor: statusTextColor,
            eventId: event.id,
            openVoting: false,
            openStatus: false,
            TicketLink: event.TicketLink || '',
            Venue: event.Venue || '',
            Price: event.Price || '',
            Description: event.Description,
            DataTimeRange: date_fns_timezone_1.formatToTimeZone(new Date(event.EventStartDateTime), 'MMMMDo-hmmaz', { timeZone: event.TimeZoneICANN || 'America/Toronto' }),
            Votes: numVotes,
            EventNo: i + 1,
            StreamUrl: event.VideoStream || event.LiveStream
        };
        activeEventsList.push(eventObj);
    }
    const eventList = [
        {
            label: 'ACTIVE EVENTS',
            items: activeEventsList,
            topPlayerUrl: ''
        }
    ];
    const result = {
        'Success': true,
        Data: eventList
    };
    res.json(activeEventsList);
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbnRyb2xsZXJzL3Byb21vdGlvblBob25lTnVtYmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLGFBQWE7QUFDYix5REFBd0U7QUFDeEUsYUFBYTtBQUNiLHVDQUEyRTtBQUUzRSwyQ0FBdUU7QUFNdkUsaUVBQThFO0FBR2pFLFFBQUEsbUJBQW1CLEdBQUcsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO0lBQzFGLE1BQU0sS0FBSyxHQUVQO1FBQ0QsTUFBTSxFQUFFLENBQUM7S0FDWCxDQUFDO0lBRUYsTUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDO0lBQ3BCLE1BQU0sUUFBUSxHQUFHLDBCQUFxQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDdkQsS0FBSztRQUNMLE9BQU87UUFDUCxPQUFPO1FBQ1AsTUFBTTtRQUNOLFVBQVU7UUFDVixRQUFRO0tBQ1YsQ0FBQztTQUNFLElBQUksQ0FBQztRQUNILG9CQUFvQixFQUFFLENBQUMsQ0FBQztLQUMxQixDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7SUFFYixRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3hCLE1BQU0sT0FBTyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM1QyxNQUFNLHVCQUF1QixHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUczQyxHQUFHLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDckMsQ0FBQyxDQUFDO0FBRVcsUUFBQSxTQUFTLEdBQUcsS0FBSyxFQUFFLEdBQVksRUFBRSxHQUFhLEVBQUUsSUFBa0IsRUFBRSxFQUFFO0lBRWhGLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQztJQUUxQixNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQztJQUNwQyxNQUFNLEtBQUssR0FHUDtR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QUFxQztRQUM5QyxTQUFTLEVBQUUsSUFBSTtRQUNmLElBQUksRUFBRSxTQUFTO0tBQ2pCLENBQUM7SUFFRixHQUFHLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDOUIsQ0FBQyxDQUFDIiwiZmlsZSI6ImNvbnRyb2xsZXJzL3Byb21vdGlvblBob25lTnVtYmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuLy8gQHRzLWlnbm9yZVxuaW1wb3J0IHsgZm9ybWF0VG9UaW1lWm9uZSwgcGFyc2VGcm9tVGltZVpvbmUgfSBmcm9tICdkYXRlLWZucy10aW1lem9uZSc7XG4vLyBAdHMtaWdub3JlXG5pbXBvcnQgeyBkaWZmZXJlbmNlSW5NaWxsaXNlY29uZHMsIGRpc3RhbmNlSW5Xb3Jkc1N0cmljdCB9IGZyb20gJ2RhdGUtZm5zJztcblxuaW1wb3J0IHsgZGVmYXVsdCBhcyBFdmVudE1vZGVsLCBFdmVudERvY3VtZW50IH0gZnJvbSAnLi4vbW9kZWxzL0V2ZW50JztcbmltcG9ydCB7IERhdGFPcGVyYXRpb25SZXN1bHQsIE9wZXJhdGlvblJlc3VsdCB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC9PcGVyYXRpb25SZXN1bHQnO1xuaW1wb3J0IHsgRXZlbnRMaXN0LCBFdmVudHNJbnRlcmZhY2UgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvRXZlbnRMaXN0UmVzcG9uc2VEVE8nO1xuXG5pbXBvcnQgcG9zdFRvU2xhY2sgZnJvbSAnLi4vY29tbW9uL1NsYWNrJztcblxuaW1wb3J0IHsgZGVmYXVsdCBhcyBFdmVudFBob25lTnVtYmVyTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvRXZlbnRQaG9uZU51bWJlcic7XG5cblxuZXhwb3J0IGNvbnN0IGdldEV2ZW50UGhvbmVOdW1iZXIgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgIGNvbnN0IHF1ZXJ5OiB7XG4gICAgICBzdGF0dXM6IGFueTtcbiAgIH0gPSB7XG4gICAgICBzdGF0dXM6IDEsXG4gICB9O1xuXG4gICBjb25zdCBwcm9taXNlcyA9IFtdO1xuICAgY29uc3QgcHJvbWlzZTEgPSBFdmVudFBob25lTnVtYmVyTW9kZWwuZmluZChxdWVyeSkuc2VsZWN0KFtcbiAgICAgICdfaWQnLFxuICAgICAgJ3Bob25lJyxcbiAgICAgICdsYWJlbCcsXG4gICAgICAndHlwZScsXG4gICAgICAnbG9jYXRpb24nLFxuICAgICAgJ3N0YXR1cydcbiAgIF0pXG4gICAgICAuc29ydCh7XG4gICAgICAgICAnRXZlbnRTdGFydERhdGVUaW1lJzogLTFcbiAgICAgIH0pLmV4ZWMoKTtcblxuICAgcHJvbWlzZXMucHVzaChwcm9taXNlMSk7XG4gICBjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgY29uc3QgYWN0aXZlRXZlbnRzUGhvbmVOdW1iZXIgPSByZXN1bHRzWzBdO1xuXG5cbiAgIHJlcy5qc29uKGFjdGl2ZUV2ZW50c1Bob25lTnVtYmVyKTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRFdmVudHMgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcblxuICAgY29uc3QgUGhvbmVOdW1iZXIgPSBmYWxzZTtcblxuICAgY29uc3QgZXZlbnRJZCA9IHJlcS5xdWVyeS5ldmVudE5hbWU7XG4gICBjb25zdCBxdWVyeToge1xuICAgICAgU2hvd0luQXBwOiBib29sZWFuO1xuICAgICAgTmFtZT86IGFueTtcbiAgIH0gPSB7XG4gICAgICBTaG93SW5BcHA6IHRydWUsXG4gICB9O1xuICAgaWYgKGV2ZW50SWQgJiYgZXZlbnRJZC5sZW5ndGggPiAwKSB7XG4gICAgICBxdWVyeS5OYW1lID0gbmV3IFJlZ0V4cChldmVudElkKTtcbiAgIH1cbiAgIGNvbnN0IHByb21pc2VzID0gW107XG4gICBjb25zdCBwcm9taXNlMSA9IEV2ZW50TW9kZWwuZmluZChxdWVyeSkuc2VsZWN0KFtcbiAgICAgICdfaWQnLFxuICAgICAgJ0VJRCcsXG4gICAgICAnTmFtZScsXG4gICAgICAnQ3VycmVudFJvdW5kJyxcbiAgICAgICdDb3VudHJ5JyxcbiAgICAgICdSb3VuZHMnLFxuICAgICAgJ0V2ZW50U3RhcnREYXRlVGltZScsXG4gICAgICAnVGlja2V0TGluaycsXG4gICAgICAnVmVudWUnLFxuICAgICAgJ1ByaWNlJyxcbiAgICAgICdEZXNjcmlwdGlvbicsXG4gICAgICAnRXZlbnRFbmREYXRlVGltZScsXG4gICAgICAnVGltZVpvbmVJQ0FOTicsXG4gICBdKVxuICAgICAgLnBvcHVsYXRlKCdDb3VudHJ5JylcbiAgICAgIC5wb3B1bGF0ZSgnUm91bmRzLkNvbnRlc3RhbnRzLlZvdGVzJylcbiAgICAgIC5zb3J0KHtcbiAgICAgICAgICdFdmVudFN0YXJ0RGF0ZVRpbWUnOiAtMVxuICAgICAgfSkuZXhlYygpO1xuXG4gICBwcm9taXNlcy5wdXNoKHByb21pc2UxKTtcblxuICAgLy8gcGFzdCBldmVudCBsaXN0XG4gICBjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgY29uc3QgYWN0aXZlRXZlbnRzID0gcmVzdWx0c1swXTtcblxuICAgY29uc3QgYWN0aXZlRXZlbnRzTGlzdDogRXZlbnRzSW50ZXJmYWNlW10gPSBbXTtcblxuICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhY3RpdmVFdmVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gYWN0aXZlRXZlbnRzW2ldO1xuICAgICAgY29uc3QgY3VycmVudFJvdW5kID0gZXZlbnQuQ3VycmVudFJvdW5kO1xuICAgICAgY29uc3QgY3VycmVudFJvdW5kTnVtYmVyID0gY3VycmVudFJvdW5kICYmIGN1cnJlbnRSb3VuZC5Sb3VuZE51bWJlcjtcbiAgICAgIGxldCBudW1Wb3RlcyA9IDA7XG4gICAgICBsZXQgcm91bmRUZXh0ID0gJyc7XG4gICAgICBsZXQgcm91bmRDb2xvciA9ICcnO1xuICAgICAgbGV0IHN0YXR1c1RleHRDb2xvciA9ICcjRkZGJztcbiAgICAgIGNvbnN0IHRvdGFsUm91bmRzID0gZXZlbnQuUm91bmRzLmxlbmd0aDtcbiAgICAgIGxldCBoYXNPcGVuUm91bmQgPSBmYWxzZTtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdG90YWxSb3VuZHM7IGorKykge1xuICAgICAgICAgY29uc3QgUm91bmQgPSBldmVudC5Sb3VuZHNbal07XG4gICAgICAgICBpZiAoIVJvdW5kLklzRmluaXNoZWQpIHtcbiAgICAgICAgICAgIGhhc09wZW5Sb3VuZCA9IHRydWU7XG4gICAgICAgICB9XG4gICAgICAgICBjb25zdCBjb250ZXN0YW50cyA9IFJvdW5kLkNvbnRlc3RhbnRzO1xuICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBjb250ZXN0YW50cy5sZW5ndGg7IGsrKykge1xuICAgICAgICAgICAgbnVtVm90ZXMgKz0gY29udGVzdGFudHNba10uVm90ZXMubGVuZ3RoO1xuICAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoY3VycmVudFJvdW5kTnVtYmVyKSB7XG4gICAgICAgICByb3VuZFRleHQgPSBgTElWRWA7XG4gICAgICAgICByb3VuZENvbG9yID0gJyNEMTRCMTknO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgIGlmIChoYXNPcGVuUm91bmQpIHtcbiAgICAgICAgICAgIGNvbnN0IGV2ZW50RGF0ZSA9IG5ldyBEYXRlKGV2ZW50LkV2ZW50U3RhcnREYXRlVGltZSk7XG4gICAgICAgICAgICBjb25zdCBkaWZmZXJlbmNlSW5NcyA9IGRpZmZlcmVuY2VJbk1pbGxpc2Vjb25kcyhldmVudERhdGUsIG5ldyBEYXRlKCkpO1xuICAgICAgICAgICAgY29uc3QgZGlzdGFuY2VJbldvcmQgPSBkaXN0YW5jZUluV29yZHNTdHJpY3QoZXZlbnREYXRlLCBuZXcgRGF0ZSgpKTtcbiAgICAgICAgICAgIGlmIChkaWZmZXJlbmNlSW5NcyA+IDApIHtcbiAgICAgICAgICAgICAgIHJvdW5kVGV4dCA9IGBJbiAke2Rpc3RhbmNlSW5Xb3JkfWA7XG4gICAgICAgICAgICAgICByb3VuZENvbG9yID0gJyMxOTc1RDEnO1xuICAgICAgICAgICAgICAgcm91bmRUZXh0ID0gcm91bmRUZXh0LnJlcGxhY2UoJ2RheXMnLCAnZCcpO1xuICAgICAgICAgICAgICAgcm91bmRUZXh0ID0gcm91bmRUZXh0LnJlcGxhY2UoJ3NlY29uZHMnLCAncycpO1xuICAgICAgICAgICAgICAgcm91bmRUZXh0ID0gcm91bmRUZXh0LnJlcGxhY2UoJ2hvdXJzJywgJ2gnKTtcbiAgICAgICAgICAgICAgIHJvdW5kVGV4dCA9IHJvdW5kVGV4dC5yZXBsYWNlKCdtaW51dGVzJywgJ20nKTtcbiAgICAgICAgICAgICAgIHJvdW5kVGV4dCA9IHJvdW5kVGV4dC5yZXBsYWNlKCdtb250aHMnLCAnbW8nKTtcbiAgICAgICAgICAgICAgIHJvdW5kVGV4dCA9IHJvdW5kVGV4dC5yZXBsYWNlKCd5ZWFycycsICd5Jyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgcm91bmRUZXh0ID0gYFN0YXJ0aW5nIHNvb25gO1xuICAgICAgICAgICAgICAgcm91bmRDb2xvciA9ICcjMTk3NUQxJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByb3VuZFRleHQgPSAnRklOQUwnO1xuICAgICAgICAgICAgcm91bmRDb2xvciA9ICcjRkZGJztcbiAgICAgICAgICAgIHN0YXR1c1RleHRDb2xvciA9ICcjMDAwJztcbiAgICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnN0IGV2ZW50T2JqID0ge1xuICAgICAgICAgaWQ6IGV2ZW50Ll9pZCxcbiAgICAgICAgIEVJRDogZXZlbnQuRUlEIHx8ICcnLFxuICAgICAgICAgdGl0bGU6IGV2ZW50Lk5hbWUsXG4gICAgICAgICBmbGFnOiBldmVudC5Db3VudHJ5ID8gYCR7cHJvY2Vzcy5lbnYuU0lURV9VUkx9L2ltYWdlcy9jb3VudHJpZXMvNHgzLyR7ZXZlbnQuQ291bnRyeS5jb3VudHJ5X2ltYWdlfWAgOiAnJyxcbiAgICAgICAgIGZsYWdQbmc6IGV2ZW50LkNvdW50cnkgPyBgJHtwcm9jZXNzLmVudi5TSVRFX1VSTH0vaW1hZ2VzL2NvdW50cmllcy80eDNfcG5nLyR7ZXZlbnQuQ291bnRyeS5jb3VudHJ5X2ltYWdlLnJlcGxhY2UoJ3N2ZycsICdwbmcnKX1gIDogJycsXG4gICAgICAgICBzdGF0dXNUZXh0OiByb3VuZFRleHQsXG4gICAgICAgICBzdGF0dXNDb2xvcjogcm91bmRDb2xvcixcbiAgICAgICAgIHN0YXR1c1RleHRDb2xvcjogc3RhdHVzVGV4dENvbG9yLFxuICAgICAgICAgZXZlbnRJZDogZXZlbnQuaWQsXG4gICAgICAgICBvcGVuVm90aW5nOiBmYWxzZSxcbiAgICAgICAgIG9wZW5TdGF0dXM6IGZhbHNlLFxuICAgICAgICAgVGlja2V0TGluazogZXZlbnQuVGlja2V0TGluayB8fCAnJyxcbiAgICAgICAgIFZlbnVlOiBldmVudC5WZW51ZSB8fCAnJyxcbiAgICAgICAgIFByaWNlOiBldmVudC5QcmljZSB8fCAnJyxcbiAgICAgICAgIERlc2NyaXB0aW9uOiBldmVudC5EZXNjcmlwdGlvbixcbiAgICAgICAgIERhdGFUaW1lUmFuZ2U6IGZvcm1hdFRvVGltZVpvbmUobmV3IERhdGUoZXZlbnQuRXZlbnRTdGFydERhdGVUaW1lKSwgJ01NTU1Eby1obW1heicsIHsgdGltZVpvbmU6IGV2ZW50LlRpbWVab25lSUNBTk4gfHwgJ0FtZXJpY2EvVG9yb250bycgfSksXG4gICAgICAgICBWb3RlczogbnVtVm90ZXMsXG4gICAgICAgICBFdmVudE5vOiBpICsgMSxcbiAgICAgICAgIFN0cmVhbVVybDogZXZlbnQuVmlkZW9TdHJlYW0gfHwgZXZlbnQuTGl2ZVN0cmVhbVxuICAgICAgfTtcbiAgICAgIGFjdGl2ZUV2ZW50c0xpc3QucHVzaChldmVudE9iaik7XG4gICB9XG5cbiAgIGNvbnN0IGV2ZW50TGlzdDogRXZlbnRMaXN0W10gPSBbXG4gICAgICB7XG4gICAgICAgICBsYWJlbDogJ0FDVElWRSBFVkVOVFMnLFxuICAgICAgICAgaXRlbXM6IGFjdGl2ZUV2ZW50c0xpc3QsXG4gICAgICAgICB0b3BQbGF5ZXJVcmw6ICcnXG4gICAgICB9XG4gICBdO1xuXG4gICBjb25zdCByZXN1bHQ6IERhdGFPcGVyYXRpb25SZXN1bHQ8RXZlbnRMaXN0W10+ID0ge1xuICAgICAgJ1N1Y2Nlc3MnOiB0cnVlLFxuICAgICAgRGF0YTogZXZlbnRMaXN0XG4gICB9O1xuXG4gICByZXMuanNvbihhY3RpdmVFdmVudHNMaXN0KTtcbn07XG5cbiJdfQ==
