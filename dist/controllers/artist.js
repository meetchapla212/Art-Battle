"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.refreshProductCache = exports.deleteProduct = exports.saveProduct = exports.wooList = exports.addVideo = exports.redirectedToInternal = exports.follow = exports.artistPublicProfile = exports.create = exports.update = exports.get = exports.autoSuggest = exports.search = exports.index = void 0;
const logger_1 = require("../config/logger");
const Contestant_1 = require("../models/Contestant");
const ArtistService_1 = require("../common/ArtistService");
const jsonwebtoken_1 = require("jsonwebtoken");
const Registration_1 = require("../models/Registration");
const ArtistWooCommerce_1 = require("../models/ArtistWooCommerce");
exports.index = async (req, res, next) => {
    try {
        const artistService = new ArtistService_1.ArtistService();
        // const list = await  artistService.List(req.user && req.user.Hash, req.app.get('cacheSet'), req.app.get('cacheGet'));
        const userId = req.user && req.user._id;
        const hash = req.user && req.user.Hash;
        let token = '';
        if (req.user) {
            token = jsonwebtoken_1.sign({
                registrationId: req.user._id
            }, process.env.JWT_SECRET, { expiresIn: process.env.JWT_EXP_TIME || '1y' });
            res.cookie('jwt', token, {
                httpOnly: true,
                sameSite: true,
                signed: true,
                secure: false
            });
        }
        res.redirect(307, `${process.env.SITE_URL}/resp/artists`);
        return;
        /*
        const list = await artistService.getArtistPageData(userId, hash, req.app.get('cacheSet'), req.app.get('cacheGet'));
    
        /*res.render('artist_list', {
          artistList: list,
          token: token
        });*/
        /*res.render('artist_list_v2', {
          artistList: list[0],
          followingArtist: list[1],
          token: token
        });*/
    }
    catch (e) {
        if (!e.status) {
            e.status = 500;
        }
        if (!e.message) {
            logger_1.default.error(e);
            e.message = 'Server error occurred!';
            e.Message = e.message;
        }
        next(e);
    }
};
exports.search = async (req, res, next) => {
    try {
        const searchTerm = req.body.searchTerm || '';
        /*const sortCol = req.body.sortCol || '_id';
        const sortOrder = req.body.sortOrder || -1;
        const sortObj: {
          [key: string]: number;
        } = {};
        sortObj[sortCol] = sortOrder;*/
        const artistService = new ArtistService_1.ArtistService();
        const resp = await artistService.searchArtists(searchTerm, req.body.limit, req.body.page, req.app.get('cacheSet'), req.app.get('cacheGet'));
        res.json(resp);
    }
    catch (e) {
        next(e);
    }
};
exports.autoSuggest = async (req, res, next) => {
    try {
        const searchTerm = req.query.q || '';
        const or = [
            {
                $text: {
                    $search: searchTerm,
                },
            },
            {
                Email: searchTerm
            }
        ];
        const entryId = parseInt(searchTerm);
        if (!isNaN(entryId)) {
            or.push({
                EntryId: entryId
            });
        }
        let query = {};
        if (searchTerm.length > 0) {
            query = {
                $or: or
            };
        }
        query.IsDuplicate = { $in: [null, false] };
        query.EntryId = { $exists: true };
        const results = await Promise.all([
            Contestant_1.default.find(query, { score: { $meta: 'textScore' } })
                .select(['_id', 'Name', 'EntryId'])
                .sort({ score: { $meta: 'textScore' } }),
            // .limit(req.query.limit)
            // .skip((req.query.page - 1) * 10)
        ]);
        const contestants = results[0];
        const resp = {
            Success: true,
            Data: {
                Contestants: contestants,
            }
        };
        res.json(resp);
    }
    catch (e) {
        next(e);
    }
};
exports.get = async (req, res, next) => {
    try {
        const contestantId = req.params.contestantId;
        if (!contestantId) {
            const message = `contestant Id is required`;
            logger_1.default.error(message);
            res.json({
                Success: false,
                status: 403,
                message: message
            });
            return;
        }
        const contestant = await Contestant_1.default.findById(contestantId).populate('Registration');
        if (!contestant) {
            const message = `Invalid contestant Id passed ${contestantId}`;
            logger_1.default.error(message);
            res.json({
                Success: false,
                status: 404,
                message: message
            });
            return;
        }
        const resp = {
            Success: true,
            Data: contestant
        };
        res.json(resp);
    }
    catch (e) {
        if (!e.status) {
            e.status = 500;
        }
        if (!e.message) {
            e.message = 'Server error occurred!';
        }
        next(e);
    }
};
exports.update = async (req, res, next) => {
    try {
        const artistService = new ArtistService_1.ArtistService();
        const contestantId = req.params.contestantId;
        const contestant = await artistService.Update(contestantId, req.body, req.header('user-agent'));
        const resp = {
            Success: true,
            Data: contestant
        };
        res.json(resp);
    }
    catch (e) {
        if (!e.status) {
            e.status = 500;
        }
        if (!e.message) {
            logger_1.default.error(e);
            e.message = 'Server error occurred!';
        }
        next(e);
    }
};
exports.create = async (req, res, next) => {
    try {
        const artistService = new ArtistService_1.ArtistService();
        const contestant = await artistService.Add(req.body, req.header('user-agent'));
        const resp = {
            Success: true,
            Data: contestant
        };
        res.json(resp);
    }
    catch (e) {
        next(e);
    }
};
exports.artistPublicProfile = async (req, res, next) => {
    try {
        const artistService = new ArtistService_1.ArtistService();
        const hash = req.params.hash;
        let regId;
        let phoneNumber;
        if (hash) {
            const result = await Registration_1.default.findOne({ Hash: hash });
            if (result) {
                regId = result._id;
                phoneNumber = result.PhoneNumber;
            }
        }
        const userId = req.user && req.user._id || regId;
        phoneNumber = phoneNumber || req.user && req.user.PhoneNumber;
        const artistProfile = await artistService.cachedArtistProfile(req.app.get('cacheSet'), req.app.get('cacheGet'), req.params.contestantId, userId, phoneNumber);
        let token;
        if (req.user) {
            // set cookie only for those who opened in browser.
            // dup token calculation because we are targeting cookie based req.user here
            token = jsonwebtoken_1.sign({
                registrationId: userId
            }, process.env.JWT_SECRET, { expiresIn: process.env.JWT_EXP_TIME || '1y' });
        }
        let artistProfileJson = JSON.stringify(artistProfile);
        artistProfileJson = artistProfileJson.replace(/[\\]/g, '\\\\')
            .replace(/[\"]/g, '\\\"')
            .replace(/[\/]/g, '\\/')
            .replace(/[\b]/g, '\\b')
            .replace(/[\f]/g, '\\f')
            .replace(/[\n]/g, '\\n')
            .replace(/[\r]/g, '\\r')
            .replace(/[\t]/g, '\\t');
        res.render('artist_public_profile', {
            token: token,
            artistId: req.params.contestantId,
            artistProfile: artistProfile,
            artistProfileJson: artistProfileJson,
            phoneHash: hash,
            title: artistProfile.Name
        });
    }
    catch (e) {
        next(e);
    }
};
exports.follow = async (req, res, next) => {
    try {
        const hash = req.params.hash;
        let regId;
        if (hash) {
            const result = await Registration_1.default.findOne({ Hash: hash });
            if (result) {
                regId = result._id;
            }
        }
        const userId = req.user && req.user._id || regId;
        const artistService = new ArtistService_1.ArtistService();
        const contestantId = req.params.contestantId;
        await artistService.Follow(contestantId, userId, req.body.IsFollowing);
        const resp = {
            Success: true,
            Data: 'Success'
        };
        res.json(resp);
    }
    catch (e) {
        if (!e.status) {
            e.status = 500;
        }
        if (!e.message) {
            logger_1.default.error(e);
            e.message = 'Server error occurred!';
        }
        next(e);
    }
};
exports.redirectedToInternal = async (req, res, next) => {
    try {
        if (req.params.entryId) {
            const contestant = await Contestant_1.default.findOne({ EntryId: req.params.entryId }).select(['_id']);
            if (contestant) {
                res.redirect(`${process.env.SITE_URL}/ar/${contestant._id}/${req.params.hash || ''}`);
                return;
            }
        }
        next({
            Success: false,
            status: 404,
            Message: 'Entry Id not found'
        });
        return;
    }
    catch (e) {
        next(e);
    }
};
exports.addVideo = async (req, res, next) => {
    try {
        const artistId = req.params.artistId;
        const videoUrl = req.body.URL;
        await Contestant_1.default.update({ _id: artistId }, { $push: { Videos: videoUrl } });
        const resp = {
            Success: true,
            Data: 'Success'
        };
        res.json(resp);
    }
    catch (e) {
        next(e);
    }
};
exports.wooList = async (req, res, next) => {
    try {
        const searchTerm = req.body.searchTerm || '';
        /*const sortCol = req.body.sortCol || '_id';
        const sortOrder = req.body.sortOrder || -1;
        const sortObj: {
          [key: string]: number;
        } = {};
        sortObj[sortCol] = sortOrder;*/
        const artistService = new ArtistService_1.ArtistService();
        const resp = await artistService.getProducts(searchTerm, req.body.limit, req.body.page);
        res.json(resp);
    }
    catch (e) {
        next(e);
    }
};
exports.saveProduct = async (req, res, next) => {
    try {
        const payload = req.body;
        const product = await ArtistWooCommerce_1.default.findOne({ ProductId: payload.ProductId });
        const artistService = new ArtistService_1.ArtistService();
        if (product) {
            res.json(await artistService.updateProduct(payload, product, req.app.get('cacheSet'), req.app.get('cacheGet')));
        }
        else {
            res.json(await artistService.addProduct(payload, req.app.get('cacheSet'), req.app.get('cacheGet')));
        }
    }
    catch (e) {
        next(e);
    }
};
exports.deleteProduct = async (req, res, next) => {
    try {
        const artistService = new ArtistService_1.ArtistService();
        await artistService.removeProduct(req.params.productId, req.app.get('cacheSet'), req.app.get('cacheGet'));
        const resp = {
            Success: true,
            Data: 'Success'
        };
        res.json(resp);
    }
    catch (e) {
        next(e);
    }
};
exports.refreshProductCache = async (req, res, next) => {
    try {
        const artistService = new ArtistService_1.ArtistService();
        await artistService.updateProductCache(req.params.productId, req.app.get('cacheSet'), req.app.get('cacheGet'));
        const resp = {
            Success: true,
            Data: 'Success'
        };
        res.json(resp);
    }
    catch (e) {
        next(e);
    }
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LE9BQU8sQ0FBQyxFQUFFO1FBQ1YsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ1Q7QUFDSCxDQUFDLENBQUMiLCJmaWxlIjoiY29udHJvbGxlcnMvYXJ0aXN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV4dEZ1bmN0aW9uLCBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9jb25maWcvbG9nZ2VyJztcbmltcG9ydCBDb250ZXN0YW50TW9kZWwgZnJvbSAnLi4vbW9kZWxzL0NvbnRlc3RhbnQnO1xuaW1wb3J0IHsgRGF0YU9wZXJhdGlvblJlc3VsdCB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC9PcGVyYXRpb25SZXN1bHQnO1xuaW1wb3J0IENvbnRlc3RhbnREVE8gIGZyb20gJy4uLy4uLy4uL3NoYXJlZC9Db250ZXN0YW50RFRPJztcbmltcG9ydCB7IEFydGlzdFNlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vQXJ0aXN0U2VydmljZSc7XG5pbXBvcnQgeyBzaWduIH0gZnJvbSAnanNvbndlYnRva2VuJztcbmltcG9ydCBSZWdpc3RyYXRpb25Nb2RlbCBmcm9tICcuLi9tb2RlbHMvUmVnaXN0cmF0aW9uJztcbmltcG9ydCBBcnRpc3RXb29Db21tZXJjZU1vZGVsIGZyb20gJy4uL21vZGVscy9BcnRpc3RXb29Db21tZXJjZSc7XG5cbmV4cG9ydCBjb25zdCBpbmRleCA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGFydGlzdFNlcnZpY2UgPSBuZXcgQXJ0aXN0U2VydmljZSgpO1xuICAgIC8vIGNvbnN0IGxpc3QgPSBhd2FpdCAgYXJ0aXN0U2VydmljZS5MaXN0KHJlcS51c2VyICYmIHJlcS51c2VyLkhhc2gsIHJlcS5hcHAuZ2V0KCdjYWNoZVNldCcpLCByZXEuYXBwLmdldCgnY2FjaGVHZXQnKSk7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIgJiYgcmVxLnVzZXIuX2lkO1xuICAgIGNvbnN0IGhhc2ggPSByZXEudXNlciAmJiByZXEudXNlci5IYXNoO1xuICAgIGxldCB0b2tlbjogc3RyaW5nID0gJyc7XG4gICAgaWYgKHJlcS51c2VyKSB7XG4gICAgICB0b2tlbiA9IHNpZ24oe1xuICAgICAgICByZWdpc3RyYXRpb25JZDogcmVxLnVzZXIuX2lkXG4gICAgICB9LCBwcm9jZXNzLmVudi5KV1RfU0VDUkVULCB7IGV4cGlyZXNJbjogcHJvY2Vzcy5lbnYuSldUX0VYUF9USU1FIHx8ICcxeScgfSk7XG4gICAgICByZXMuY29va2llKCdqd3QnLCB0b2tlbiwge1xuICAgICAgICBodHRwT25seTogdHJ1ZSxcbiAgICAgICAgc2FtZVNpdGU6IHRydWUsXG4gICAgICAgIHNpZ25lZDogdHJ1ZSxcbiAgICAgICAgc2VjdXJlOiBmYWxzZVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJlcy5yZWRpcmVjdCgzMDcsIGAke3Byb2Nlc3MuZW52LlNJVEVfVVJMfS9yZXNwL2FydGlzdHNgKTtcbiAgICByZXR1cm47XG4gICAgLypcbiAgICBjb25zdCBsaXN0ID0gYXdhaXQgYXJ0aXN0U2VydmljZS5nZXRBcnRpc3RQYWdlRGF0YSh1c2VySWQsIGhhc2gsIHJlcS5hcHAuZ2V0KCdjYWNoZVNldCcpLCByZXEuYXBwLmdldCgnY2FjaGVHZXQnKSk7XG5cbiAgICAvKnJlcy5yZW5kZXIoJ2FydGlzdF9saXN0Jywge1xuICAgICAgYXJ0aXN0TGlzdDogbGlzdCxcbiAgICAgIHRva2VuOiB0b2tlblxuICAgIH0pOyovXG4gICAgLypyZXMucmVuZGVyKCdhcnRpc3RfbGlzdF92MicsIHtcbiAgICAgIGFydGlzdExpc3Q6IGxpc3RbMF0sXG4gICAgICBmb2xsb3dpbmdBcnRpc3Q6IGxpc3RbMV0sXG4gICAgICB0b2tlbjogdG9rZW5cbiAgICB9KTsqL1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKCFlLnN0YXR1cykge1xuICAgICAgZS5zdGF0dXMgPSA1MDA7XG4gICAgfVxuICAgIGlmICghZS5tZXNzYWdlKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICBlLm1lc3NhZ2UgPSAnU2VydmVyIGVycm9yIG9jY3VycmVkISc7XG4gICAgICBlLk1lc3NhZ2UgPSBlLm1lc3NhZ2U7XG4gICAgfVxuICAgIG5leHQoZSk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBzZWFyY2ggPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBzZWFyY2hUZXJtID0gcmVxLmJvZHkuc2VhcmNoVGVybSB8fCAnJztcbiAgICAvKmNvbnN0IHNvcnRDb2wgPSByZXEuYm9keS5zb3J0Q29sIHx8ICdfaWQnO1xuICAgIGNvbnN0IHNvcnRPcmRlciA9IHJlcS5ib2R5LnNvcnRPcmRlciB8fCAtMTtcbiAgICBjb25zdCBzb3J0T2JqOiB7XG4gICAgICBba2V5OiBzdHJpbmddOiBudW1iZXI7XG4gICAgfSA9IHt9O1xuICAgIHNvcnRPYmpbc29ydENvbF0gPSBzb3J0T3JkZXI7Ki9cbiAgICBjb25zdCBhcnRpc3RTZXJ2aWNlID0gbmV3IEFydGlzdFNlcnZpY2UoKTtcbiAgICBjb25zdCByZXNwID0gYXdhaXQgYXJ0aXN0U2VydmljZS5zZWFyY2hBcnRpc3RzKHNlYXJjaFRlcm0sIHJlcS5ib2R5LmxpbWl0LFxuICAgICAgICByZXEuYm9keS5wYWdlLCByZXEuYXBwLmdldCgnY2FjaGVTZXQnKSwgcmVxLmFwcC5nZXQoJ2NhY2hlR2V0JykpO1xuICAgIHJlcy5qc29uKHJlc3ApO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbmV4dChlKTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGF1dG9TdWdnZXN0ID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3Qgc2VhcmNoVGVybSA9IHJlcS5xdWVyeS5xIHx8ICcnO1xuICAgIGNvbnN0IG9yOiBhbnlbXSA9IFtcbiAgICAgIHtcbiAgICAgICAgJHRleHQ6IHtcbiAgICAgICAgICAkc2VhcmNoOiBzZWFyY2hUZXJtLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgRW1haWw6IHNlYXJjaFRlcm1cbiAgICAgIH1cbiAgICBdO1xuICAgIGNvbnN0IGVudHJ5SWQgPSBwYXJzZUludChzZWFyY2hUZXJtKTtcbiAgICBpZiAoIWlzTmFOKGVudHJ5SWQpKSB7XG4gICAgICBvci5wdXNoKHtcbiAgICAgICAgRW50cnlJZDogZW50cnlJZFxuICAgICAgfSk7XG4gICAgfVxuICAgIGxldCBxdWVyeToge1xuICAgICAgSXNEdXBsaWNhdGU/OiB7XG4gICAgICAgICRpbjogYW55W107XG4gICAgICB9O1xuICAgICAgRW50cnlJZD86IHskZXhpc3RzOiBib29sZWFufTtcbiAgICAgICRvcj86IGFueVtdO1xuICAgIH0gPSB7fTtcbiAgICBpZiAoc2VhcmNoVGVybS5sZW5ndGggPiAwKSB7XG4gICAgICBxdWVyeSA9IHtcbiAgICAgICAgJG9yOiBvclxuICAgICAgfTtcbiAgICB9XG4gICAgcXVlcnkuSXNEdXBsaWNhdGUgPSB7JGluOiBbbnVsbCwgZmFsc2VdfTtcbiAgICBxdWVyeS5FbnRyeUlkID0geyRleGlzdHM6IHRydWV9O1xuICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgQ29udGVzdGFudE1vZGVsLmZpbmQocXVlcnksIHsgc2NvcmU6IHsgJG1ldGE6ICd0ZXh0U2NvcmUnIH0gfSlcbiAgICAgICAgLnNlbGVjdChbJ19pZCcsICdOYW1lJywgJ0VudHJ5SWQnXSlcbiAgICAgICAgLnNvcnQoeyBzY29yZTogeyAkbWV0YTogJ3RleHRTY29yZScgfSB9KVxuICAgICAgICAvLyAubGltaXQocmVxLnF1ZXJ5LmxpbWl0KVxuICAgICAgICAvLyAuc2tpcCgocmVxLnF1ZXJ5LnBhZ2UgLSAxKSAqIDEwKVxuICAgICAgLFxuICAgIF0pO1xuICAgIGNvbnN0IGNvbnRlc3RhbnRzID0gcmVzdWx0c1swXTtcbiAgICBjb25zdCByZXNwOiBEYXRhT3BlcmF0aW9uUmVzdWx0PHtcbiAgICAgIENvbnRlc3RhbnRzOiBDb250ZXN0YW50RFRPW107XG4gICAgfT4gPSB7XG4gICAgICBTdWNjZXNzOiB0cnVlLFxuICAgICAgRGF0YToge1xuICAgICAgICBDb250ZXN0YW50czogY29udGVzdGFudHMsXG4gICAgICB9XG4gICAgfTtcbiAgICByZXMuanNvbihyZXNwKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIG5leHQoZSk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBnZXQgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBjb250ZXN0YW50SWQgPSByZXEucGFyYW1zLmNvbnRlc3RhbnRJZDtcbiAgICBpZiAoIWNvbnRlc3RhbnRJZCkge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGBjb250ZXN0YW50IElkIGlzIHJlcXVpcmVkYDtcbiAgICAgIGxvZ2dlci5lcnJvcihtZXNzYWdlKTtcbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgU3VjY2VzczogZmFsc2UsXG4gICAgICAgIHN0YXR1czogNDAzLFxuICAgICAgICBtZXNzYWdlOiBtZXNzYWdlXG4gICAgICB9KTtcbiAgICAgIHJldHVybiA7XG4gICAgfVxuICAgIGNvbnN0IGNvbnRlc3RhbnQgPSBhd2FpdCBDb250ZXN0YW50TW9kZWwuZmluZEJ5SWQoY29udGVzdGFudElkKS5wb3B1bGF0ZSgnUmVnaXN0cmF0aW9uJyk7XG4gICAgaWYgKCFjb250ZXN0YW50KSB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gYEludmFsaWQgY29udGVzdGFudCBJZCBwYXNzZWQgJHtjb250ZXN0YW50SWR9YDtcbiAgICAgIGxvZ2dlci5lcnJvcihtZXNzYWdlKTtcbiAgICAgIHJlcy5qc29uKHtcbiAgICAgICAgU3VjY2VzczogZmFsc2UsXG4gICAgICAgIHN0YXR1czogNDA0LFxuICAgICAgICBtZXNzYWdlOiBtZXNzYWdlXG4gICAgICB9KTtcbiAgICAgIHJldHVybiA7XG4gICAgfVxuICAgIGNvbnN0IHJlc3A6IERhdGFPcGVyYXRpb25SZXN1bHQ8Q29udGVzdGFudERUTz4gPSB7XG4gICAgICBTdWNjZXNzOiB0cnVlLFxuICAgICAgRGF0YTogY29udGVzdGFudFxuICAgIH07XG4gICAgcmVzLmpzb24ocmVzcCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoIWUuc3RhdHVzKSB7XG4gICAgICBlLnN0YXR1cyA9IDUwMDtcbiAgICB9XG4gICAgaWYgKCFlLm1lc3NhZ2UpIHtcbiAgICAgIGUubWVzc2FnZSA9ICdTZXJ2ZXIgZXJyb3Igb2NjdXJyZWQhJztcbiAgICB9XG4gICAgbmV4dChlKTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IHVwZGF0ZSA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGFydGlzdFNlcnZpY2UgPSBuZXcgQXJ0aXN0U2VydmljZSgpO1xuICAgIGNvbnN0IGNvbnRlc3RhbnRJZCA9IHJlcS5wYXJhbXMuY29udGVzdGFudElkO1xuICAgIGNvbnN0IGNvbnRlc3RhbnQgPSBhd2FpdCBhcnRpc3RTZXJ2aWNlLlVwZGF0ZShjb250ZXN0YW50SWQsIHJlcS5ib2R5LCByZXEuaGVhZGVyKCd1c2VyLWFnZW50JykpO1xuICAgIGNvbnN0IHJlc3A6IERhdGFPcGVyYXRpb25SZXN1bHQ8Q29udGVzdGFudERUTz4gPSB7XG4gICAgICBTdWNjZXNzOiB0cnVlLFxuICAgICAgRGF0YTogY29udGVzdGFudFxuICAgIH07XG4gICAgcmVzLmpzb24ocmVzcCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoIWUuc3RhdHVzKSB7XG4gICAgICBlLnN0YXR1cyA9IDUwMDtcbiAgICB9XG4gICAgaWYgKCFlLm1lc3NhZ2UpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgIGUubWVzc2FnZSA9ICdTZXJ2ZXIgZXJyb3Igb2NjdXJyZWQhJztcbiAgICB9XG4gICAgbmV4dChlKTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZSA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGFydGlzdFNlcnZpY2UgPSBuZXcgQXJ0aXN0U2VydmljZSgpO1xuICAgIGNvbnN0IGNvbnRlc3RhbnQgPSBhd2FpdCBhcnRpc3RTZXJ2aWNlLkFkZChyZXEuYm9keSwgcmVxLmhlYWRlcigndXNlci1hZ2VudCcpKTtcbiAgICBjb25zdCByZXNwOiBEYXRhT3BlcmF0aW9uUmVzdWx0PENvbnRlc3RhbnREVE8+ID0ge1xuICAgICAgU3VjY2VzczogdHJ1ZSxcbiAgICAgIERhdGE6IGNvbnRlc3RhbnRcbiAgICB9O1xuICAgIHJlcy5qc29uKHJlc3ApO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbmV4dChlKTtcbiAgfVxufTtcblxuZXhwb3J0IGNvbnN0IGFydGlzdFB1YmxpY1Byb2ZpbGUgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBhcnRpc3RTZXJ2aWNlID0gbmV3IEFydGlzdFNlcnZpY2UoKTtcbiAgICBjb25zdCBoYXNoID0gcmVxLnBhcmFtcy5oYXNoO1xuICAgIGxldCByZWdJZDtcbiAgICBsZXQgcGhvbmVOdW1iZXI7XG4gICAgaWYgKGhhc2gpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFJlZ2lzdHJhdGlvbk1vZGVsLmZpbmRPbmUoe0hhc2g6IGhhc2h9KTtcbiAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgcmVnSWQgPSByZXN1bHQuX2lkO1xuICAgICAgICBwaG9uZU51bWJlciA9IHJlc3VsdC5QaG9uZU51bWJlcjtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIgJiYgcmVxLnVzZXIuX2lkIHx8IHJlZ0lkO1xuICAgIHBob25lTnVtYmVyID0gcGhvbmVOdW1iZXIgfHwgcmVxLnVzZXIgJiYgcmVxLnVzZXIuUGhvbmVOdW1iZXI7XG4gICAgY29uc3QgYXJ0aXN0UHJvZmlsZSA9IGF3YWl0IGFydGlzdFNlcnZpY2UuY2FjaGVkQXJ0aXN0UHJvZmlsZShyZXEuYXBwLmdldCgnY2FjaGVTZXQnKSwgcmVxLmFwcC5nZXQoJ2NhY2hlR2V0JyksXG4gICAgICAgIHJlcS5wYXJhbXMuY29udGVzdGFudElkLCB1c2VySWQsIHBob25lTnVtYmVyKTtcbiAgICBsZXQgdG9rZW46IHN0cmluZztcbiAgICBpZiAocmVxLnVzZXIpIHtcbiAgICAgIC8vIHNldCBjb29raWUgb25seSBmb3IgdGhvc2Ugd2hvIG9wZW5lZCBpbiBicm93c2VyLlxuICAgICAgLy8gZHVwIHRva2VuIGNhbGN1bGF0aW9uIGJlY2F1c2Ugd2UgYXJlIHRhcmdldGluZyBjb29raWUgYmFzZWQgcmVxLnVzZXIgaGVyZVxuICAgICAgdG9rZW4gPSBzaWduKHtcbiAgICAgICAgcmVnaXN0cmF0aW9uSWQ6IHVzZXJJZFxuICAgICAgfSwgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCwgeyBleHBpcmVzSW46IHByb2Nlc3MuZW52LkpXVF9FWFBfVElNRSB8fCAnMXknIH0pO1xuICAgIH1cbiAgICBsZXQgYXJ0aXN0UHJvZmlsZUpzb24gPSBKU09OLnN0cmluZ2lmeShhcnRpc3RQcm9maWxlKTtcbiAgICBhcnRpc3RQcm9maWxlSnNvbiA9IGFydGlzdFByb2ZpbGVKc29uLnJlcGxhY2UoL1tcXFxcXS9nLCAnXFxcXFxcXFwnKVxuICAgICAgICAucmVwbGFjZSgvW1xcXCJdL2csICdcXFxcXFxcIicpXG4gICAgICAgIC5yZXBsYWNlKC9bXFwvXS9nLCAnXFxcXC8nKVxuICAgICAgICAucmVwbGFjZSgvW1xcYl0vZywgJ1xcXFxiJylcbiAgICAgICAgLnJlcGxhY2UoL1tcXGZdL2csICdcXFxcZicpXG4gICAgICAgIC5yZXBsYWNlKC9bXFxuXS9nLCAnXFxcXG4nKVxuICAgICAgICAucmVwbGFjZSgvW1xccl0vZywgJ1xcXFxyJylcbiAgICAgICAgLnJlcGxhY2UoL1tcXHRdL2csICdcXFxcdCcpO1xuICAgIHJlcy5yZW5kZXIoJ2FydGlzdF9wdWJsaWNfcHJvZmlsZScsIHtcbiAgICAgIHRva2VuOiB0b2tlbixcbiAgICAgIGFydGlzdElkOiByZXEucGFyYW1zLmNvbnRlc3RhbnRJZCxcbiAgICAgIGFydGlzdFByb2ZpbGU6IGFydGlzdFByb2ZpbGUsXG4gICAgICBhcnRpc3RQcm9maWxlSnNvbjogYXJ0aXN0UHJvZmlsZUpzb24sXG4gICAgICBwaG9uZUhhc2g6IGhhc2gsXG4gICAgICB0aXRsZTogYXJ0aXN0UHJvZmlsZS5OYW1lXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBuZXh0KGUpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgZm9sbG93ID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgaGFzaCA9IHJlcS5wYXJhbXMuaGFzaDtcbiAgICBsZXQgcmVnSWQ7XG4gICAgaWYgKGhhc2gpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFJlZ2lzdHJhdGlvbk1vZGVsLmZpbmRPbmUoe0hhc2g6IGhhc2h9KTtcbiAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgcmVnSWQgPSByZXN1bHQuX2lkO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlciAmJiByZXEudXNlci5faWQgfHwgcmVnSWQ7XG4gICAgY29uc3QgYXJ0aXN0U2VydmljZSA9IG5ldyBBcnRpc3RTZXJ2aWNlKCk7XG4gICAgY29uc3QgY29udGVzdGFudElkID0gcmVxLnBhcmFtcy5jb250ZXN0YW50SWQ7XG4gICAgYXdhaXQgYXJ0aXN0U2VydmljZS5Gb2xsb3coY29udGVzdGFudElkLCB1c2VySWQsIHJlcS5ib2R5LklzRm9sbG93aW5nKTtcbiAgICBjb25zdCByZXNwOiBEYXRhT3BlcmF0aW9uUmVzdWx0PHN0cmluZz4gPSB7XG4gICAgICBTdWNjZXNzOiB0cnVlLFxuICAgICAgRGF0YTogJ1N1Y2Nlc3MnXG4gICAgfTtcbiAgICByZXMuanNvbihyZXNwKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmICghZS5zdGF0dXMpIHtcbiAgICAgIGUuc3RhdHVzID0gNTAwO1xuICAgIH1cbiAgICBpZiAoIWUubWVzc2FnZSkge1xuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgZS5tZXNzYWdlID0gJ1NlcnZlciBlcnJvciBvY2N1cnJlZCEnO1xuICAgIH1cbiAgICBuZXh0KGUpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgcmVkaXJlY3RlZFRvSW50ZXJuYWwgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgdHJ5IHtcbiAgICBpZiAocmVxLnBhcmFtcy5lbnRyeUlkKSB7XG4gICAgICBjb25zdCBjb250ZXN0YW50ID0gYXdhaXQgQ29udGVzdGFudE1vZGVsLmZpbmRPbmUoe0VudHJ5SWQ6IHJlcS5wYXJhbXMuZW50cnlJZH0pLnNlbGVjdChbJ19pZCddKTtcbiAgICAgIGlmIChjb250ZXN0YW50KSB7XG4gICAgICAgIHJlcy5yZWRpcmVjdChgJHtwcm9jZXNzLmVudi5TSVRFX1VSTH0vYXIvJHtjb250ZXN0YW50Ll9pZH0vJHtyZXEucGFyYW1zLmhhc2ggfHwgJyd9YCk7XG4gICAgICAgIHJldHVybiA7XG4gICAgICB9XG4gICAgfVxuICAgIG5leHQoe1xuICAgICAgU3VjY2VzczogZmFsc2UsXG4gICAgICBzdGF0dXM6IDQwNCxcbiAgICAgIE1lc3NhZ2U6ICdFbnRyeSBJZCBub3QgZm91bmQnXG4gICAgfSk7XG4gICAgcmV0dXJuIDtcbiAgfSBjYXRjaCAoZSkge1xuICAgIG5leHQoZSk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBhZGRWaWRlbyA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGFydGlzdElkID0gcmVxLnBhcmFtcy5hcnRpc3RJZDtcbiAgICBjb25zdCB2aWRlb1VybCA9IHJlcS5ib2R5LlVSTDtcbiAgICBhd2FpdCBDb250ZXN0YW50TW9kZWwudXBkYXRlKFxuICAgICAgICB7X2lkOiBhcnRpc3RJZH0sXG4gICAgeyAkcHVzaDogeyBWaWRlb3M6IHZpZGVvVXJsIH0gfVxuICAgICk7XG4gICAgY29uc3QgcmVzcDogRGF0YU9wZXJhdGlvblJlc3VsdDxzdHJpbmc+ID0ge1xuICAgICAgU3VjY2VzczogdHJ1ZSxcbiAgICAgIERhdGE6ICdTdWNjZXNzJ1xuICAgIH07XG4gICAgcmVzLmpzb24ocmVzcCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBuZXh0KGUpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3Qgd29vTGlzdCA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHNlYXJjaFRlcm0gPSByZXEuYm9keS5zZWFyY2hUZXJtIHx8ICcnO1xuICAgIC8qY29uc3Qgc29ydENvbCA9IHJlcS5ib2R5LnNvcnRDb2wgfHwgJ19pZCc7XG4gICAgY29uc3Qgc29ydE9yZGVyID0gcmVxLmJvZHkuc29ydE9yZGVyIHx8IC0xO1xuICAgIGNvbnN0IHNvcnRPYmo6IHtcbiAgICAgIFtrZXk6IHN0cmluZ106IG51bWJlcjtcbiAgICB9ID0ge307XG4gICAgc29ydE9ialtzb3J0Q29sXSA9IHNvcnRPcmRlcjsqL1xuICAgIGNvbnN0IGFydGlzdFNlcnZpY2UgPSBuZXcgQXJ0aXN0U2VydmljZSgpO1xuICAgIGNvbnN0IHJlc3AgPSBhd2FpdCBhcnRpc3RTZXJ2aWNlLmdldFByb2R1Y3RzKHNlYXJjaFRlcm0sIHJlcS5ib2R5LmxpbWl0LCByZXEuYm9keS5wYWdlKTtcbiAgICByZXMuanNvbihyZXNwKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIG5leHQoZSk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCBzYXZlUHJvZHVjdCA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHBheWxvYWQ6IHtcbiAgICAgIFByb2R1Y3RJZDogc3RyaW5nO1xuICAgICAgQ29uZmlybWF0aW9uOiBzdHJpbmc7XG4gICAgICBDb250ZXN0YW50SWQ6IGFueTtcbiAgICB9ID0gcmVxLmJvZHk7XG4gICAgY29uc3QgcHJvZHVjdCA9IGF3YWl0IEFydGlzdFdvb0NvbW1lcmNlTW9kZWwuZmluZE9uZSh7UHJvZHVjdElkOiBwYXlsb2FkLlByb2R1Y3RJZH0pO1xuICAgIGNvbnN0IGFydGlzdFNlcnZpY2UgPSBuZXcgQXJ0aXN0U2VydmljZSgpO1xuICAgIGlmIChwcm9kdWN0KSB7XG4gICAgICByZXMuanNvbihhd2FpdCBhcnRpc3RTZXJ2aWNlLnVwZGF0ZVByb2R1Y3QocGF5bG9hZCwgcHJvZHVjdCwgcmVxLmFwcC5nZXQoJ2NhY2hlU2V0JyksIHJlcS5hcHAuZ2V0KCdjYWNoZUdldCcpKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcy5qc29uKGF3YWl0IGFydGlzdFNlcnZpY2UuYWRkUHJvZHVjdChwYXlsb2FkLCByZXEuYXBwLmdldCgnY2FjaGVTZXQnKSwgcmVxLmFwcC5nZXQoJ2NhY2hlR2V0JykpKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBuZXh0KGUpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3QgZGVsZXRlUHJvZHVjdCA9IGFzeW5jIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IGFydGlzdFNlcnZpY2UgPSBuZXcgQXJ0aXN0U2VydmljZSgpO1xuICAgIGF3YWl0IGFydGlzdFNlcnZpY2UucmVtb3ZlUHJvZHVjdChyZXEucGFyYW1zLnByb2R1Y3RJZCwgcmVxLmFwcC5nZXQoJ2NhY2hlU2V0JyksIHJlcS5hcHAuZ2V0KCdjYWNoZUdldCcpKTtcbiAgICBjb25zdCByZXNwOiBEYXRhT3BlcmF0aW9uUmVzdWx0PHN0cmluZz4gPSB7XG4gICAgICBTdWNjZXNzOiB0cnVlLFxuICAgICAgRGF0YTogJ1N1Y2Nlc3MnXG4gICAgfTtcbiAgICByZXMuanNvbihyZXNwKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIG5leHQoZSk7XG4gIH1cbn07XG5cbmV4cG9ydCBjb25zdCByZWZyZXNoUHJvZHVjdENhY2hlID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgYXJ0aXN0U2VydmljZSA9IG5ldyBBcnRpc3RTZXJ2aWNlKCk7XG4gICAgYXdhaXQgYXJ0aXN0U2VydmljZS51cGRhdGVQcm9kdWN0Q2FjaGUocmVxLnBhcmFtcy5wcm9kdWN0SWQsIHJlcS5hcHAuZ2V0KCdjYWNoZVNldCcpLCByZXEuYXBwLmdldCgnY2FjaGVHZXQnKSk7XG4gICAgY29uc3QgcmVzcDogRGF0YU9wZXJhdGlvblJlc3VsdDxzdHJpbmc+ID0ge1xuICAgICAgU3VjY2VzczogdHJ1ZSxcbiAgICAgIERhdGE6ICdTdWNjZXNzJ1xuICAgIH07XG4gICAgcmVzLmpzb24ocmVzcCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBuZXh0KGUpO1xuICB9XG59OyJdfQ==
