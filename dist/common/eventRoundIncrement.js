"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EventIncrementRound = void 0;
const Event_1 = require("../models/Event");
const logger_1 = require("../config/logger");
const User_1 = require("../models/User");
const Slack_1 = require("./Slack");
exports.EventIncrementRound = async function (req, eventId, userId) {
    let event;
    event = await Event_1.default.findById(eventId);
    if (event.CurrentRound) { // if a round is running, complete it
        logger_1.default.info(`Closing round ${event.CurrentRound.RoundNumber}`);
        const currentRound = event.Rounds
            .find(r => r.RoundNumber == event.CurrentRound.RoundNumber);
        currentRound.IsFinished = true;
        // currentRound.Contestants = event.CurrentRound.Contestants;
        let totalVotes = 0;
        for (let i = 0; i < event.CurrentRound.Contestants.length; i++) {
            currentRound.Contestants[i].Enabled = event.CurrentRound.Contestants[i].Enabled;
            currentRound.Contestants[i].EaselNumber = event.CurrentRound.Contestants[i].EaselNumber;
            totalVotes += currentRound.Contestants[i].Votes.length;
        }
        event.CurrentRound = null;
        const user = await User_1.default.findById(userId);
        const message = `${event.Name}, Round ${currentRound.RoundNumber} is closed by ${user && user.email}, votes ${totalVotes}`;
        event.Logs.push({
            Message: message,
            CreatedDate: new Date()
        });
        const result = await event.save();
        const operationResult = {
            Success: true,
            Data: result
        };
        // send message to slack channel
        Slack_1.default({
            'text': message
        }).catch(() => logger_1.default.info('close round slack call failed, message was ', message));
        return operationResult;
    }
    else {
        const availableRounds = event.Rounds.filter(r => !r.IsFinished);
        if (availableRounds.length > 0) { // if there are any rounds left, start the next one
            const nextRound = availableRounds.reduce((prev, cur) => {
                return prev.RoundNumber < cur.RoundNumber ? prev : cur;
            });
            logger_1.default.info(`Starting round ${nextRound.RoundNumber}`);
            event.CurrentRound = nextRound;
            // After sending response send message to slack channel
            const user = await User_1.default.findById(userId);
            const message = `${event.Name}, Round ${nextRound.RoundNumber} is started by ${user && user.email}, registered: ${event.Registrations.length}`;
            event.Logs.push({
                Message: message,
                CreatedDate: new Date()
            });
            const result = await event.save();
            /*await EventModel.findOneAndUpdate({
                _id: event._id
            }, event);

            const  result = await EventModel.findOne({
                _id: event._id
            });*/
            const operationResult = {
                Success: true,
                Data: result
            };
            Slack_1.default({
                'text': message
            }).catch(() => logger_1.default.info('starting round slack call failed, message was ', message));
            const cacheKey = `app-event-list-`;
            const cacheDel = req.app.get('cacheDel');
            const cacheDelPromises = [];
            cacheDelPromises.push(cacheDel(`${cacheKey}${eventId}`));
            cacheDelPromises.push(cacheDel(cacheKey));
            await Promise.all(cacheDelPromises);
            return operationResult;
        }
        else { // loop if all rounds are finished.
            logger_1.default.info('Attempted to increment round on finished event. Looping rounds.');
            event.Rounds.forEach(r => r.IsFinished = false);
            event.CurrentRound = null;
            const user = await User_1.default.findById(userId);
            const message = `${event.Name} is finished but round is being started by ${user && user.email}`;
            event.Logs.push({
                Message: message,
                CreatedDate: new Date()
            });
            const result = await event.save();
            const operationResult = {
                Success: true,
                Data: result
            };
            // After sending response send message to slack channel
            Slack_1.default({
                'text': message
            }).catch(() => logger_1.default.info(' finish event, attempt to increment round call failed ', message));
            return operationResult;
            // logger.info('Attempted to increment round on finished event.');
            // const operationResult: OperationResult = {
            //     Success: false
            // };
            // res.json(operationResult);
        }
    }
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbW1vbi9ldmVudFJvdW5kSW5jcmVtZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDJDQUF1RTtBQUN2RSw2Q0FBc0M7QUFDdEMseUNBQStEO0FBRy9ELG1DQUFrQztBQUdyQixRQUFBLG1CQUFtQixHQUFHLEtBQUssV0FBVyxHQUFZLEVBQUUsT0FBZSxFQUFFLE1BQWM7SUFDNUYsSUFBSSxLQUFvQixDQUFDO0lBRXJCLEtBQUssR0FBRyxNQUFNLGVBQVUsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDM0MsSUFBSSxLQUFLLENBQUMsWUFBWSxFQUFFLEVBQUUscUNBQXFDO1FBRTNELGdCQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixLQUFLLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFFL0QsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLE1BQU07YUFDNUIsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsSUFBSSxLQUFLLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2hFLFlBQVksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQy9CLDZEQUE2RDtRQUM3RCxJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUM7UUFDbkIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUM1RCxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFDaEYsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FB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RyxFQUFFLENBQUMsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsd0RBQXdELEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUMvRixPQUFPLGVBQWUsQ0FBQztZQUN2QixrRUFBa0U7WUFDbEUsNkNBQTZDO1lBQzdDLHFCQUFxQjtZQUNyQixLQUFLO1lBQ0wsNkJBQTZCO1NBQ2hDO0tBQ0o7QUFFVCxDQUFDLENBQUMiLCJmaWxlIjoiY29tbW9uL2V2ZW50Um91bmRJbmNyZW1lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkZWZhdWx0IGFzIEV2ZW50TW9kZWwsIEV2ZW50RG9jdW1lbnQgfSBmcm9tICcuLi9tb2RlbHMvRXZlbnQnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9jb25maWcvbG9nZ2VyJztcbmltcG9ydCB7IGRlZmF1bHQgYXMgVXNlciwgVXNlckRvY3VtZW50IH0gZnJvbSAnLi4vbW9kZWxzL1VzZXInO1xuaW1wb3J0IHsgRGF0YU9wZXJhdGlvblJlc3VsdCB9IGZyb20gJy4uLy4uLy4uL3NoYXJlZC9PcGVyYXRpb25SZXN1bHQnO1xuaW1wb3J0IHsgRXZlbnREVE8gfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvRXZlbnREVE8nO1xuaW1wb3J0IHBvc3RUb1NsYWNrIGZyb20gJy4vU2xhY2snO1xuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuXG5leHBvcnQgY29uc3QgRXZlbnRJbmNyZW1lbnRSb3VuZCA9IGFzeW5jIGZ1bmN0aW9uIChyZXE6IFJlcXVlc3QsIGV2ZW50SWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpIHtcbiAgICBsZXQgZXZlbnQ6IEV2ZW50RG9jdW1lbnQ7XG5cbiAgICAgICAgZXZlbnQgPSBhd2FpdCBFdmVudE1vZGVsLmZpbmRCeUlkKGV2ZW50SWQpO1xuICAgICAgICBpZiAoZXZlbnQuQ3VycmVudFJvdW5kKSB7IC8vIGlmIGEgcm91bmQgaXMgcnVubmluZywgY29tcGxldGUgaXRcblxuICAgICAgICAgICAgbG9nZ2VyLmluZm8oYENsb3Npbmcgcm91bmQgJHtldmVudC5DdXJyZW50Um91bmQuUm91bmROdW1iZXJ9YCk7XG5cbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRSb3VuZCA9IGV2ZW50LlJvdW5kc1xuICAgICAgICAgICAgICAgIC5maW5kKHIgPT4gci5Sb3VuZE51bWJlciA9PSBldmVudC5DdXJyZW50Um91bmQuUm91bmROdW1iZXIpO1xuICAgICAgICAgICAgY3VycmVudFJvdW5kLklzRmluaXNoZWQgPSB0cnVlO1xuICAgICAgICAgICAgLy8gY3VycmVudFJvdW5kLkNvbnRlc3RhbnRzID0gZXZlbnQuQ3VycmVudFJvdW5kLkNvbnRlc3RhbnRzO1xuICAgICAgICAgICAgbGV0IHRvdGFsVm90ZXMgPSAwO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBldmVudC5DdXJyZW50Um91bmQuQ29udGVzdGFudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50Um91bmQuQ29udGVzdGFudHNbaV0uRW5hYmxlZCA9IGV2ZW50LkN1cnJlbnRSb3VuZC5Db250ZXN0YW50c1tpXS5FbmFibGVkO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRSb3VuZC5Db250ZXN0YW50c1tpXS5FYXNlbE51bWJlciA9IGV2ZW50LkN1cnJlbnRSb3VuZC5Db250ZXN0YW50c1tpXS5FYXNlbE51bWJlcjtcbiAgICAgICAgICAgICAgICB0b3RhbFZvdGVzICs9IGN1cnJlbnRSb3VuZC5Db250ZXN0YW50c1tpXS5Wb3Rlcy5sZW5ndGg7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGV2ZW50LkN1cnJlbnRSb3VuZCA9IG51bGw7XG4gICAgICAgICAgICBjb25zdCB1c2VyOiBVc2VyRG9jdW1lbnQgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHVzZXJJZCk7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYCR7ZXZlbnQuTmFtZX0sIFJvdW5kICR7Y3VycmVudFJvdW5kLlJvdW5kTnVtYmVyfSBpcyBjbG9zZWQgYnkgJHt1c2VyICYmIHVzZXIuZW1haWx9LCB2b3RlcyAke3RvdGFsVm90ZXN9YDtcbiAgICAgICAgICAgIGV2ZW50LkxvZ3MucHVzaCh7XG4gICAgICAgICAgICAgICAgTWVzc2FnZTogbWVzc2FnZSxcbiAgICAgICAgICAgICAgICBDcmVhdGVkRGF0ZTogbmV3IERhdGUoKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBldmVudC5zYXZlKCk7XG4gICAgICAgICAgICBjb25zdCBvcGVyYXRpb25SZXN1bHQ6IERhdGFPcGVyYXRpb25SZXN1bHQ8RXZlbnREVE8+ID0ge1xuICAgICAgICAgICAgICAgIFN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICAgICAgRGF0YTogcmVzdWx0XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgLy8gc2VuZCBtZXNzYWdlIHRvIHNsYWNrIGNoYW5uZWxcbiAgICAgICAgICAgIHBvc3RUb1NsYWNrKHtcbiAgICAgICAgICAgICAgICAndGV4dCc6IG1lc3NhZ2VcbiAgICAgICAgICAgIH0pLmNhdGNoKCgpID0+IGxvZ2dlci5pbmZvKCdjbG9zZSByb3VuZCBzbGFjayBjYWxsIGZhaWxlZCwgbWVzc2FnZSB3YXMgJywgbWVzc2FnZSkpO1xuXG4gICAgICAgICAgICByZXR1cm4gb3BlcmF0aW9uUmVzdWx0O1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgYXZhaWxhYmxlUm91bmRzID0gZXZlbnQuUm91bmRzLmZpbHRlcihyID0+ICFyLklzRmluaXNoZWQpO1xuICAgICAgICAgICAgaWYgKGF2YWlsYWJsZVJvdW5kcy5sZW5ndGggPiAwKSB7IC8vIGlmIHRoZXJlIGFyZSBhbnkgcm91bmRzIGxlZnQsIHN0YXJ0IHRoZSBuZXh0IG9uZVxuICAgICAgICAgICAgICAgIGNvbnN0IG5leHRSb3VuZCA9IGF2YWlsYWJsZVJvdW5kcy5yZWR1Y2UoKHByZXYsIGN1cikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJldi5Sb3VuZE51bWJlciA8IGN1ci5Sb3VuZE51bWJlciA/IHByZXYgOiBjdXI7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhgU3RhcnRpbmcgcm91bmQgJHtuZXh0Um91bmQuUm91bmROdW1iZXJ9YCk7XG5cbiAgICAgICAgICAgICAgICBldmVudC5DdXJyZW50Um91bmQgPSBuZXh0Um91bmQ7XG4gICAgICAgICAgICAgICAgLy8gQWZ0ZXIgc2VuZGluZyByZXNwb25zZSBzZW5kIG1lc3NhZ2UgdG8gc2xhY2sgY2hhbm5lbFxuICAgICAgICAgICAgICAgIGNvbnN0IHVzZXI6IFVzZXJEb2N1bWVudCA9IGF3YWl0IFVzZXIuZmluZEJ5SWQodXNlcklkKTtcbiAgICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYCR7ZXZlbnQuTmFtZX0sIFJvdW5kICR7bmV4dFJvdW5kLlJvdW5kTnVtYmVyfSBpcyBzdGFydGVkIGJ5ICR7dXNlciAmJiB1c2VyLmVtYWlsfSwgcmVnaXN0ZXJlZDogJHtldmVudC5SZWdpc3RyYXRpb25zLmxlbmd0aH1gO1xuICAgICAgICAgICAgICAgIGV2ZW50LkxvZ3MucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIE1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgIENyZWF0ZWREYXRlOiBuZXcgRGF0ZSgpXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBldmVudC5zYXZlKCk7XG4gICAgICAgICAgICAgICAgLyphd2FpdCBFdmVudE1vZGVsLmZpbmRPbmVBbmRVcGRhdGUoe1xuICAgICAgICAgICAgICAgICAgICBfaWQ6IGV2ZW50Ll9pZFxuICAgICAgICAgICAgICAgIH0sIGV2ZW50KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0ICByZXN1bHQgPSBhd2FpdCBFdmVudE1vZGVsLmZpbmRPbmUoe1xuICAgICAgICAgICAgICAgICAgICBfaWQ6IGV2ZW50Ll9pZFxuICAgICAgICAgICAgICAgIH0pOyovXG4gICAgICAgICAgICAgICAgY29uc3Qgb3BlcmF0aW9uUmVzdWx0OiBEYXRhT3BlcmF0aW9uUmVzdWx0PEV2ZW50RFRPPiA9IHtcbiAgICAgICAgICAgICAgICAgICAgU3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgRGF0YTogcmVzdWx0XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIHBvc3RUb1NsYWNrKHtcbiAgICAgICAgICAgICAgICAgICAgJ3RleHQnOiBtZXNzYWdlXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goKCkgPT4gbG9nZ2VyLmluZm8oJ3N0YXJ0aW5nIHJvdW5kIHNsYWNrIGNhbGwgZmFpbGVkLCBtZXNzYWdlIHdhcyAnLCBtZXNzYWdlKSk7XG4gICAgICAgICAgICAgICAgY29uc3QgY2FjaGVLZXkgPSBgYXBwLWV2ZW50LWxpc3QtYDtcbiAgICAgICAgICAgICAgICBjb25zdCBjYWNoZURlbCA9IHJlcS5hcHAuZ2V0KCdjYWNoZURlbCcpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGNhY2hlRGVsUHJvbWlzZXMgPSBbXTtcbiAgICAgICAgICAgICAgICBjYWNoZURlbFByb21pc2VzLnB1c2goY2FjaGVEZWwoYCR7Y2FjaGVLZXl9JHtldmVudElkfWApKTtcbiAgICAgICAgICAgICAgICBjYWNoZURlbFByb21pc2VzLnB1c2goY2FjaGVEZWwoY2FjaGVLZXkpKTtcbiAgICAgICAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChjYWNoZURlbFByb21pc2VzKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gb3BlcmF0aW9uUmVzdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7IC8vIGxvb3AgaWYgYWxsIHJvdW5kcyBhcmUgZmluaXNoZWQuXG4gICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oJ0F0dGVtcHRlZCB0byBpbmNyZW1lbnQgcm91bmQgb24gZmluaXNoZWQgZXZlbnQuIExvb3Bpbmcgcm91bmRzLicpO1xuXG4gICAgICAgICAgICAgICAgZXZlbnQuUm91bmRzLmZvckVhY2gociA9PiByLklzRmluaXNoZWQgPSBmYWxzZSk7XG4gICAgICAgICAgICAgICAgZXZlbnQuQ3VycmVudFJvdW5kID0gbnVsbDtcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VyOiBVc2VyRG9jdW1lbnQgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHVzZXJJZCk7XG4gICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGAke2V2ZW50Lk5hbWV9IGlzIGZpbmlzaGVkIGJ1dCByb3VuZCBpcyBiZWluZyBzdGFydGVkIGJ5ICR7dXNlciAmJiB1c2VyLmVtYWlsfWA7XG4gICAgICAgICAgICAgICAgZXZlbnQuTG9ncy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgTWVzc2FnZTogbWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgQ3JlYXRlZERhdGU6IG5ldyBEYXRlKClcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBldmVudC5zYXZlKCk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBvcGVyYXRpb25SZXN1bHQ6IERhdGFPcGVyYXRpb25SZXN1bHQ8RXZlbnREVE8+ID0ge1xuICAgICAgICAgICAgICAgICAgICBTdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBEYXRhOiByZXN1bHRcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIC8vIEFmdGVyIHNlbmRpbmcgcmVzcG9uc2Ugc2VuZCBtZXNzYWdlIHRvIHNsYWNrIGNoYW5uZWxcbiAgICAgICAgICAgICAgICBwb3N0VG9TbGFjayh7XG4gICAgICAgICAgICAgICAgICAgICd0ZXh0JzogbWVzc2FnZVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKCgpID0+IGxvZ2dlci5pbmZvKCcgZmluaXNoIGV2ZW50LCBhdHRlbXB0IHRvIGluY3JlbWVudCByb3VuZCBjYWxsIGZhaWxlZCAnLCBtZXNzYWdlKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9wZXJhdGlvblJlc3VsdDtcbiAgICAgICAgICAgICAgICAvLyBsb2dnZXIuaW5mbygnQXR0ZW1wdGVkIHRvIGluY3JlbWVudCByb3VuZCBvbiBmaW5pc2hlZCBldmVudC4nKTtcbiAgICAgICAgICAgICAgICAvLyBjb25zdCBvcGVyYXRpb25SZXN1bHQ6IE9wZXJhdGlvblJlc3VsdCA9IHtcbiAgICAgICAgICAgICAgICAvLyAgICAgU3VjY2VzczogZmFsc2VcbiAgICAgICAgICAgICAgICAvLyB9O1xuICAgICAgICAgICAgICAgIC8vIHJlcy5qc29uKG9wZXJhdGlvblJlc3VsdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxufTsiXX0=
