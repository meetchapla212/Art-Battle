"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuctionStatus = void 0;
const States_1 = require("./States");
const logger_1 = require("../config/logger");
const Event_1 = require("../models/Event");
const Lot_1 = require("../models/Lot");
const Twilio = require("twilio");
const ShortUrlGenerator_1 = require("./ShortUrlGenerator");
const Slack_1 = require("./Slack");
const Apns_1 = require("./Apns");
const FCM_1 = require("./FCM");
class AuctionStatus {
    constructor(eventId, contestantId, roundNumber, auctionIndex, cacheDel) {
        this.hardcodedConversionRate = {
            'USD': 1,
            'CAD': 1,
            'AUD': 0.678501,
            'EURO': 1.08,
            'GBP': 1.30,
            'PEN': 0.30,
            'INR': 0.014,
            'ZAR': 0.066,
            'MXN': 0.053
        };
        this.currencyUrlMap = {
            'USD': 'https://artb.art/b',
            'CAD': 'https://artbattle.com',
            'AUD': 'https://buy.artbattle.com',
            'EURO': 'https://buy.artbattle.com',
            'GBP': 'https://buy.artbattle.com',
            'PEN': 'https://buy.artbattle.com',
            'INR': 'https://buy.artbattle.com',
            'ZAR': 'https://buy.artbattle.com',
            'MXN': 'https://buy.artbattle.com'
        };
        this.eventId = eventId;
        this.contestantId = contestantId;
        this.roundNumber = roundNumber;
        this.auctionIndex = auctionIndex;
        this.cacheDel = cacheDel;
        this.isModified = false;
        this.contestantName = '';
    }
    async ChangeAuctionStatus() {
        try {
            if (!States_1.AuctionAdminStats[this.auctionIndex]) {
                logger_1.default.error(`Enable Auction should be 0 or 1  ${this.auctionIndex}`);
                const result = {
                    'Success': false,
                    Data: 'Invalid'
                };
                return result;
            }
            this.event = await Event_1.default.findOne({
                _id: this.eventId
            }).populate('Rounds.Contestants.Detail').populate('Country').populate('Currency');
            if (this.event) {
                await this.updateAuctionIndex();
                if (this.isModified) {
                    await this.event.save();
                    const result = {
                        'Success': true,
                        Data: States_1.AuctionAdminStats[this.auctionIndex]
                    };
                    if (this.auctionIndex === 2 && this.lotModel) {
                        await this.closeAuction();
                    }
                    const artId = this.lotModel.ArtId;
                    logger_1.default.info(`removing auction-detail-${artId} due to status change`);
                    const delRes = await this.cacheDel(`auction-detail-${artId}`);
                    logger_1.default.info(`removed auction-detail-${artId}  due to status change, ${JSON.stringify(delRes, null, 2)}`);
                    return result;
                }
                else {
                    logger_1.default.info(`nothing modified ${this.eventId}`);
                    const result = {
                        'Success': false,
                        Data: 'Invalid'
                    };
                    return result;
                }
            }
            else {
                logger_1.default.info(`matching event not found ${this.eventId}`);
                const result = {
                    'Success': false,
                    Data: 'Invalid'
                };
                return result;
            }
        }
        catch (e) {
            console.error(e);
            logger_1.default.error(`${e.message} ${e.stack}`);
            const result = {
                'Success': false,
                Data: 'Internal Server Error'
            };
            return result;
        }
    }
    updateContestant(contestants) {
        for (let j = 0; j < contestants.length; j++) {
            const contestant = contestants[j];
            if (contestant._id == this.contestantId) {
                contestant.EnableAuction = this.auctionIndex;
                this.isModified = true;
                return { contestants, contestant };
            }
        }
        return {
            contestants: undefined,
            contestant: undefined,
        };
    }
    async updateAuctionIndex() {
        const roundNumber = this.roundNumber;
        const auctionIndex = this.auctionIndex;
        const event = this.event;
        for (let i = 0; i < event.Rounds.length; i++) {
            const round = event.Rounds[i];
            if (round.RoundNumber === roundNumber) {
                const { contestants, contestant } = this.updateContestant(round.Contestants);
                round.Contestants = contestants;
                if (contestant && contestant.EaselNumber && contestant.Lot) {
                    // find Auction doc
                    this.lotModel = await Lot_1.default.findOne(contestant.Lot).populate('Bids.Registration');
                    this.lotModel.Status = auctionIndex;
                    await this.lotModel.save();
                    this.isModified = true;
                    this.contestantName = contestant.Detail.Name;
                }
                else {
                    throw {
                        message: 'Invalid Artist selected'
                    };
                }
                const currentRoundNumber = event.CurrentRound && event.CurrentRound.RoundNumber;
                if (this.isModified && round.RoundNumber === currentRoundNumber) {
                    // reflect in current round object too
                    const { contestants } = this.updateContestant(event.CurrentRound.Contestants);
                    event.CurrentRound.Contestants = contestants;
                }
                break;
            }
        }
    }
    async closeAuction() {
        // Send Notification to winner on Auction close
        const lotModel = this.lotModel;
        const event = this.event;
        const contestantName = this.contestantName;
        const bids = lotModel.Bids.sort((a, b) => {
            return b.Amount - a.Amount;
        });
        const hardcodedConversionRate = this.hardcodedConversionRate;
        const currency = this.event && this.event.Currency && this.event.Currency.currency_label || 'USD';
        const buyHost = this.currencyUrlMap[currency] || this.currencyUrlMap['USD'];
        if (bids[0]) {
            const opr = bids[0].Amount;
            if (hardcodedConversionRate[event.Currency && event.Currency.currency_label || 'USD'] !== 1) {
                bids[0].Amount = bids[0].Amount * hardcodedConversionRate[event.Currency.currency_label];
                // event.Currency.currency_label = 'USD';
            }
            const PhoneNumber = bids[0].Registration.PhoneNumber;
            const NickName = bids[0].Registration.NickName || '';
            const DeviceTokens = bids[0].Registration.DeviceTokens;
            const AndroidDeviceTokens = bids[0].Registration.AndroidDeviceTokens;
            let userVoteChannel = 'sms';
            for (let i = 0; i < event.RegistrationsVoteFactor.length; i++) {
                if (event.RegistrationsVoteFactor[i].PhoneNumber === PhoneNumber) {
                    userVoteChannel = event.RegistrationsVoteFactor[i].From;
                    break;
                }
            }
            const twilioClient = Twilio();
            let link = `${buyHost}/buy/?id=${lotModel.ArtId}&pr=${bids[0].Amount}`;
            if (currency === 'USD') {
                link = link.replace('/buy', '');
            }
            if (bids[0].Amount !== opr) {
                link += `&opr=${opr}`;
            }
            link += `&ph=${PhoneNumber}&nn=${encodeURIComponent(NickName)}`;
            link += `&bn=${bids[0].Registration.FirstName || '' + ' ' + bids[0].Registration.LastName || ''}`;
            link += `&em=${bids[0].Registration.Email || ''}`;
            link += `&cur=${event.Currency && event.Currency.currency_label || 'USD'}`;
            link += `&loc=${event.Country && event.Country.country_code || 'US'}`;
            link += `&tr=${event.Tax}`;
            const shortUrl = await new ShortUrlGenerator_1.ShortUrlGenerator().generateAndSaveUrl(link);
            const message = `You have won ${lotModel.ArtId} by ${contestantName}! Click to pay online or reply with any questions - ${process.env.SITE_URL}/b/${shortUrl.Hash}`;
            // message += `Click to pay online show your host the PAID receipt - ${process.env.SITE_URL}/b/${shortUrl.Hash}`;
            // if sms and app both are checked then sms should not be sent to a app number
            logger_1.default.info(`Sending message: ${message} From: ${event.PhoneNumber} To: ${PhoneNumber}`);
            let twilioRes;
            try {
                twilioRes = await twilioClient.messages.create({
                    from: event.PhoneNumber,
                    to: PhoneNumber,
                    body: message
                });
            }
            catch (e) {
                logger_1.default.error(`${e.message} ${e.stack}`);
            }
            Slack_1.postToSlackSMSFlood({
                'text': `${NickName}(${PhoneNumber}) (sms) \n${message} twilio sid : ${twilioRes && twilioRes.sid} source: Auction.ts CloseAuction`
            }).catch(() => logger_1.default.error(`changeAuctionStatus slack flood call failed  ${message} source: Auction.ts CloseAuction`));
            Slack_1.postToSlackBid({
                'text': `${NickName}(${PhoneNumber}) (sms) \n${message} twilio sid : ${twilioRes && twilioRes.sid}`
            }).catch(() => logger_1.default.error(`changeAuctionStatus slack call failed  ${message}`));
            logger_1.default.info(`sent message: ${message} From: ${event.PhoneNumber} To: ${PhoneNumber}`);
            logger_1.default.info(`winner DeviceTokens`, DeviceTokens);
            if (userVoteChannel != 'sms' && DeviceTokens.length > 0) {
                await Promise.all([
                    Apns_1.sendNotificationIgnoreErr(DeviceTokens, message, event.Name, {
                        url: `${link}`,
                        title: 'You have Won!'
                    }),
                    FCM_1.MultiCastIgnoreErr({
                        DeviceTokens: AndroidDeviceTokens,
                        link: link,
                        title: 'You have Won!',
                        message: message,
                        priority: 'normal',
                        analyticsLabel: 'won-push'
                    })
                ]);
                Slack_1.postToSlackBid({
                    'text': `${NickName}(${PhoneNumber}) (push) \n${JSON.stringify(message)}`
                }).catch(() => logger_1.default.error(`changeAuctionStatus slack call failed ${message}`));
            }
        }
        else {
            logger_1.default.info('auction close, but no bidder');
        }
    }
}
exports.AuctionStatus = AuctionStatus;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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VUFBVTtxQkFDN0IsQ0FBQztpQkFDTCxDQUFDLENBQUM7Z0JBQ0gsc0JBQWMsQ0FBQztvQkFDWCxNQUFNLEVBQUUsR0FBRyxRQUFRLElBQUksV0FBVyxjQUFjLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLEVBQUU7aUJBQzVFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsZ0JBQU0sQ0FBQyxLQUFLLENBQUMseUNBQTBDLE9BQVEsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUN0RjtTQUNKO2FBQU07WUFDSCxnQkFBTSxDQUFDLElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1NBQy9DO0lBQ0wsQ0FBQztDQUNKO0FBN09ELHNDQTZPQyIsImZpbGUiOiJjb21tb24vQXVjdGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEF1Y3Rpb25BZG1pblN0YXRzIH0gZnJvbSAnLi9TdGF0ZXMnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9jb25maWcvbG9nZ2VyJztcbmltcG9ydCB7IERhdGFPcGVyYXRpb25SZXN1bHQgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvT3BlcmF0aW9uUmVzdWx0JztcbmltcG9ydCBFdmVudE1vZGVsLCB7IEV2ZW50RG9jdW1lbnQgfSBmcm9tICcuLi9tb2RlbHMvRXZlbnQnO1xuaW1wb3J0IFJvdW5kQ29udGVzdGFudERUTyBmcm9tICcuLi8uLi8uLi9zaGFyZWQvUm91bmRDb250ZXN0YW50RFRPJztcbmltcG9ydCBMb3RNb2RlbCwgeyBMb3REb2N1bWVudCB9IGZyb20gJy4uL21vZGVscy9Mb3QnO1xuaW1wb3J0ICogYXMgVHdpbGlvIGZyb20gJ3R3aWxpbyc7XG5pbXBvcnQgeyBTaG9ydFVybEdlbmVyYXRvciB9IGZyb20gJy4vU2hvcnRVcmxHZW5lcmF0b3InO1xuaW1wb3J0IHsgcG9zdFRvU2xhY2tCaWQsIHBvc3RUb1NsYWNrU01TRmxvb2QgfSBmcm9tICcuL1NsYWNrJztcbmltcG9ydCB7IHNlbmROb3RpZmljYXRpb25JZ25vcmVFcnIgfSBmcm9tICcuL0FwbnMnO1xuaW1wb3J0IHsgTXVsdGlDYXN0SWdub3JlRXJyIH0gZnJvbSAnLi9GQ00nO1xuXG5leHBvcnQgY2xhc3MgQXVjdGlvblN0YXR1cyB7XG4gICAgcHJpdmF0ZSByZWFkb25seSByb3VuZE51bWJlcjogbnVtYmVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZXZlbnRJZDogYW55O1xuICAgIHByaXZhdGUgY29udGVzdGFudElkOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBjYWNoZURlbDogKGFyZzA6IHN0cmluZykgPT4gdm9pZDtcbiAgICBwcml2YXRlIGF1Y3Rpb25JbmRleDogbnVtYmVyO1xuICAgIHByaXZhdGUgaXNNb2RpZmllZDogYm9vbGVhbjtcbiAgICBwcml2YXRlIGNvbnRlc3RhbnROYW1lOiBzdHJpbmc7XG4gICAgcHVibGljIGV2ZW50OiBFdmVudERvY3VtZW50O1xuICAgIHByaXZhdGUgbG90TW9kZWw6IGFueTtcbiAgICBwdWJsaWMgaGFyZGNvZGVkQ29udmVyc2lvblJhdGU6IHtba2V5OiBzdHJpbmddOiBudW1iZXJ9ID0ge1xuICAgICAgICAnVVNEJzogIDEsXG4gICAgICAgICdDQUQnOiAxLFxuICAgICAgICAnQVVEJzogMC42Nzg1MDEsIC8vIHdhcyBhdVxuICAgICAgICAnRVVSTyc6IDEuMDgsXG4gICAgICAgICdHQlAnOiAxLjMwLFxuICAgICAgICAnUEVOJzogMC4zMCxcbiAgICAgICAgJ0lOUic6IDAuMDE0LFxuICAgICAgICAnWkFSJzogMC4wNjYsXG4gICAgICAgICdNWE4nOiAwLjA1M1xuICAgIH07XG4gICAgcHVibGljIGN1cnJlbmN5VXJsTWFwOiB7W2tleTogc3RyaW5nXTogc3RyaW5nfSA9IHtcbiAgICAgICAgJ1VTRCc6ICdodHRwczovL2FydGIuYXJ0L2InLFxuICAgICAgICAnQ0FEJzogJ2h0dHBzOi8vYXJ0YmF0dGxlLmNvbScsXG4gICAgICAgICdBVUQnOiAnaHR0cHM6Ly9idXkuYXJ0YmF0dGxlLmNvbScsIC8vIHdhcyBhdVxuICAgICAgICAnRVVSTyc6ICdodHRwczovL2J1eS5hcnRiYXR0bGUuY29tJyxcbiAgICAgICAgJ0dCUCc6ICdodHRwczovL2J1eS5hcnRiYXR0bGUuY29tJyxcbiAgICAgICAgJ1BFTic6ICdodHRwczovL2J1eS5hcnRiYXR0bGUuY29tJyxcbiAgICAgICAgJ0lOUic6ICdodHRwczovL2J1eS5hcnRiYXR0bGUuY29tJyxcbiAgICAgICAgJ1pBUic6ICdodHRwczovL2J1eS5hcnRiYXR0bGUuY29tJyxcbiAgICAgICAgJ01YTic6ICdodHRwczovL2J1eS5hcnRiYXR0bGUuY29tJ1xuICAgIH07XG5cbiAgICBjb25zdHJ1Y3RvcihldmVudElkOiBhbnksIGNvbnRlc3RhbnRJZDogc3RyaW5nLCByb3VuZE51bWJlcjogbnVtYmVyLCBhdWN0aW9uSW5kZXg6IG51bWJlciwgY2FjaGVEZWw6IChhcmcwOiBzdHJpbmcpID0+IHZvaWQpIHtcbiAgICAgICAgdGhpcy5ldmVudElkID0gZXZlbnRJZDtcbiAgICAgICAgdGhpcy5jb250ZXN0YW50SWQgPSBjb250ZXN0YW50SWQ7XG4gICAgICAgIHRoaXMucm91bmROdW1iZXIgPSByb3VuZE51bWJlcjtcbiAgICAgICAgdGhpcy5hdWN0aW9uSW5kZXggPSBhdWN0aW9uSW5kZXg7XG4gICAgICAgIHRoaXMuY2FjaGVEZWwgPSBjYWNoZURlbDtcbiAgICAgICAgdGhpcy5pc01vZGlmaWVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuY29udGVzdGFudE5hbWUgPSAnJztcbiAgICB9XG5cbiAgICBhc3luYyBDaGFuZ2VBdWN0aW9uU3RhdHVzKCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKCFBdWN0aW9uQWRtaW5TdGF0c1t0aGlzLmF1Y3Rpb25JbmRleF0pIHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoYEVuYWJsZSBBdWN0aW9uIHNob3VsZCBiZSAwIG9yIDEgICR7dGhpcy5hdWN0aW9uSW5kZXh9YCk7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0OiBEYXRhT3BlcmF0aW9uUmVzdWx0PHN0cmluZz4gPSB7XG4gICAgICAgICAgICAgICAgICAgICdTdWNjZXNzJzogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIERhdGE6ICdJbnZhbGlkJ1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZXZlbnQgPSBhd2FpdCBFdmVudE1vZGVsLmZpbmRPbmUoe1xuICAgICAgICAgICAgICAgIF9pZDogdGhpcy5ldmVudElkXG4gICAgICAgICAgICB9KS5wb3B1bGF0ZSgnUm91bmRzLkNvbnRlc3RhbnRzLkRldGFpbCcpLnBvcHVsYXRlKCdDb3VudHJ5JykucG9wdWxhdGUoJ0N1cnJlbmN5Jyk7XG4gICAgICAgICAgICBpZiAodGhpcy5ldmVudCkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlQXVjdGlvbkluZGV4KCk7XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc01vZGlmaWVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZXZlbnQuc2F2ZSgpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQ6IERhdGFPcGVyYXRpb25SZXN1bHQ8c3RyaW5nPiA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICdTdWNjZXNzJzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGE6IEF1Y3Rpb25BZG1pblN0YXRzW3RoaXMuYXVjdGlvbkluZGV4XVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5hdWN0aW9uSW5kZXggPT09IDIgJiYgdGhpcy5sb3RNb2RlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5jbG9zZUF1Y3Rpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhcnRJZCA9IHRoaXMubG90TW9kZWwuQXJ0SWQ7XG4gICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGByZW1vdmluZyBhdWN0aW9uLWRldGFpbC0ke2FydElkfSBkdWUgdG8gc3RhdHVzIGNoYW5nZWApO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWxSZXMgPSBhd2FpdCB0aGlzLmNhY2hlRGVsKGBhdWN0aW9uLWRldGFpbC0ke2FydElkfWApO1xuICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhgcmVtb3ZlZCBhdWN0aW9uLWRldGFpbC0ke2FydElkfSAgZHVlIHRvIHN0YXR1cyBjaGFuZ2UsICR7SlNPTi5zdHJpbmdpZnkoZGVsUmVzLCBudWxsLCAyKX1gKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhgbm90aGluZyBtb2RpZmllZCAke3RoaXMuZXZlbnRJZH1gKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0OiBEYXRhT3BlcmF0aW9uUmVzdWx0PHN0cmluZz4gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAnU3VjY2Vzcyc6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YTogJ0ludmFsaWQnXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhgbWF0Y2hpbmcgZXZlbnQgbm90IGZvdW5kICR7dGhpcy5ldmVudElkfWApO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdDogRGF0YU9wZXJhdGlvblJlc3VsdDxzdHJpbmc+ID0ge1xuICAgICAgICAgICAgICAgICAgICAnU3VjY2Vzcyc6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBEYXRhOiAnSW52YWxpZCdcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihgJHtlLm1lc3NhZ2V9ICR7ZS5zdGFja31gKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdDogRGF0YU9wZXJhdGlvblJlc3VsdDxzdHJpbmc+ID0ge1xuICAgICAgICAgICAgICAgICdTdWNjZXNzJzogZmFsc2UsXG4gICAgICAgICAgICAgICAgRGF0YTogJ0ludGVybmFsIFNlcnZlciBFcnJvcidcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdXBkYXRlQ29udGVzdGFudChjb250ZXN0YW50czogUm91bmRDb250ZXN0YW50RFRPW10pIHtcbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBjb250ZXN0YW50cy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgY29uc3QgY29udGVzdGFudCA9IGNvbnRlc3RhbnRzW2pdO1xuICAgICAgICAgICAgaWYgKGNvbnRlc3RhbnQuX2lkID09IHRoaXMuY29udGVzdGFudElkKSB7XG4gICAgICAgICAgICAgICAgY29udGVzdGFudC5FbmFibGVBdWN0aW9uID0gdGhpcy5hdWN0aW9uSW5kZXg7XG4gICAgICAgICAgICAgICAgdGhpcy5pc01vZGlmaWVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICByZXR1cm4ge2NvbnRlc3RhbnRzLCBjb250ZXN0YW50fTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29udGVzdGFudHM6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGNvbnRlc3RhbnQ6IHVuZGVmaW5lZCxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBhc3luYyB1cGRhdGVBdWN0aW9uSW5kZXgoKSB7XG4gICAgICAgIGNvbnN0IHJvdW5kTnVtYmVyID0gdGhpcy5yb3VuZE51bWJlcjtcbiAgICAgICAgY29uc3QgYXVjdGlvbkluZGV4ID0gdGhpcy5hdWN0aW9uSW5kZXg7XG4gICAgICAgIGNvbnN0IGV2ZW50ID0gdGhpcy5ldmVudDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBldmVudC5Sb3VuZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHJvdW5kID0gZXZlbnQuUm91bmRzW2ldO1xuICAgICAgICAgICAgaWYgKHJvdW5kLlJvdW5kTnVtYmVyID09PSByb3VuZE51bWJlcikge1xuICAgICAgICAgICAgICAgIGNvbnN0IHtjb250ZXN0YW50cywgY29udGVzdGFudH0gPSB0aGlzLnVwZGF0ZUNvbnRlc3RhbnQocm91bmQuQ29udGVzdGFudHMpO1xuICAgICAgICAgICAgICAgIHJvdW5kLkNvbnRlc3RhbnRzID0gY29udGVzdGFudHM7XG4gICAgICAgICAgICAgICAgaWYgKGNvbnRlc3RhbnQgJiYgY29udGVzdGFudC5FYXNlbE51bWJlciAmJiBjb250ZXN0YW50LkxvdCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBmaW5kIEF1Y3Rpb24gZG9jXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG90TW9kZWwgPSBhd2FpdCBMb3RNb2RlbC5maW5kT25lKGNvbnRlc3RhbnQuTG90KS5wb3B1bGF0ZSgnQmlkcy5SZWdpc3RyYXRpb24nKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb3RNb2RlbC5TdGF0dXMgPSBhdWN0aW9uSW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMubG90TW9kZWwuc2F2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmlzTW9kaWZpZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRlc3RhbnROYW1lID0gY29udGVzdGFudC5EZXRhaWwuTmFtZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnSW52YWxpZCBBcnRpc3Qgc2VsZWN0ZWQnXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRSb3VuZE51bWJlciA9ICBldmVudC5DdXJyZW50Um91bmQgJiYgZXZlbnQuQ3VycmVudFJvdW5kLlJvdW5kTnVtYmVyO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzTW9kaWZpZWQgJiYgcm91bmQuUm91bmROdW1iZXIgPT09IGN1cnJlbnRSb3VuZE51bWJlcikge1xuICAgICAgICAgICAgICAgICAgICAvLyByZWZsZWN0IGluIGN1cnJlbnQgcm91bmQgb2JqZWN0IHRvb1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB7Y29udGVzdGFudHN9ID0gdGhpcy51cGRhdGVDb250ZXN0YW50KGV2ZW50LkN1cnJlbnRSb3VuZC5Db250ZXN0YW50cyk7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LkN1cnJlbnRSb3VuZC5Db250ZXN0YW50cyA9IGNvbnRlc3RhbnRzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGNsb3NlQXVjdGlvbigpIHtcbiAgICAgICAgLy8gU2VuZCBOb3RpZmljYXRpb24gdG8gd2lubmVyIG9uIEF1Y3Rpb24gY2xvc2VcbiAgICAgICAgY29uc3QgbG90TW9kZWw6IExvdERvY3VtZW50ID0gdGhpcy5sb3RNb2RlbDtcbiAgICAgICAgY29uc3QgZXZlbnQgPSB0aGlzLmV2ZW50O1xuICAgICAgICBjb25zdCBjb250ZXN0YW50TmFtZSA9IHRoaXMuY29udGVzdGFudE5hbWU7XG4gICAgICAgIGNvbnN0IGJpZHMgPSBsb3RNb2RlbC5CaWRzLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBiLkFtb3VudCAtIGEuQW1vdW50O1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgaGFyZGNvZGVkQ29udmVyc2lvblJhdGUgPSB0aGlzLmhhcmRjb2RlZENvbnZlcnNpb25SYXRlO1xuICAgICAgICBjb25zdCBjdXJyZW5jeSA9IHRoaXMuZXZlbnQgJiYgdGhpcy5ldmVudC5DdXJyZW5jeSAmJiB0aGlzLmV2ZW50LkN1cnJlbmN5LmN1cnJlbmN5X2xhYmVsIHx8ICdVU0QnO1xuICAgICAgICBjb25zdCBidXlIb3N0ID0gdGhpcy5jdXJyZW5jeVVybE1hcFtjdXJyZW5jeV0gfHwgdGhpcy5jdXJyZW5jeVVybE1hcFsnVVNEJ107XG4gICAgICAgIGlmIChiaWRzWzBdKSB7XG4gICAgICAgICAgICBjb25zdCBvcHIgPSBiaWRzWzBdLkFtb3VudDtcbiAgICAgICAgICAgIGlmIChoYXJkY29kZWRDb252ZXJzaW9uUmF0ZVtldmVudC5DdXJyZW5jeSAmJiBldmVudC5DdXJyZW5jeS5jdXJyZW5jeV9sYWJlbCB8fCAnVVNEJ10gIT09IDEpIHtcbiAgICAgICAgICAgICAgICBiaWRzWzBdLkFtb3VudCA9IGJpZHNbMF0uQW1vdW50ICogaGFyZGNvZGVkQ29udmVyc2lvblJhdGVbZXZlbnQuQ3VycmVuY3kuY3VycmVuY3lfbGFiZWxdO1xuICAgICAgICAgICAgICAgIC8vIGV2ZW50LkN1cnJlbmN5LmN1cnJlbmN5X2xhYmVsID0gJ1VTRCc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBQaG9uZU51bWJlciA9IGJpZHNbMF0uUmVnaXN0cmF0aW9uLlBob25lTnVtYmVyO1xuICAgICAgICAgICAgY29uc3QgTmlja05hbWUgPSBiaWRzWzBdLlJlZ2lzdHJhdGlvbi5OaWNrTmFtZSB8fCAnJztcbiAgICAgICAgICAgIGNvbnN0IERldmljZVRva2VucyA9IGJpZHNbMF0uUmVnaXN0cmF0aW9uLkRldmljZVRva2VucztcbiAgICAgICAgICAgIGNvbnN0IEFuZHJvaWREZXZpY2VUb2tlbnMgPSBiaWRzWzBdLlJlZ2lzdHJhdGlvbi5BbmRyb2lkRGV2aWNlVG9rZW5zO1xuICAgICAgICAgICAgbGV0IHVzZXJWb3RlQ2hhbm5lbCA9ICdzbXMnO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBldmVudC5SZWdpc3RyYXRpb25zVm90ZUZhY3Rvci5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmIChldmVudC5SZWdpc3RyYXRpb25zVm90ZUZhY3RvcltpXS5QaG9uZU51bWJlciA9PT0gUGhvbmVOdW1iZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdXNlclZvdGVDaGFubmVsID0gZXZlbnQuUmVnaXN0cmF0aW9uc1ZvdGVGYWN0b3JbaV0uRnJvbTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgdHdpbGlvQ2xpZW50ID0gVHdpbGlvKCk7XG4gICAgICAgICAgICBsZXQgbGluayA9IGAke2J1eUhvc3R9L2J1eS8/aWQ9JHtsb3RNb2RlbC5BcnRJZH0mcHI9JHtiaWRzWzBdLkFtb3VudH1gO1xuICAgICAgICAgICAgaWYgKGN1cnJlbmN5ID09PSAnVVNEJykge1xuICAgICAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJy9idXknLCAnJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYmlkc1swXS5BbW91bnQgIT09IG9wcikge1xuICAgICAgICAgICAgICAgIGxpbmsgKz0gYCZvcHI9JHtvcHJ9YDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxpbmsgKz0gYCZwaD0ke1Bob25lTnVtYmVyfSZubj0ke2VuY29kZVVSSUNvbXBvbmVudChOaWNrTmFtZSl9YDtcbiAgICAgICAgICAgIGxpbmsgKz0gYCZibj0ke2JpZHNbMF0uUmVnaXN0cmF0aW9uLkZpcnN0TmFtZSB8fCAnJyArICcgJyArIGJpZHNbMF0uUmVnaXN0cmF0aW9uLkxhc3ROYW1lIHx8ICcnfWA7XG4gICAgICAgICAgICBsaW5rICs9IGAmZW09JHtiaWRzWzBdLlJlZ2lzdHJhdGlvbi5FbWFpbCB8fCAnJ31gO1xuICAgICAgICAgICAgbGluayArPSBgJmN1cj0ke2V2ZW50LkN1cnJlbmN5ICYmIGV2ZW50LkN1cnJlbmN5LmN1cnJlbmN5X2xhYmVsIHx8ICdVU0QnfWA7XG4gICAgICAgICAgICBsaW5rICs9IGAmbG9jPSR7ZXZlbnQuQ291bnRyeSAmJiBldmVudC5Db3VudHJ5LmNvdW50cnlfY29kZSB8fCAnVVMnfWA7XG4gICAgICAgICAgICBsaW5rICs9IGAmdHI9JHtldmVudC5UYXh9YDtcbiAgICAgICAgICAgIGNvbnN0IHNob3J0VXJsID0gYXdhaXQgbmV3IFNob3J0VXJsR2VuZXJhdG9yKCkuZ2VuZXJhdGVBbmRTYXZlVXJsKGxpbmspO1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGBZb3UgaGF2ZSB3b24gJHtsb3RNb2RlbC5BcnRJZH0gYnkgJHtjb250ZXN0YW50TmFtZX0hIENsaWNrIHRvIHBheSBvbmxpbmUgb3IgcmVwbHkgd2l0aCBhbnkgcXVlc3Rpb25zIC0gJHtwcm9jZXNzLmVudi5TSVRFX1VSTH0vYi8ke3Nob3J0VXJsLkhhc2h9YDtcbiAgICAgICAgICAgIC8vIG1lc3NhZ2UgKz0gYENsaWNrIHRvIHBheSBvbmxpbmUgc2hvdyB5b3VyIGhvc3QgdGhlIFBBSUQgcmVjZWlwdCAtICR7cHJvY2Vzcy5lbnYuU0lURV9VUkx9L2IvJHtzaG9ydFVybC5IYXNofWA7XG4gICAgICAgICAgICAvLyBpZiBzbXMgYW5kIGFwcCBib3RoIGFyZSBjaGVja2VkIHRoZW4gc21zIHNob3VsZCBub3QgYmUgc2VudCB0byBhIGFwcCBudW1iZXJcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGBTZW5kaW5nIG1lc3NhZ2U6ICR7bWVzc2FnZX0gRnJvbTogJHtldmVudC5QaG9uZU51bWJlcn0gVG86ICR7UGhvbmVOdW1iZXJ9YCk7XG4gICAgICAgICAgICBsZXQgdHdpbGlvUmVzO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB0d2lsaW9SZXMgPSBhd2FpdCB0d2lsaW9DbGllbnQubWVzc2FnZXMuY3JlYXRlKHtcbiAgICAgICAgICAgICAgICAgICAgZnJvbTogZXZlbnQuUGhvbmVOdW1iZXIsXG4gICAgICAgICAgICAgICAgICAgIHRvOiBQaG9uZU51bWJlcixcbiAgICAgICAgICAgICAgICAgICAgYm9keTogbWVzc2FnZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihgJHtlLm1lc3NhZ2V9ICR7ZS5zdGFja31gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBvc3RUb1NsYWNrU01TRmxvb2Qoe1xuICAgICAgICAgICAgICAgICd0ZXh0JzogYCR7Tmlja05hbWV9KCR7UGhvbmVOdW1iZXJ9KSAoc21zKSBcXG4ke21lc3NhZ2V9IHR3aWxpbyBzaWQgOiAke3R3aWxpb1JlcyAmJiB0d2lsaW9SZXMuc2lkfSBzb3VyY2U6IEF1Y3Rpb24udHMgQ2xvc2VBdWN0aW9uYFxuICAgICAgICAgICAgfSkuY2F0Y2goKCkgPT4gbG9nZ2VyLmVycm9yKGBjaGFuZ2VBdWN0aW9uU3RhdHVzIHNsYWNrIGZsb29kIGNhbGwgZmFpbGVkICAke21lc3NhZ2V9IHNvdXJjZTogQXVjdGlvbi50cyBDbG9zZUF1Y3Rpb25gKSk7XG4gICAgICAgICAgICBwb3N0VG9TbGFja0JpZCh7XG4gICAgICAgICAgICAgICAgJ3RleHQnOiBgJHtOaWNrTmFtZX0oJHtQaG9uZU51bWJlcn0pIChzbXMpIFxcbiR7bWVzc2FnZX0gdHdpbGlvIHNpZCA6ICR7dHdpbGlvUmVzICYmIHR3aWxpb1Jlcy5zaWR9YFxuICAgICAgICAgICAgfSkuY2F0Y2goKCkgPT4gbG9nZ2VyLmVycm9yKGBjaGFuZ2VBdWN0aW9uU3RhdHVzIHNsYWNrIGNhbGwgZmFpbGVkICAke21lc3NhZ2V9YCkpO1xuICAgICAgICAgICAgbG9nZ2VyLmluZm8oYHNlbnQgbWVzc2FnZTogJHttZXNzYWdlfSBGcm9tOiAke2V2ZW50LlBob25lTnVtYmVyfSBUbzogJHtQaG9uZU51bWJlcn1gKTtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGB3aW5uZXIgRGV2aWNlVG9rZW5zYCwgRGV2aWNlVG9rZW5zKTtcbiAgICAgICAgICAgIGlmICh1c2VyVm90ZUNoYW5uZWwgIT0gJ3NtcycgJiYgRGV2aWNlVG9rZW5zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICAgICAgICAgIHNlbmROb3RpZmljYXRpb25JZ25vcmVFcnIoRGV2aWNlVG9rZW5zLCBtZXNzYWdlLCBldmVudC5OYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogYCR7bGlua31gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiAnWW91IGhhdmUgV29uISdcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICBNdWx0aUNhc3RJZ25vcmVFcnIoe1xuICAgICAgICAgICAgICAgICAgICAgICAgRGV2aWNlVG9rZW5zOiBBbmRyb2lkRGV2aWNlVG9rZW5zLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGluazogbGluayxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiAnWW91IGhhdmUgV29uIScsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJpb3JpdHk6ICdub3JtYWwnLFxuICAgICAgICAgICAgICAgICAgICAgICAgYW5hbHl0aWNzTGFiZWw6ICd3b24tcHVzaCdcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICBdKTtcbiAgICAgICAgICAgICAgICBwb3N0VG9TbGFja0JpZCh7XG4gICAgICAgICAgICAgICAgICAgICd0ZXh0JzogYCR7Tmlja05hbWV9KCR7UGhvbmVOdW1iZXJ9KSAocHVzaCkgXFxuJHtKU09OLnN0cmluZ2lmeShtZXNzYWdlKX1gXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goKCkgPT4gbG9nZ2VyLmVycm9yKGBjaGFuZ2VBdWN0aW9uU3RhdHVzIHNsYWNrIGNhbGwgZmFpbGVkICR7IG1lc3NhZ2UgfWApKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCdhdWN0aW9uIGNsb3NlLCBidXQgbm8gYmlkZGVyJyk7XG4gICAgICAgIH1cbiAgICB9XG59Il19
