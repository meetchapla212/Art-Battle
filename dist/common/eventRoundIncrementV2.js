"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EventIncrementRoundV2 = void 0;
const Event_1 = require("../models/Event");
const logger_1 = require("../config/logger");
const User_1 = require("../models/User");
const Slack_1 = require("./Slack");
/**
 * No concept of closing round, opening round only
 * @param eventId
 * @param userId
 * @param roundNumber
 * @constructor
 */
exports.EventIncrementRoundV2 = async function (req, eventId, userId, roundNumber) {
    let event;
    event = await Event_1.default.findById(eventId);
    if (!event.CurrentRound || (event.CurrentRound.RoundNumber !== roundNumber && roundNumber > event.CurrentRound.RoundNumber)) { // if a round is running, complete it
        if (event.CurrentRound) {
            await closeRound(event, userId);
        }
        await startRound(event, userId);
    }
    const cacheKey = `app-event-list-`;
    const cacheDel = req.app.get('cacheDel');
    const cacheDelPromises = [];
    cacheDelPromises.push(cacheDel(`${cacheKey}${eventId}`));
    cacheDelPromises.push(cacheDel(cacheKey));
    await Promise.all(cacheDelPromises);
    logger_1.default.info(`roundNumber ${roundNumber} 'event.CurrentRound.RoundNumber', ${event.CurrentRound && event.CurrentRound.RoundNumber}`);
};
async function closeRound(event, userId) {
    logger_1.default.info(`Closing round ${event.CurrentRound.RoundNumber}`);
    const currentRound = event.Rounds
        .find(r => r.RoundNumber == event.CurrentRound.RoundNumber);
    currentRound.IsFinished = true;
    // currentRound.Contestants = event.CurrentRound.Contestants;
    let totalVotes = 0;
    for (let i = 0; i < event.CurrentRound.Contestants.length; i++) {
        currentRound.Contestants[i].Enabled = event.CurrentRound.Contestants[i].Enabled;
        currentRound.Contestants[i].EaselNumber = event.CurrentRound.Contestants[i].EaselNumber;
        totalVotes += currentRound.Contestants[i].Votes.length;
    }
    event.CurrentRound = null;
    const user = await User_1.default.findById(userId);
    const message = `${event.Name}, Round ${currentRound.RoundNumber} is closed by ${user && user.email}, votes ${totalVotes}`;
    event.Logs.push({
        Message: message,
        CreatedDate: new Date()
    });
    const result = await event.save();
    const operationResult = {
        Success: true,
        Data: result
    };
    // send message to slack channel
    Slack_1.default({
        'text': message
    }).catch(() => logger_1.default.info('close round slack call failed, message was ', message));
    return operationResult;
}
async function startRound(event, userId) {
    const availableRounds = event.Rounds.filter(r => !r.IsFinished);
    if (availableRounds.length > 0) { // if there are any rounds left, start the next one
        const nextRound = availableRounds.reduce((prev, cur) => {
            return prev.RoundNumber < cur.RoundNumber ? prev : cur;
        });
        logger_1.default.info(`Starting round ${nextRound.RoundNumber}`);
        event.CurrentRound = nextRound;
        // After sending response send message to slack channel
        const user = await User_1.default.findById(userId);
        const message = `${event.Name}, Round ${nextRound.RoundNumber} is started by ${user && user.email}, registered: ${event.Registrations.length}`;
        event.Logs.push({
            Message: message,
            CreatedDate: new Date()
        });
        const result = await event.save();
        /*await EventModel.findOneAndUpdate({
            _id: event._id
        }, event);

        const  result = await EventModel.findOne({
            _id: event._id
        });*/
        const operationResult = {
            Success: true,
            Data: result
        };
        Slack_1.default({
            'text': message
        }).catch(() => logger_1.default.info('starting round slack call failed, message was ', message));
        return operationResult;
    }
    else { // loop if all rounds are finished.
        logger_1.default.info('Attempted to increment round on finished event. Looping rounds.');
        event.Rounds.forEach(r => r.IsFinished = false);
        event.CurrentRound = null;
        const user = await User_1.default.findById(userId);
        const message = `${event.Name} is finished but round is being started by ${user && user.email}`;
        event.Logs.push({
            Message: message,
            CreatedDate: new Date()
        });
        const result = await event.save();
        const operationResult = {
            Success: true,
            Data: result
        };
        // After sending response send message to slack channel
        Slack_1.default({
            'text': message
        }).catch(() => logger_1.default.info(' finish event, attempt to increment round call failed ', message));
        return operationResult;
        // logger.info('Attempted to increment round on finished event.');
        // const operationResult: OperationResult = {
        //     Success: false
        // };
        // res.json(operationResult);
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbW1vbi9ldmVudFJvdW5kSW5jcmVtZW50VjIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkNBQXVFO0FBQ3ZFLDZDQUFzQztBQUN0Qyx5Q0FBK0Q7QUFHL0QsbUNBQWtDO0FBR2xDOzs7Ozs7R0FNRztBQUNVLFFBQUEscUJBQXFCLEdBQUcsS0FBSyxXQUFXLEdBQVksRUFBRSxPQUFlLEVBQUUsTUFBYyxFQUFFLFdBQW1CO0lBQ25ILElBQUksS0FBb0IsQ0FBQztJQUV6QixLQUFLLEdBQUcsTUFBTSxlQUFVLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzNDLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxXQUFXLEtBQUssV0FBVyxJQUFJLFdBQVcsR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEVBQUUscUNBQXFDO1FBQ2hLLElBQUksS0FBSyxDQUFDLFlBQVksRUFBRTtZQUNwQixNQUFNLFVBQVUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7U0FDbkM7UUFDRCxNQUFNLFVBQVUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDbkM7SUFDRCxNQUFNLFFBQVEsR0FBRyxpQkFBaUIsQ0FBQztJQUNuQyxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN6QyxNQUFNLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztJQUM1QixnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsUUFBUSxHQUFHLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN6RCxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFDMUMsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDcEMsZ0JBQU0sQ0FB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QUMxQixNQUFNLElBQUksR0FBaUIsTUFBTSxjQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3ZELE1BQU0sT0FBTyxHQUFHLEdBQUcsS0FBSyxDQUFDLElBQUksOENBQThDLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDaEcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDWixPQUFPLEVBQUUsT0FBTztZQUNoQixXQUFXLEVBQUUsSUFBSSxJQUFJLEVBQUU7U0FDMUIsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUcsTUFBTSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFbEMsTUFBTSxlQUFlLEdBQWtDO1lBQ25ELE9BQU8sRUFBRSxJQUFJO1lBQ2IsSUFBSSxFQUFFLE1BQU07U0FDZixDQUFDO1FBQ0YsdURBQXVEO1FBQ3ZELGVBQVcsQ0FBQztZQUNSLE1BQU0sRUFBRSxPQUFPO1NBQ2xCLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsd0RBQXdELEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUMvRixPQUFPLGVBQWUsQ0FBQztRQUN2QixrRUFBa0U7UUFDbEUsNkNBQTZDO1FBQzdDLHFCQUFxQjtRQUNyQixLQUFLO1FBQ0wsNkJBQTZCO0tBQ2hDO0FBQ0wsQ0FBQyIsImZpbGUiOiJjb21tb24vZXZlbnRSb3VuZEluY3JlbWVudFYyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGVmYXVsdCBhcyBFdmVudE1vZGVsLCBFdmVudERvY3VtZW50IH0gZnJvbSAnLi4vbW9kZWxzL0V2ZW50JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vY29uZmlnL2xvZ2dlcic7XG5pbXBvcnQgeyBkZWZhdWx0IGFzIFVzZXIsIFVzZXJEb2N1bWVudCB9IGZyb20gJy4uL21vZGVscy9Vc2VyJztcbmltcG9ydCB7IERhdGFPcGVyYXRpb25SZXN1bHQgfSBmcm9tICcuLi8uLi8uLi9zaGFyZWQvT3BlcmF0aW9uUmVzdWx0JztcbmltcG9ydCB7IEV2ZW50RFRPIH0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL0V2ZW50RFRPJztcbmltcG9ydCBwb3N0VG9TbGFjayBmcm9tICcuL1NsYWNrJztcbmltcG9ydCB7IFJlcXVlc3QgfSBmcm9tICdleHByZXNzJztcblxuLyoqXG4gKiBObyBjb25jZXB0IG9mIGNsb3Npbmcgcm91bmQsIG9wZW5pbmcgcm91bmQgb25seVxuICogQHBhcmFtIGV2ZW50SWRcbiAqIEBwYXJhbSB1c2VySWRcbiAqIEBwYXJhbSByb3VuZE51bWJlclxuICogQGNvbnN0cnVjdG9yXG4gKi9cbmV4cG9ydCBjb25zdCBFdmVudEluY3JlbWVudFJvdW5kVjIgPSBhc3luYyBmdW5jdGlvbiAocmVxOiBSZXF1ZXN0LCBldmVudElkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nLCByb3VuZE51bWJlcjogbnVtYmVyKSB7XG4gICAgbGV0IGV2ZW50OiBFdmVudERvY3VtZW50O1xuXG4gICAgZXZlbnQgPSBhd2FpdCBFdmVudE1vZGVsLmZpbmRCeUlkKGV2ZW50SWQpO1xuICAgIGlmICghZXZlbnQuQ3VycmVudFJvdW5kIHx8IChldmVudC5DdXJyZW50Um91bmQuUm91bmROdW1iZXIgIT09IHJvdW5kTnVtYmVyICYmIHJvdW5kTnVtYmVyID4gZXZlbnQuQ3VycmVudFJvdW5kLlJvdW5kTnVtYmVyKSkgeyAvLyBpZiBhIHJvdW5kIGlzIHJ1bm5pbmcsIGNvbXBsZXRlIGl0XG4gICAgICAgIGlmIChldmVudC5DdXJyZW50Um91bmQpIHtcbiAgICAgICAgICAgIGF3YWl0IGNsb3NlUm91bmQoZXZlbnQsIHVzZXJJZCk7XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgc3RhcnRSb3VuZChldmVudCwgdXNlcklkKTtcbiAgICB9XG4gICAgY29uc3QgY2FjaGVLZXkgPSBgYXBwLWV2ZW50LWxpc3QtYDtcbiAgICBjb25zdCBjYWNoZURlbCA9IHJlcS5hcHAuZ2V0KCdjYWNoZURlbCcpO1xuICAgIGNvbnN0IGNhY2hlRGVsUHJvbWlzZXMgPSBbXTtcbiAgICBjYWNoZURlbFByb21pc2VzLnB1c2goY2FjaGVEZWwoYCR7Y2FjaGVLZXl9JHtldmVudElkfWApKTtcbiAgICBjYWNoZURlbFByb21pc2VzLnB1c2goY2FjaGVEZWwoY2FjaGVLZXkpKTtcbiAgICBhd2FpdCBQcm9taXNlLmFsbChjYWNoZURlbFByb21pc2VzKTtcbiAgICBsb2dnZXIuaW5mbyhgcm91bmROdW1iZXIgJHtyb3VuZE51bWJlcn0gJ2V2ZW50LkN1cnJlbnRSb3VuZC5Sb3VuZE51bWJlcicsICR7ZXZlbnQuQ3VycmVudFJvdW5kICYmIGV2ZW50LkN1cnJlbnRSb3VuZC5Sb3VuZE51bWJlcn1gKTtcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGNsb3NlUm91bmQoZXZlbnQ6IEV2ZW50RG9jdW1lbnQsIHVzZXJJZDogc3RyaW5nKSB7XG4gICAgbG9nZ2VyLmluZm8oYENsb3Npbmcgcm91bmQgJHtldmVudC5DdXJyZW50Um91bmQuUm91bmROdW1iZXJ9YCk7XG5cbiAgICBjb25zdCBjdXJyZW50Um91bmQgPSBldmVudC5Sb3VuZHNcbiAgICAgICAgLmZpbmQociA9PiByLlJvdW5kTnVtYmVyID09IGV2ZW50LkN1cnJlbnRSb3VuZC5Sb3VuZE51bWJlcik7XG4gICAgY3VycmVudFJvdW5kLklzRmluaXNoZWQgPSB0cnVlO1xuICAgIC8vIGN1cnJlbnRSb3VuZC5Db250ZXN0YW50cyA9IGV2ZW50LkN1cnJlbnRSb3VuZC5Db250ZXN0YW50cztcbiAgICBsZXQgdG90YWxWb3RlcyA9IDA7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBldmVudC5DdXJyZW50Um91bmQuQ29udGVzdGFudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY3VycmVudFJvdW5kLkNvbnRlc3RhbnRzW2ldLkVuYWJsZWQgPSBldmVudC5DdXJyZW50Um91bmQuQ29udGVzdGFudHNbaV0uRW5hYmxlZDtcbiAgICAgICAgY3VycmVudFJvdW5kLkNvbnRlc3RhbnRzW2ldLkVhc2VsTnVtYmVyID0gZXZlbnQuQ3VycmVudFJvdW5kLkNvbnRlc3RhbnRzW2ldLkVhc2VsTnVtYmVyO1xuICAgICAgICB0b3RhbFZvdGVzICs9IGN1cnJlbnRSb3VuZC5Db250ZXN0YW50c1tpXS5Wb3Rlcy5sZW5ndGg7XG4gICAgfVxuXG4gICAgZXZlbnQuQ3VycmVudFJvdW5kID0gbnVsbDtcbiAgICBjb25zdCB1c2VyOiBVc2VyRG9jdW1lbnQgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHVzZXJJZCk7XG4gICAgY29uc3QgbWVzc2FnZSA9IGAke2V2ZW50Lk5hbWV9LCBSb3VuZCAke2N1cnJlbnRSb3VuZC5Sb3VuZE51bWJlcn0gaXMgY2xvc2VkIGJ5ICR7dXNlciAmJiB1c2VyLmVtYWlsfSwgdm90ZXMgJHt0b3RhbFZvdGVzfWA7XG4gICAgZXZlbnQuTG9ncy5wdXNoKHtcbiAgICAgICAgTWVzc2FnZTogbWVzc2FnZSxcbiAgICAgICAgQ3JlYXRlZERhdGU6IG5ldyBEYXRlKClcbiAgICB9KTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBldmVudC5zYXZlKCk7XG4gICAgY29uc3Qgb3BlcmF0aW9uUmVzdWx0OiBEYXRhT3BlcmF0aW9uUmVzdWx0PEV2ZW50RFRPPiA9IHtcbiAgICAgICAgU3VjY2VzczogdHJ1ZSxcbiAgICAgICAgRGF0YTogcmVzdWx0XG4gICAgfTtcbiAgICAvLyBzZW5kIG1lc3NhZ2UgdG8gc2xhY2sgY2hhbm5lbFxuICAgIHBvc3RUb1NsYWNrKHtcbiAgICAgICAgJ3RleHQnOiBtZXNzYWdlXG4gICAgfSkuY2F0Y2goKCkgPT4gbG9nZ2VyLmluZm8oJ2Nsb3NlIHJvdW5kIHNsYWNrIGNhbGwgZmFpbGVkLCBtZXNzYWdlIHdhcyAnLCBtZXNzYWdlKSk7XG5cbiAgICByZXR1cm4gb3BlcmF0aW9uUmVzdWx0O1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydFJvdW5kKGV2ZW50OiBFdmVudERvY3VtZW50LCB1c2VySWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGF2YWlsYWJsZVJvdW5kcyA9IGV2ZW50LlJvdW5kcy5maWx0ZXIociA9PiAhci5Jc0ZpbmlzaGVkKTtcbiAgICBpZiAoYXZhaWxhYmxlUm91bmRzLmxlbmd0aCA+IDApIHsgLy8gaWYgdGhlcmUgYXJlIGFueSByb3VuZHMgbGVmdCwgc3RhcnQgdGhlIG5leHQgb25lXG4gICAgICAgIGNvbnN0IG5leHRSb3VuZCA9IGF2YWlsYWJsZVJvdW5kcy5yZWR1Y2UoKHByZXYsIGN1cikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHByZXYuUm91bmROdW1iZXIgPCBjdXIuUm91bmROdW1iZXIgPyBwcmV2IDogY3VyO1xuICAgICAgICB9KTtcblxuICAgICAgICBsb2dnZXIuaW5mbyhgU3RhcnRpbmcgcm91bmQgJHtuZXh0Um91bmQuUm91bmROdW1iZXJ9YCk7XG5cbiAgICAgICAgZXZlbnQuQ3VycmVudFJvdW5kID0gbmV4dFJvdW5kO1xuICAgICAgICAvLyBBZnRlciBzZW5kaW5nIHJlc3BvbnNlIHNlbmQgbWVzc2FnZSB0byBzbGFjayBjaGFubmVsXG4gICAgICAgIGNvbnN0IHVzZXI6IFVzZXJEb2N1bWVudCA9IGF3YWl0IFVzZXIuZmluZEJ5SWQodXNlcklkKTtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IGAke2V2ZW50Lk5hbWV9LCBSb3VuZCAke25leHRSb3VuZC5Sb3VuZE51bWJlcn0gaXMgc3RhcnRlZCBieSAke3VzZXIgJiYgdXNlci5lbWFpbH0sIHJlZ2lzdGVyZWQ6ICR7ZXZlbnQuUmVnaXN0cmF0aW9ucy5sZW5ndGh9YDtcbiAgICAgICAgZXZlbnQuTG9ncy5wdXNoKHtcbiAgICAgICAgICAgIE1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgICAgICAgICBDcmVhdGVkRGF0ZTogbmV3IERhdGUoKVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBldmVudC5zYXZlKCk7XG4gICAgICAgIC8qYXdhaXQgRXZlbnRNb2RlbC5maW5kT25lQW5kVXBkYXRlKHtcbiAgICAgICAgICAgIF9pZDogZXZlbnQuX2lkXG4gICAgICAgIH0sIGV2ZW50KTtcblxuICAgICAgICBjb25zdCAgcmVzdWx0ID0gYXdhaXQgRXZlbnRNb2RlbC5maW5kT25lKHtcbiAgICAgICAgICAgIF9pZDogZXZlbnQuX2lkXG4gICAgICAgIH0pOyovXG4gICAgICAgIGNvbnN0IG9wZXJhdGlvblJlc3VsdDogRGF0YU9wZXJhdGlvblJlc3VsdDxFdmVudERUTz4gPSB7XG4gICAgICAgICAgICBTdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgRGF0YTogcmVzdWx0XG4gICAgICAgIH07XG5cbiAgICAgICAgcG9zdFRvU2xhY2soe1xuICAgICAgICAgICAgJ3RleHQnOiBtZXNzYWdlXG4gICAgICAgIH0pLmNhdGNoKCgpID0+IGxvZ2dlci5pbmZvKCdzdGFydGluZyByb3VuZCBzbGFjayBjYWxsIGZhaWxlZCwgbWVzc2FnZSB3YXMgJywgbWVzc2FnZSkpO1xuICAgICAgICByZXR1cm4gb3BlcmF0aW9uUmVzdWx0O1xuICAgIH1cbiAgICBlbHNlIHsgLy8gbG9vcCBpZiBhbGwgcm91bmRzIGFyZSBmaW5pc2hlZC5cbiAgICAgICAgbG9nZ2VyLmluZm8oJ0F0dGVtcHRlZCB0byBpbmNyZW1lbnQgcm91bmQgb24gZmluaXNoZWQgZXZlbnQuIExvb3Bpbmcgcm91bmRzLicpO1xuXG4gICAgICAgIGV2ZW50LlJvdW5kcy5mb3JFYWNoKHIgPT4gci5Jc0ZpbmlzaGVkID0gZmFsc2UpO1xuICAgICAgICBldmVudC5DdXJyZW50Um91bmQgPSBudWxsO1xuICAgICAgICBjb25zdCB1c2VyOiBVc2VyRG9jdW1lbnQgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHVzZXJJZCk7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgJHtldmVudC5OYW1lfSBpcyBmaW5pc2hlZCBidXQgcm91bmQgaXMgYmVpbmcgc3RhcnRlZCBieSAke3VzZXIgJiYgdXNlci5lbWFpbH1gO1xuICAgICAgICBldmVudC5Mb2dzLnB1c2goe1xuICAgICAgICAgICAgTWVzc2FnZTogbWVzc2FnZSxcbiAgICAgICAgICAgIENyZWF0ZWREYXRlOiBuZXcgRGF0ZSgpXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBldmVudC5zYXZlKCk7XG5cbiAgICAgICAgY29uc3Qgb3BlcmF0aW9uUmVzdWx0OiBEYXRhT3BlcmF0aW9uUmVzdWx0PEV2ZW50RFRPPiA9IHtcbiAgICAgICAgICAgIFN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICBEYXRhOiByZXN1bHRcbiAgICAgICAgfTtcbiAgICAgICAgLy8gQWZ0ZXIgc2VuZGluZyByZXNwb25zZSBzZW5kIG1lc3NhZ2UgdG8gc2xhY2sgY2hhbm5lbFxuICAgICAgICBwb3N0VG9TbGFjayh7XG4gICAgICAgICAgICAndGV4dCc6IG1lc3NhZ2VcbiAgICAgICAgfSkuY2F0Y2goKCkgPT4gbG9nZ2VyLmluZm8oJyBmaW5pc2ggZXZlbnQsIGF0dGVtcHQgdG8gaW5jcmVtZW50IHJvdW5kIGNhbGwgZmFpbGVkICcsIG1lc3NhZ2UpKTtcbiAgICAgICAgcmV0dXJuIG9wZXJhdGlvblJlc3VsdDtcbiAgICAgICAgLy8gbG9nZ2VyLmluZm8oJ0F0dGVtcHRlZCB0byBpbmNyZW1lbnQgcm91bmQgb24gZmluaXNoZWQgZXZlbnQuJyk7XG4gICAgICAgIC8vIGNvbnN0IG9wZXJhdGlvblJlc3VsdDogT3BlcmF0aW9uUmVzdWx0ID0ge1xuICAgICAgICAvLyAgICAgU3VjY2VzczogZmFsc2VcbiAgICAgICAgLy8gfTtcbiAgICAgICAgLy8gcmVzLmpzb24ob3BlcmF0aW9uUmVzdWx0KTtcbiAgICB9XG59Il19
