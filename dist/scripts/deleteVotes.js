"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bootstrap_1 = require("./bootstrap");
const VotingLog_1 = require("../models/VotingLog");
const Event_1 = require("../models/Event");
let mongoose;
bootstrap_1.default().then((obj) => {
    mongoose = obj.mongoose;
    return start();
}).then(() => {
    console.log('done');
    return mongoose.connection.close();
}).catch(e => {
    console.error(e);
    if (mongoose.connection) {
        return mongoose.connection.close();
    }
}).then(() => {
    console.log('closed db conn');
});
async function start() {
    return deleteVotes();
}
async function deleteVotes() {
    const event = await Event_1.default.findOne({
        _id: '5e861378f97603aaca9bdde4'
    });
    const query = { EventId: '5e861378f97603aaca9bdde4', Status: 'VOTE_ACCEPTED', createdAt: { $lte: '2020-04-03T01:04:37.715+00:00' } };
    const votingLogs = await VotingLog_1.default.find(query);
    const voterIds = {};
    for (let i = 0; i < votingLogs.length; i++) {
        const log = votingLogs[i];
        const key = `${log.RoundNumber}-${log.EaselNumber}`;
        if (!voterIds[key]) {
            voterIds[key] = [];
        }
        voterIds[key].push(log.Registration.toString());
    }
    let totalDeleteVoteCount = 0;
    let totalDeleteVoteDetailCount = 0;
    for (let i = 0; i < event.Rounds.length; i++) {
        const contestants = event.Rounds[i].Contestants;
        for (let j = 0; j < contestants.length; j++) {
            const contestant = contestants[j];
            const toKeepVotes = [];
            for (let k = 0; k < contestant.Votes.length; k++) {
                if (Array.isArray(voterIds[`${event.Rounds[i].RoundNumber}-${contestant.EaselNumber}`])
                    && voterIds[`${event.Rounds[i].RoundNumber}-${contestant.EaselNumber}`].indexOf(contestant.Votes[k].toString()) > -1) {
                    // DELETE
                    totalDeleteVoteCount++;
                }
                else {
                    toKeepVotes.push(contestant.Votes[k]);
                }
            }
            contestant.Votes = JSON.parse(JSON.stringify(toKeepVotes));
            const toKeepVoteDetails = [];
            for (let k = 0; k < contestant.VotesDetail.length; k++) {
                if (Array.isArray(voterIds[`${event.Rounds[i].RoundNumber}-${contestant.EaselNumber}`])
                    && voterIds[`${event.Rounds[i].RoundNumber}-${contestant.EaselNumber}`].indexOf(contestant.VotesDetail[k].RegistrationId.toString()) > -1) {
                    // DELETE
                    totalDeleteVoteDetailCount++;
                }
                else {
                    toKeepVoteDetails.push(contestant.VotesDetail[k]);
                }
            }
            contestant.VotesDetail = JSON.parse(JSON.stringify(toKeepVoteDetails));
        }
    }
    await event.save();
    await VotingLog_1.default.deleteMany(query);
    console.log('totalDeleteVoteCount', totalDeleteVoteCount);
    console.log('totalDeleteVoteDetailCount', totalDeleteVoteDetailCount);
    console.log('delete voting logs', votingLogs.length);
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtvQkFDM0ksU0FBUztvQkFDVCwwQkFBMEIsRUFBRyxDQUFDO2lCQUNqQztxQkFBTTtvQkFDSCxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNyRDthQUNKO1lBQ0QsVUFBVSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1NBQzFFO0tBQ0o7SUFDRCxNQUFNLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNuQixNQUFNLG1CQUFjLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztJQUMxRCxPQUFPLENBQUMsR0FBRyxDQUFDLDRCQUE0QixFQUFFLDBCQUEwQixDQUFDLENBQUM7SUFDdEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDekQsQ0FBQyIsImZpbGUiOiJzY3JpcHRzL2RlbGV0ZVZvdGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvYWRBcHAgZnJvbSAnLi9ib290c3RyYXAnO1xuaW1wb3J0IFZvdGluZ0xvZ01vZGVsIGZyb20gJy4uL21vZGVscy9Wb3RpbmdMb2cnO1xuaW1wb3J0IEV2ZW50TW9kZWwgZnJvbSAnLi4vbW9kZWxzL0V2ZW50JztcbmxldCBtb25nb29zZTogdHlwZW9mIGltcG9ydCgnbW9uZ29vc2UnKTtcbmxvYWRBcHAoKS50aGVuKChvYmopID0+IHtcbiAgICBtb25nb29zZSA9IG9iai5tb25nb29zZTtcbiAgICByZXR1cm4gc3RhcnQoKTtcbn0pLnRoZW4oKCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdkb25lJyk7XG4gICAgcmV0dXJuIG1vbmdvb3NlLmNvbm5lY3Rpb24uY2xvc2UoKTtcbn0pLmNhdGNoKGUgPT4ge1xuICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgaWYgKG1vbmdvb3NlLmNvbm5lY3Rpb24pIHtcbiAgICAgICAgcmV0dXJuIG1vbmdvb3NlLmNvbm5lY3Rpb24uY2xvc2UoKTtcbiAgICB9XG59KS50aGVuKCgpID0+IHtcbiAgICBjb25zb2xlLmxvZygnY2xvc2VkIGRiIGNvbm4nKTtcbn0pO1xuXG5cbmFzeW5jIGZ1bmN0aW9uIHN0YXJ0KCkge1xuICAgIHJldHVybiBkZWxldGVWb3RlcygpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZWxldGVWb3RlcygpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IGV2ZW50ID0gYXdhaXQgRXZlbnRNb2RlbC5maW5kT25lKHtcbiAgICAgICAgX2lkOiAnNWU4NjEzNzhmOTc2MDNhYWNhOWJkZGU0J1xuICAgIH0pO1xuICAgIGNvbnN0IHF1ZXJ5ID0ge0V2ZW50SWQ6ICc1ZTg2MTM3OGY5NzYwM2FhY2E5YmRkZTQnLCBTdGF0dXM6ICdWT1RFX0FDQ0VQVEVEJywgY3JlYXRlZEF0OiB7JGx0ZTogJzIwMjAtMDQtMDNUMDE6MDQ6MzcuNzE1KzAwOjAwJ319O1xuICAgIGNvbnN0IHZvdGluZ0xvZ3MgPSBhd2FpdCBWb3RpbmdMb2dNb2RlbC5maW5kKHF1ZXJ5KTtcbiAgICBjb25zdCB2b3Rlcklkczoge1trZXk6IHN0cmluZ106IHN0cmluZ1tdfSA9IHt9O1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdm90aW5nTG9ncy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBsb2cgPSB2b3RpbmdMb2dzW2ldO1xuICAgICAgICBjb25zdCBrZXkgPSBgJHtsb2cuUm91bmROdW1iZXJ9LSR7bG9nLkVhc2VsTnVtYmVyfWA7XG4gICAgICAgIGlmICghdm90ZXJJZHNba2V5XSkge1xuICAgICAgICAgICAgdm90ZXJJZHNba2V5XSA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIHZvdGVySWRzW2tleV0ucHVzaChsb2cuUmVnaXN0cmF0aW9uLnRvU3RyaW5nKCkpO1xuICAgIH1cbiAgICBsZXQgdG90YWxEZWxldGVWb3RlQ291bnQgPSAwO1xuICAgIGxldCB0b3RhbERlbGV0ZVZvdGVEZXRhaWxDb3VudCA9IDA7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgIDwgZXZlbnQuUm91bmRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGNvbnRlc3RhbnRzID0gZXZlbnQuUm91bmRzW2ldLkNvbnRlc3RhbnRzO1xuICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGNvbnRlc3RhbnRzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICBjb25zdCBjb250ZXN0YW50ID0gY29udGVzdGFudHNbal07XG4gICAgICAgICAgICBjb25zdCB0b0tlZXBWb3RlcyA9IFtdO1xuICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBjb250ZXN0YW50LlZvdGVzLmxlbmd0aDsgaysrKSB7XG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodm90ZXJJZHNbYCR7ZXZlbnQuUm91bmRzW2ldLlJvdW5kTnVtYmVyfS0ke2NvbnRlc3RhbnQuRWFzZWxOdW1iZXJ9YF0pXG4gICAgICAgICAgICAgICAgICAgICYmIHZvdGVySWRzW2Ake2V2ZW50LlJvdW5kc1tpXS5Sb3VuZE51bWJlcn0tJHtjb250ZXN0YW50LkVhc2VsTnVtYmVyfWBdLmluZGV4T2YoY29udGVzdGFudC5Wb3Rlc1trXS50b1N0cmluZygpKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIERFTEVURVxuICAgICAgICAgICAgICAgICAgICB0b3RhbERlbGV0ZVZvdGVDb3VudCArKztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0b0tlZXBWb3Rlcy5wdXNoKGNvbnRlc3RhbnQuVm90ZXNba10pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnRlc3RhbnQuVm90ZXMgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRvS2VlcFZvdGVzKSk7XG4gICAgICAgICAgICBjb25zdCB0b0tlZXBWb3RlRGV0YWlscyA9IFtdO1xuICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBjb250ZXN0YW50LlZvdGVzRGV0YWlsLmxlbmd0aDsgaysrKSB7XG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodm90ZXJJZHNbYCR7ZXZlbnQuUm91bmRzW2ldLlJvdW5kTnVtYmVyfS0ke2NvbnRlc3RhbnQuRWFzZWxOdW1iZXJ9YF0pXG4gICAgICAgICAgICAgICAgICAgICYmIHZvdGVySWRzW2Ake2V2ZW50LlJvdW5kc1tpXS5Sb3VuZE51bWJlcn0tJHtjb250ZXN0YW50LkVhc2VsTnVtYmVyfWBdLmluZGV4T2YoY29udGVzdGFudC5Wb3Rlc0RldGFpbFtrXS5SZWdpc3RyYXRpb25JZC50b1N0cmluZygpKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIERFTEVURVxuICAgICAgICAgICAgICAgICAgICB0b3RhbERlbGV0ZVZvdGVEZXRhaWxDb3VudCArKztcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0b0tlZXBWb3RlRGV0YWlscy5wdXNoKGNvbnRlc3RhbnQuVm90ZXNEZXRhaWxba10pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnRlc3RhbnQuVm90ZXNEZXRhaWwgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRvS2VlcFZvdGVEZXRhaWxzKSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgYXdhaXQgZXZlbnQuc2F2ZSgpO1xuICAgIGF3YWl0IFZvdGluZ0xvZ01vZGVsLmRlbGV0ZU1hbnkocXVlcnkpO1xuICAgIGNvbnNvbGUubG9nKCd0b3RhbERlbGV0ZVZvdGVDb3VudCcsIHRvdGFsRGVsZXRlVm90ZUNvdW50KTtcbiAgICBjb25zb2xlLmxvZygndG90YWxEZWxldGVWb3RlRGV0YWlsQ291bnQnLCB0b3RhbERlbGV0ZVZvdGVEZXRhaWxDb3VudCk7XG4gICAgY29uc29sZS5sb2coJ2RlbGV0ZSB2b3RpbmcgbG9ncycsIHZvdGluZ0xvZ3MubGVuZ3RoKTtcbn0iXX0=
