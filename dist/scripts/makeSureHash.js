"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const uniqid = require('uniqid');
const bootstrap_1 = require("./bootstrap");
const Event_1 = require("../models/Event");
const Contestant_1 = require("../models/Contestant");
const google_libphonenumber_1 = require("google-libphonenumber");
const phoneUtil = google_libphonenumber_1.PhoneNumberUtil.getInstance();
/* Forceful import */
console.log(typeof bootstrap_1.default, typeof Contestant_1.default);
/* Forceful import end */
const Registration_1 = require("../models/Registration");
const VotingLog_1 = require("../models/VotingLog");
const RegistrationLog_1 = require("../models/RegistrationLog");
async function start() {
    const registrations = await Registration_1.default.find({ 'Hash': undefined }).sort({ _id: -1 });
    for (let i = 0; i < registrations.length; i++) {
        await updateRegistration(registrations[i]);
    }
}
async function updateRegistration(doc) {
    const oldNumber = doc.PhoneNumber;
    if (doc.PhoneNumber && doc.PhoneNumber.length > 0
        && !doc.PhoneNumber.startsWith('+')) {
        doc.PhoneNumber = `+${oldNumber}`;
        console.log(doc.PhoneNumber);
        try {
            doc.RegionCode = phoneUtil.getRegionCodeForNumber((phoneUtil.parse(doc.PhoneNumber)));
        }
        catch (e) {
            console.error('Invalid number', doc.PhoneNumber);
            doc.RegionCode = 'US';
        }
        if (!doc.Hash) {
            doc.Hash = uniqid.time();
        }
        if (!doc.DisplayPhone) {
            doc.DisplayPhone = `*******${doc.PhoneNumber.slice(-4)}`;
        }
        console.log('Registration updated');
        await doc.save();
        await Promise.all([
            _modifyRegLog(oldNumber, doc),
            _modifyVotingLog(oldNumber, doc),
            _modifyEventRegistrationVoteFactor(oldNumber, doc)
        ]);
    }
}
async function _modifyRegLog(oldNumber, newDoc) {
    const result = await RegistrationLog_1.default.updateMany({
        PhoneNumber: oldNumber,
    }, {
        '$set': {
            PhoneNumber: newDoc.PhoneNumber,
            DisplayPhone: newDoc.DisplayPhone,
            PhoneNumberHash: newDoc.Hash
        }
    });
    console.log('Registration log updated', result);
}
async function _modifyVotingLog(oldNumber, newDoc) {
    const result = await VotingLog_1.default.updateMany({
        PhoneNumber: oldNumber,
    }, {
        '$set': {
            PhoneNumber: newDoc.PhoneNumber
        }
    });
    console.log('Voting log updated', result);
}
async function _modifyEventRegistrationVoteFactor(oldNumber, newDoc) {
    const events = await Event_1.default.find({ 'RegistrationsVoteFactor.RegistrationId': newDoc.id });
    console.log(events.length);
    for (let i = 0; i < events.length; i++) {
        for (let j = 0; j < events[i].RegistrationsVoteFactor.length; j++) {
            if (events[i].RegistrationsVoteFactor[j].RegistrationId === newDoc.id) {
                events[i].RegistrationsVoteFactor[j].PhoneNumber = newDoc.PhoneNumber;
                break;
            }
        }
        await events[i].save();
    }
    console.log('Matching events updated', events.length);
}
start().then(() => {
    console.log('streaming done');
    // process.exit(0);
}).catch(e => {
    console.error(e);
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QyxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDO2dCQUN0RSxNQUFNO2FBQ1Q7U0FDSjtRQUNELE1BQU0sTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0tBQzFCO0lBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDMUQsQ0FBQztBQUVELEtBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7SUFDZCxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDOUIsbUJBQW1CO0FBQ3ZCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtJQUNULE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckIsQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoic2NyaXB0cy9tYWtlU3VyZUhhc2guanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB1bmlxaWQgPSByZXF1aXJlKCd1bmlxaWQnKTtcclxuaW1wb3J0IG1vbmdvb3NlIGZyb20gJy4vYm9vdHN0cmFwJztcclxuaW1wb3J0IEV2ZW50TW9kZWwgZnJvbSAnLi4vbW9kZWxzL0V2ZW50JztcclxuaW1wb3J0IENvbnRlc3RhbnRNb2RlbCBmcm9tICcuLi9tb2RlbHMvQ29udGVzdGFudCc7XHJcblxyXG5pbXBvcnQgeyBQaG9uZU51bWJlclV0aWwgfSBmcm9tICdnb29nbGUtbGlicGhvbmVudW1iZXInO1xyXG5pbXBvcnQgUGhvbmVOdW1iZXIgPSBsaWJwaG9uZW51bWJlci5QaG9uZU51bWJlcjtcclxuY29uc3QgcGhvbmVVdGlsID0gUGhvbmVOdW1iZXJVdGlsLmdldEluc3RhbmNlKCk7XHJcblxyXG5cclxuLyogRm9yY2VmdWwgaW1wb3J0ICovXHJcbmNvbnNvbGUubG9nKHR5cGVvZiBtb25nb29zZSwgdHlwZW9mIENvbnRlc3RhbnRNb2RlbCk7XHJcbi8qIEZvcmNlZnVsIGltcG9ydCBlbmQgKi9cclxuXHJcbmltcG9ydCBSZWdpc3RyYXRpb25Nb2RlbCwgeyBSZWdpc3RyYXRpb25Eb2N1bWVudCB9IGZyb20gJy4uL21vZGVscy9SZWdpc3RyYXRpb24nO1xyXG5pbXBvcnQgVm90aW5nTG9nTW9kZWwgZnJvbSAnLi4vbW9kZWxzL1ZvdGluZ0xvZyc7XHJcbmltcG9ydCBSZWdpc3RyYXRpb25Mb2dNb2RlbCBmcm9tICcuLi9tb2RlbHMvUmVnaXN0cmF0aW9uTG9nJztcclxuXHJcblxyXG5hc3luYyBmdW5jdGlvbiBzdGFydCgpIHtcclxuICAgIGNvbnN0IHJlZ2lzdHJhdGlvbnMgPSBhd2FpdCBSZWdpc3RyYXRpb25Nb2RlbC5maW5kKHsnSGFzaCc6IHVuZGVmaW5lZH0pLnNvcnQoe19pZDogLTF9KTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpICA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBhd2FpdCB1cGRhdGVSZWdpc3RyYXRpb24ocmVnaXN0cmF0aW9uc1tpXSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVJlZ2lzdHJhdGlvbihkb2M6IFJlZ2lzdHJhdGlvbkRvY3VtZW50KSB7XHJcbiAgICBjb25zdCBvbGROdW1iZXIgPSBkb2MuUGhvbmVOdW1iZXI7XHJcbiAgICBpZiAoZG9jLlBob25lTnVtYmVyICYmIGRvYy5QaG9uZU51bWJlci5sZW5ndGggPiAwXHJcbiAgICAgICAgJiYgIWRvYy5QaG9uZU51bWJlci5zdGFydHNXaXRoKCcrJykpIHtcclxuICAgICAgIGRvYy5QaG9uZU51bWJlciA9IGArJHtvbGROdW1iZXJ9YDtcclxuICAgICAgIGNvbnNvbGUubG9nKGRvYy5QaG9uZU51bWJlcik7XHJcbiAgICAgICB0cnkge1xyXG4gICAgICAgICAgIGRvYy5SZWdpb25Db2RlID0gcGhvbmVVdGlsLmdldFJlZ2lvbkNvZGVGb3JOdW1iZXIoKHBob25lVXRpbC5wYXJzZShkb2MuUGhvbmVOdW1iZXIpKSk7XHJcbiAgICAgICB9XHJcbiAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ludmFsaWQgbnVtYmVyJywgZG9jLlBob25lTnVtYmVyKTtcclxuICAgICAgICAgICBkb2MuUmVnaW9uQ29kZSA9ICdVUyc7XHJcbiAgICAgICB9XHJcbiAgICAgICBpZiAoIWRvYy5IYXNoKSB7XHJcbiAgICAgICAgICAgZG9jLkhhc2ggPSB1bmlxaWQudGltZSgpO1xyXG4gICAgICAgfVxyXG4gICAgICAgaWYgKCFkb2MuRGlzcGxheVBob25lKSB7XHJcbiAgICAgICAgICAgZG9jLkRpc3BsYXlQaG9uZSA9IGAqKioqKioqJHtkb2MuUGhvbmVOdW1iZXIuc2xpY2UoLTQpfWA7XHJcbiAgICAgICB9XHJcbiAgICAgICBjb25zb2xlLmxvZygnUmVnaXN0cmF0aW9uIHVwZGF0ZWQnKTtcclxuICAgICAgIGF3YWl0IGRvYy5zYXZlKCk7XHJcbiAgICAgICBhd2FpdCBQcm9taXNlLmFsbChbXHJcbiAgICAgICAgICAgX21vZGlmeVJlZ0xvZyhvbGROdW1iZXIsIGRvYyksXHJcbiAgICAgICAgICAgX21vZGlmeVZvdGluZ0xvZyhvbGROdW1iZXIsIGRvYyksXHJcbiAgICAgICAgICAgX21vZGlmeUV2ZW50UmVnaXN0cmF0aW9uVm90ZUZhY3RvcihvbGROdW1iZXIsIGRvYylcclxuICAgICAgIF0pO1xyXG4gICAgfVxyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBfbW9kaWZ5UmVnTG9nKG9sZE51bWJlcjogc3RyaW5nLCBuZXdEb2M6IFJlZ2lzdHJhdGlvbkRvY3VtZW50KSB7XHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBSZWdpc3RyYXRpb25Mb2dNb2RlbC51cGRhdGVNYW55KHtcclxuICAgICAgICBQaG9uZU51bWJlcjogb2xkTnVtYmVyLFxyXG4gICAgfSwge1xyXG4gICAgICAgICckc2V0Jzoge1xyXG4gICAgICAgICAgICBQaG9uZU51bWJlcjogbmV3RG9jLlBob25lTnVtYmVyLFxyXG4gICAgICAgICAgICBEaXNwbGF5UGhvbmU6IG5ld0RvYy5EaXNwbGF5UGhvbmUsXHJcbiAgICAgICAgICAgIFBob25lTnVtYmVySGFzaDogbmV3RG9jLkhhc2hcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIGNvbnNvbGUubG9nKCdSZWdpc3RyYXRpb24gbG9nIHVwZGF0ZWQnLCByZXN1bHQpO1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBfbW9kaWZ5Vm90aW5nTG9nKG9sZE51bWJlcjogc3RyaW5nLCBuZXdEb2M6IFJlZ2lzdHJhdGlvbkRvY3VtZW50KSB7XHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBWb3RpbmdMb2dNb2RlbC51cGRhdGVNYW55KHtcclxuICAgICAgICBQaG9uZU51bWJlcjogb2xkTnVtYmVyLFxyXG4gICAgfSwge1xyXG4gICAgICAgICckc2V0Jzoge1xyXG4gICAgICAgICAgICBQaG9uZU51bWJlcjogbmV3RG9jLlBob25lTnVtYmVyXHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBjb25zb2xlLmxvZygnVm90aW5nIGxvZyB1cGRhdGVkJywgcmVzdWx0KTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gX21vZGlmeUV2ZW50UmVnaXN0cmF0aW9uVm90ZUZhY3RvcihvbGROdW1iZXI6IHN0cmluZywgbmV3RG9jOiBSZWdpc3RyYXRpb25Eb2N1bWVudCkge1xyXG4gICAgY29uc3QgZXZlbnRzID0gYXdhaXQgRXZlbnRNb2RlbC5maW5kKHsnUmVnaXN0cmF0aW9uc1ZvdGVGYWN0b3IuUmVnaXN0cmF0aW9uSWQnOiBuZXdEb2MuaWR9KTtcclxuICAgIGNvbnNvbGUubG9nKGV2ZW50cy5sZW5ndGgpO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGV2ZW50c1tpXS5SZWdpc3RyYXRpb25zVm90ZUZhY3Rvci5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnRzW2ldLlJlZ2lzdHJhdGlvbnNWb3RlRmFjdG9yW2pdLlJlZ2lzdHJhdGlvbklkID09PSBuZXdEb2MuaWQpIHtcclxuICAgICAgICAgICAgICAgIGV2ZW50c1tpXS5SZWdpc3RyYXRpb25zVm90ZUZhY3RvcltqXS5QaG9uZU51bWJlciA9IG5ld0RvYy5QaG9uZU51bWJlcjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGF3YWl0IGV2ZW50c1tpXS5zYXZlKCk7XHJcbiAgICB9XHJcbiAgICBjb25zb2xlLmxvZygnTWF0Y2hpbmcgZXZlbnRzIHVwZGF0ZWQnLCBldmVudHMubGVuZ3RoKTtcclxufVxyXG5cclxuc3RhcnQoKS50aGVuKCgpID0+IHtcclxuICAgIGNvbnNvbGUubG9nKCdzdHJlYW1pbmcgZG9uZScpO1xyXG4gICAgLy8gcHJvY2Vzcy5leGl0KDApO1xyXG59KS5jYXRjaChlID0+IHtcclxuICAgIGNvbnNvbGUuZXJyb3IoZSk7XHJcbn0pOyJdfQ==
