"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const uniqid = require('uniqid');
const bootstrap_1 = require("./bootstrap");
const Event_1 = require("../models/Event");
const Contestant_1 = require("../models/Contestant");
const google_libphonenumber_1 = require("google-libphonenumber");
const logger_1 = require("../config/logger");
const phoneUtil = google_libphonenumber_1.PhoneNumberUtil.getInstance();
/* Forceful import */
logger_1.default.info(typeof bootstrap_1.default, typeof Contestant_1.default);
/* Forceful import end */
const Registration_1 = require("../models/Registration");
const VotingLog_1 = require("../models/VotingLog");
const RegistrationLog_1 = require("../models/RegistrationLog");
async function start() {
    const registrations = await Registration_1.default.find();
    for (let i = 0; i < registrations.length; i++) {
        await updateRegistration(registrations[i]);
    }
}
async function updateRegistration(doc) {
    const oldNumber = doc.PhoneNumber;
    if (doc.PhoneNumber && doc.PhoneNumber.length > 0
        && !doc.PhoneNumber.startsWith('+')) {
        doc.PhoneNumber = `+${oldNumber}`;
        logger_1.default.info(doc.PhoneNumber);
        try {
            doc.RegionCode = phoneUtil.getRegionCodeForNumber((phoneUtil.parse(doc.PhoneNumber)));
        }
        catch (e) {
            logger_1.default.info('Invalid number', doc.PhoneNumber);
            doc.RegionCode = 'US';
        }
        if (!doc.Hash) {
            doc.Hash = uniqid.time();
        }
        if (!doc.DisplayPhone) {
            doc.DisplayPhone = `*******${doc.PhoneNumber.slice(-4)}`;
        }
        logger_1.default.info('Registration updated');
        await doc.save();
        await Promise.all([
            _modifyRegLog(oldNumber, doc),
            _modifyVotingLog(oldNumber, doc),
            _modifyEventRegistrationVoteFactor(oldNumber, doc)
        ]);
    }
}
async function _modifyRegLog(oldNumber, newDoc) {
    const result = await RegistrationLog_1.default.updateMany({
        PhoneNumber: oldNumber,
    }, {
        '$set': {
            PhoneNumber: newDoc.PhoneNumber,
            DisplayPhone: newDoc.DisplayPhone,
            PhoneNumberHash: newDoc.Hash
        }
    });
    logger_1.default.info('Registration log updated', result);
}
async function _modifyVotingLog(oldNumber, newDoc) {
    const result = await VotingLog_1.default.updateMany({
        PhoneNumber: oldNumber,
    }, {
        '$set': {
            PhoneNumber: newDoc.PhoneNumber
        }
    });
    logger_1.default.info('Voting log updated', result);
}
async function _modifyEventRegistrationVoteFactor(oldNumber, newDoc) {
    const events = await Event_1.default.find({ 'RegistrationsVoteFactor.RegistrationId': newDoc.id });
    logger_1.default.info('events.length', events.length);
    for (let i = 0; i < events.length; i++) {
        for (let j = 0; j < events[i].RegistrationsVoteFactor.length; j++) {
            if (events[i].RegistrationsVoteFactor[j].RegistrationId === newDoc.id) {
                events[i].RegistrationsVoteFactor[j].PhoneNumber = newDoc.PhoneNumber;
                events[i].RegistrationsVoteFactor[j].Hash = newDoc.Hash;
                break;
            }
        }
        await events[i].save();
    }
    logger_1.default.info('Matching events updated', events.length);
}
start().then(() => {
    logger_1.default.info('streaming done');
    // process.exit(0);
}).catch(e => {
    logger_1.default.info(e);
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNjcmlwdHMvbWlncmF0ZVRvSW50ZXJuYXRpb25hbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNqQywyQ0FBbUM7QUFDbkMsMkNBQXlDO0FBQ3pDLHFEQUFtRDtBQUVuRCxpRUFBd0Q7QUFFeEQsNkNBQXNDO0FBRXRDLE1BQU0sU0FBUyxHQUFHLHVDQUFlLENBQUMsV0FBVyxFQUFFLENBQUM7QUFHaEQscUJBQXFCO0FBQ3JCLGdCQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sbUJBQVEsRUFBRSxPQUFPLG9CQUFlLENBQUMsQ0FBQztBQUNyRCx5QkFBeUI7QUFFekIseURBQWlGO0FBQ2pGLG1EQUFpRDtBQUNqRCwrREFBNkQ7QUFHN0QsS0FBSyxVQUFVLEtBQUs7SUFDaEIsTUFBTSxhQUFhLEdBQUcsTUFBTSxzQkFBaUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNyRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUksYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUM1QyxNQUFNLGtCQUFrQixDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzlDO0FBQ0wsQ0FBQztBQUVELEtBQUssVUFBVSxrQkFBa0IsQ0FBQyxHQUF5QjtJQUN2RCxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsV0FBVyxDQUFDO0lBQ2xDLElBQUksR0FBRyxDQUFDLFdBQVcsSUFBSSxHQUFHLENBQUMsV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDO1dBQzFDLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDdEMsR0FBRyxDQUFDLFdBQVcsR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBQ2xDLGdCQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM3QixJQUFJ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LENBQUMsQ0FBQyxDQUFDLFdBQVcsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDO2dCQUN0RSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7Z0JBQ3hELE1BQU07YUFDVDtTQUNKO1FBQ0QsTUFBTSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7S0FDMUI7SUFDRCxnQkFBTSxDQUFDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDMUQsQ0FBQztBQUVELEtBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7SUFDZCxnQkFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQzlCLG1CQUFtQjtBQUN2QixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7SUFDVCxnQkFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuQixDQUFDLENBQUMsQ0FBQyIsImZpbGUiOiJzY3JpcHRzL21pZ3JhdGVUb0ludGVybmF0aW9uYWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB1bmlxaWQgPSByZXF1aXJlKCd1bmlxaWQnKTtcbmltcG9ydCBtb25nb29zZSBmcm9tICcuL2Jvb3RzdHJhcCc7XG5pbXBvcnQgRXZlbnRNb2RlbCBmcm9tICcuLi9tb2RlbHMvRXZlbnQnO1xuaW1wb3J0IENvbnRlc3RhbnRNb2RlbCBmcm9tICcuLi9tb2RlbHMvQ29udGVzdGFudCc7XG5cbmltcG9ydCB7IFBob25lTnVtYmVyVXRpbCB9IGZyb20gJ2dvb2dsZS1saWJwaG9uZW51bWJlcic7XG5pbXBvcnQgUGhvbmVOdW1iZXIgPSBsaWJwaG9uZW51bWJlci5QaG9uZU51bWJlcjtcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vY29uZmlnL2xvZ2dlcic7XG5cbmNvbnN0IHBob25lVXRpbCA9IFBob25lTnVtYmVyVXRpbC5nZXRJbnN0YW5jZSgpO1xuXG5cbi8qIEZvcmNlZnVsIGltcG9ydCAqL1xubG9nZ2VyLmluZm8odHlwZW9mIG1vbmdvb3NlLCB0eXBlb2YgQ29udGVzdGFudE1vZGVsKTtcbi8qIEZvcmNlZnVsIGltcG9ydCBlbmQgKi9cblxuaW1wb3J0IFJlZ2lzdHJhdGlvbk1vZGVsLCB7IFJlZ2lzdHJhdGlvbkRvY3VtZW50IH0gZnJvbSAnLi4vbW9kZWxzL1JlZ2lzdHJhdGlvbic7XG5pbXBvcnQgVm90aW5nTG9nTW9kZWwgZnJvbSAnLi4vbW9kZWxzL1ZvdGluZ0xvZyc7XG5pbXBvcnQgUmVnaXN0cmF0aW9uTG9nTW9kZWwgZnJvbSAnLi4vbW9kZWxzL1JlZ2lzdHJhdGlvbkxvZyc7XG5cblxuYXN5bmMgZnVuY3Rpb24gc3RhcnQoKSB7XG4gICAgY29uc3QgcmVnaXN0cmF0aW9ucyA9IGF3YWl0IFJlZ2lzdHJhdGlvbk1vZGVsLmZpbmQoKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSAgPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGF3YWl0IHVwZGF0ZVJlZ2lzdHJhdGlvbihyZWdpc3RyYXRpb25zW2ldKTtcbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVJlZ2lzdHJhdGlvbihkb2M6IFJlZ2lzdHJhdGlvbkRvY3VtZW50KSB7XG4gICAgY29uc3Qgb2xkTnVtYmVyID0gZG9jLlBob25lTnVtYmVyO1xuICAgIGlmIChkb2MuUGhvbmVOdW1iZXIgJiYgZG9jLlBob25lTnVtYmVyLmxlbmd0aCA+IDBcbiAgICAgICAgJiYgIWRvYy5QaG9uZU51bWJlci5zdGFydHNXaXRoKCcrJykpIHtcbiAgICAgICBkb2MuUGhvbmVOdW1iZXIgPSBgKyR7b2xkTnVtYmVyfWA7XG4gICAgICAgbG9nZ2VyLmluZm8oZG9jLlBob25lTnVtYmVyKTtcbiAgICAgICB0cnkge1xuICAgICAgICAgICBkb2MuUmVnaW9uQ29kZSA9IHBob25lVXRpbC5nZXRSZWdpb25Db2RlRm9yTnVtYmVyKChwaG9uZVV0aWwucGFyc2UoZG9jLlBob25lTnVtYmVyKSkpO1xuICAgICAgIH1cbiAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICBsb2dnZXIuaW5mbygnSW52YWxpZCBudW1iZXInLCBkb2MuUGhvbmVOdW1iZXIpO1xuICAgICAgICAgICBkb2MuUmVnaW9uQ29kZSA9ICdVUyc7XG4gICAgICAgfVxuICAgICAgIGlmICghZG9jLkhhc2gpIHtcbiAgICAgICAgICAgZG9jLkhhc2ggPSB1bmlxaWQudGltZSgpO1xuICAgICAgIH1cbiAgICAgICBpZiAoIWRvYy5EaXNwbGF5UGhvbmUpIHtcbiAgICAgICAgICAgZG9jLkRpc3BsYXlQaG9uZSA9IGAqKioqKioqJHtkb2MuUGhvbmVOdW1iZXIuc2xpY2UoLTQpfWA7XG4gICAgICAgfVxuICAgICAgIGxvZ2dlci5pbmZvKCdSZWdpc3RyYXRpb24gdXBkYXRlZCcpO1xuICAgICAgIGF3YWl0IGRvYy5zYXZlKCk7XG4gICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICBfbW9kaWZ5UmVnTG9nKG9sZE51bWJlciwgZG9jKSxcbiAgICAgICAgICAgX21vZGlmeVZvdGluZ0xvZyhvbGROdW1iZXIsIGRvYyksXG4gICAgICAgICAgIF9tb2RpZnlFdmVudFJlZ2lzdHJhdGlvblZvdGVGYWN0b3Iob2xkTnVtYmVyLCBkb2MpXG4gICAgICAgXSk7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBfbW9kaWZ5UmVnTG9nKG9sZE51bWJlcjogc3RyaW5nLCBuZXdEb2M6IFJlZ2lzdHJhdGlvbkRvY3VtZW50KSB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgUmVnaXN0cmF0aW9uTG9nTW9kZWwudXBkYXRlTWFueSh7XG4gICAgICAgIFBob25lTnVtYmVyOiBvbGROdW1iZXIsXG4gICAgfSwge1xuICAgICAgICAnJHNldCc6IHtcbiAgICAgICAgICAgIFBob25lTnVtYmVyOiBuZXdEb2MuUGhvbmVOdW1iZXIsXG4gICAgICAgICAgICBEaXNwbGF5UGhvbmU6IG5ld0RvYy5EaXNwbGF5UGhvbmUsXG4gICAgICAgICAgICBQaG9uZU51bWJlckhhc2g6IG5ld0RvYy5IYXNoXG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBsb2dnZXIuaW5mbygnUmVnaXN0cmF0aW9uIGxvZyB1cGRhdGVkJywgcmVzdWx0KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gX21vZGlmeVZvdGluZ0xvZyhvbGROdW1iZXI6IHN0cmluZywgbmV3RG9jOiBSZWdpc3RyYXRpb25Eb2N1bWVudCkge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFZvdGluZ0xvZ01vZGVsLnVwZGF0ZU1hbnkoe1xuICAgICAgICBQaG9uZU51bWJlcjogb2xkTnVtYmVyLFxuICAgIH0sIHtcbiAgICAgICAgJyRzZXQnOiB7XG4gICAgICAgICAgICBQaG9uZU51bWJlcjogbmV3RG9jLlBob25lTnVtYmVyXG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBsb2dnZXIuaW5mbygnVm90aW5nIGxvZyB1cGRhdGVkJywgcmVzdWx0KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gX21vZGlmeUV2ZW50UmVnaXN0cmF0aW9uVm90ZUZhY3RvcihvbGROdW1iZXI6IHN0cmluZywgbmV3RG9jOiBSZWdpc3RyYXRpb25Eb2N1bWVudCkge1xuICAgIGNvbnN0IGV2ZW50cyA9IGF3YWl0IEV2ZW50TW9kZWwuZmluZCh7J1JlZ2lzdHJhdGlvbnNWb3RlRmFjdG9yLlJlZ2lzdHJhdGlvbklkJzogbmV3RG9jLmlkfSk7XG4gICAgbG9nZ2VyLmluZm8oJ2V2ZW50cy5sZW5ndGgnLCBldmVudHMubGVuZ3RoKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGV2ZW50c1tpXS5SZWdpc3RyYXRpb25zVm90ZUZhY3Rvci5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgaWYgKGV2ZW50c1tpXS5SZWdpc3RyYXRpb25zVm90ZUZhY3RvcltqXS5SZWdpc3RyYXRpb25JZCA9PT0gbmV3RG9jLmlkKSB7XG4gICAgICAgICAgICAgICAgZXZlbnRzW2ldLlJlZ2lzdHJhdGlvbnNWb3RlRmFjdG9yW2pdLlBob25lTnVtYmVyID0gbmV3RG9jLlBob25lTnVtYmVyO1xuICAgICAgICAgICAgICAgIGV2ZW50c1tpXS5SZWdpc3RyYXRpb25zVm90ZUZhY3RvcltqXS5IYXNoID0gbmV3RG9jLkhhc2g7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgZXZlbnRzW2ldLnNhdmUoKTtcbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oJ01hdGNoaW5nIGV2ZW50cyB1cGRhdGVkJywgZXZlbnRzLmxlbmd0aCk7XG59XG5cbnN0YXJ0KCkudGhlbigoKSA9PiB7XG4gICAgbG9nZ2VyLmluZm8oJ3N0cmVhbWluZyBkb25lJyk7XG4gICAgLy8gcHJvY2Vzcy5leGl0KDApO1xufSkuY2F0Y2goZSA9PiB7XG4gICAgbG9nZ2VyLmluZm8oZSk7XG59KTsiXX0=
